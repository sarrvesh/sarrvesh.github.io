

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Practical examples &mdash; LOFAR Imaging Cookbook 22.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="LOFAR Imaging Cookbook 22.0.0 documentation" href="index.html"/>
        <link rel="next" title="Changelog" href="changelog.html"/>
        <link rel="prev" title="The AW Imager" href="awimager.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> LOFAR Imaging Cookbook
          

          
          </a>

          
            
            
              <div class="version">
                22.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Introduction to computing facilities at ASTRON </a></li>
<li class="toctree-l1"><a class="reference internal" href="datainspection.html">Data inspection </a></li>
<li class="toctree-l1"><a class="reference internal" href="aoflagger.html">AOFlagger </a></li>
<li class="toctree-l1"><a class="reference internal" href="dppp.html">The Default Pre-Processing Pipeline (DPPP) </a></li>
<li class="toctree-l1"><a class="reference internal" href="dpppcalibrate.html">Gain calibration with DPPP </a></li>
<li class="toctree-l1"><a class="reference internal" href="losoto.html">LoSoTo: LOFAR Solution Tool </a></li>
<li class="toctree-l1"><a class="reference internal" href="wsclean.html">The WSClean Imager </a></li>
<li class="toctree-l1"><a class="reference internal" href="sourcedetection.html">Source detection and sky model manipulation: PyBDSF and LSMTool </a></li>
<li class="toctree-l1"><a class="reference internal" href="factor.html">Factor: Facet Calibration for LOFAR </a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Useful resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="bbs.html">Calibration with BBS </a></li>
<li class="toctree-l1"><a class="reference internal" href="shapelets.html">Sky Model Construction Using Shapelets </a></li>
<li class="toctree-l1"><a class="reference internal" href="sagecal.html">SAGECAL </a></li>
<li class="toctree-l1"><a class="reference internal" href="awimager.html">The AW Imager </a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Practical examples </a><ul>
<li class="toctree-l2"><a class="reference internal" href="#flagging-averaging-and-demixing">Flagging, averaging, and demixing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calibration">Calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#imaging">Imaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#c295-a-bright-source-at-the-centre-of-the-field">3C295 – A bright source at the centre of the field</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hba">HBA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#inspecting-the-raw-data">Inspecting the raw data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flagging-and-data-compression">Flagging and data compression</a></li>
<li class="toctree-l4"><a class="reference internal" href="#post-compression-data-inspection-and-flagging">Post-compression data inspection and flagging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#calibration-with-dppp">Calibration with DPPP</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LOFAR Imaging Cookbook</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Practical examples </li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="practical-examples">
<h1>Practical examples <a class="footnote-reference" href="#f1" id="id1">[1]</a><a class="headerlink" href="#practical-examples" title="Permalink to this headline">¶</a></h1>
<p>In this Chapter, examples of how to inspect and analyse LOFAR data are given. The aim of these exercises is for the User to become familiar with the software used to process LOFAR data and to be able to apply this knowledge to other data sets. Please note that each LOFAR data set is different and special care should be taken when directly applying the methods given in these exercises to other LOFAR data sets.</p>
<p>It is assumed that the user is working on the CEP3 cluster and is familiar with the working environment.</p>
<p>The tutorial data can be staged and downloaded from the LOFAR <a class="reference external" href="http://lta.lofar.eu">Long Term Archive</a>. Using the project link on top of the page, select “other projects” in the list of links which will appear, and click on the “LOFARSCHOOL” link in the list of projects. Then, click on the “Show Latest” link at the top of the page, and on “All observations and pipelines”.</p>
<p>Selecting the checkbox in each row and clicking on the “stage selected” link will stage the data and you will get an email with the download instructions. This assumes that you have an user account registered. More info on how to use the LTA interface can be found on the <a class="reference external" href="http://www.lofar.org/wiki/doku.php?id=public:lta_howto">LOFAR wiki</a>.</p>
<p>Sky models and parset files used in the tutorial can be found at the LOFAR <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Cookbook/tree/master/Tutorial">GitHub repository</a>.</p>
<div class="section" id="flagging-averaging-and-demixing">
<h2>Flagging, averaging, and demixing<a class="headerlink" href="#flagging-averaging-and-demixing" title="Permalink to this headline">¶</a></h2>
<p>The naming convention for each measurement set (MS, also referred to as a sub-band) is
Laaaaaa_SAPbbb_SBccc_uv.MS, where Laaaaaa is the observation/pipeline ID, SAPbbb is the sub-array pointing (beam), andSBccc is the sub-band number. We can, for example, obtain a summary of a measurement set using msoverview; for more detailed report, we use the “verbose” argument to the command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msoverview</span> <span class="ow">in</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span> <span class="n">verbose</span><span class="o">=</span><span class="n">T</span>
</pre></div>
</div>
<p>Along with the details of the MS, we get a message: “This is a raw LOFAR MS (stored with LofarStMan)”, which means that the data cannot be handled with Casa. To fix this, we can use the following DPPP parset:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span>
<span class="n">msout</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv_copy</span><span class="o">.</span><span class="n">MS</span>
<span class="n">msin</span><span class="o">.</span><span class="n">autoweight</span><span class="o">=</span><span class="kc">True</span>
<span class="n">numthreads</span><span class="o">=</span><span class="mi">4</span> <span class="c1"># so that the nodes are not overloaded, usually can skip this line</span>
<span class="n">steps</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
</pre></div>
</div>
<p>after execution, the output MS can be opened using the standard CASA tools. Moreover, proper weighting of the data has been implemented.</p>
<p>The data can be inspected using casaplotms <a class="footnote-reference" href="#f2" id="id2">[2]</a> as</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">casa</span>
<span class="n">casaplotms</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>Open the measurement set from the GUI. Plot the XX correlation only by using the ‘corr’ argument (to speed things up). Select only cross correlations by typing “<em>&amp;</em>” in the ‘antenna’ field (note: * - any antenna; &amp; - cross correlations). There are many large spikes, likely caused by RFI. Click on the ‘Axes’ tab and adjust the y-axis range to something more sensible to find the real astronomical signal (<a class="reference internal" href="#inspectcasaplotms"><span class="std std-numref">Fig. 53</span></a>).</p>
<div class="figure align-center" id="id3">
<span id="inspectcasaplotms"></span><img alt="_images/tutolial_inspect_flag.png" src="_images/tutolial_inspect_flag.png" />
<p class="caption"><span class="caption-number">Fig. 53 </span><span class="caption-text">Inspecting the visibilities in casaplotms.</span></p>
</div>
<p>We can also further visualize the impact of RFI in the measurement set using rfigui.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">rfigui</span> <span class="n">L456104_SAP000_SB001_uv_copy</span><span class="o">.</span><span class="n">MS</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>In the smaller menu that pops up, just choose “Open”. Then, in the new window, select index 0 (default) for antenna 1, and index 1 for antenna 2, before clicking on “Load”. This will plot the short intra-station baseline CS001HBA0 - CS001HBA1. There is some clear narrow-band RFI. You can create a power spectrum (using “Plot”). rfigui can flag the data using AOFlagger: “Actions”, then “Execute Strategy”. There are other useful plots in the plot menu.</p>
<p>The AOFlagger can be called with DPPP. Create and run this parset (you can pipe the output to a log file, e.g. <strong>DPPP your.parset | tee DPPP.log</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv_copy</span><span class="o">.</span><span class="n">MS</span>
<span class="n">msout</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv_copy_flg</span><span class="o">.</span><span class="n">MS</span>
<span class="n">numthreads</span><span class="o">=</span><span class="mi">4</span>
<span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">preflagger</span><span class="p">,</span><span class="n">aoflagger</span><span class="p">]</span>
<span class="n">preflagger</span><span class="o">.</span><span class="n">baseline</span><span class="o">=*&amp;&amp;&amp;</span><span class="p">;</span><span class="n">RS208HBA</span><span class="p">;</span><span class="n">RS210HBA</span><span class="p">;</span><span class="n">RS310HBA</span><span class="p">;</span><span class="n">RS406HBA</span><span class="p">;</span><span class="n">RS407HBA</span><span class="p">;</span><span class="n">RS409HBA</span><span class="p">;</span>
<span class="n">RS508HBA</span><span class="p">;</span><span class="n">RS509HBA</span><span class="p">;</span><span class="n">RS205HBA</span><span class="o">&amp;</span><span class="n">RS307HBA</span> <span class="c1"># all these stations on one line</span>
</pre></div>
</div>
<p>An explanation of the “preflagger” step is as follows. The first argument (arguments separated by semi-colons) removes the autocorrelations (although note that AOFlagger also does this by default). For the next eight arguments, we remove all baselines including the stated remote station as well as one particular baseline between two remote stations (identified as bad data which can affect the calibration). The default AOFlagger strategy is run, but many options can be specified in DPPP (see the LOFAR wiki). We can re-examine the data with casaplotms and see that the RFI has been removed.</p>
<p>The observation we are working on is close to two “A-team” sources: about 16 deg from Cyg A, and 21 deg from Cas A. We need to check if their influence should be “demixed” from the recorded visibilities. Firstly, let’s check their elevations during the observation:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">plot_Ateam_elevation</span><span class="o">.</span><span class="n">py</span> <span class="n">L456104_SAP000_SB001_uv_copy_flg</span><span class="o">.</span><span class="n">MS</span>
</pre></div>
</div>
<p>We can predict the associated visibilities through simulations. Or, we will run a tool called the Drawer, allowing one to quickly inspect a measurement set and investigate which sources are contributing to the visibilities.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">tasse</span><span class="o">/</span><span class="n">drawMS</span><span class="o">/</span><span class="n">drawMS</span> <span class="o">--</span><span class="n">ms</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv_copy_demix_demo</span><span class="o">.</span><span class="n">MS</span>
</pre></div>
</div>
<p>Note that we are running the Drawer on pre-prepared averaged data (to save time); we will learn how to do averaging shortly. Examine the Drawer output. One can see contributions from Cas A and Cyg A. We need to demix their influence from the data.</p>
<p>We need a model of the A-team sources:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">showsourcedb</span> <span class="ow">in</span><span class="o">=</span><span class="n">Ateam</span><span class="o">.</span><span class="n">sourcedb</span> <span class="n">mode</span><span class="o">=</span><span class="n">patch</span> <span class="c1"># verify database contents</span>
</pre></div>
</div>
<p>Use the following parset for DPPP:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv_copy_flg</span><span class="o">.</span><span class="n">MS</span>
<span class="n">msout</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv_copy_flg_demix_avg</span><span class="o">.</span><span class="n">MS</span>
<span class="n">numthreads</span><span class="o">=</span><span class="mi">4</span>
<span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">demix</span><span class="p">]</span>
<span class="n">demix</span><span class="o">.</span><span class="n">subtractsources</span><span class="o">=</span><span class="p">[</span><span class="n">CasA</span><span class="p">,</span><span class="n">CygA</span><span class="p">]</span>
<span class="n">demix</span><span class="o">.</span><span class="n">skymodel</span><span class="o">=</span><span class="n">Ateam</span><span class="o">.</span><span class="n">sourcedb</span>
<span class="n">demix</span><span class="o">.</span><span class="n">timestep</span><span class="o">=</span><span class="mi">10</span>
<span class="n">demix</span><span class="o">.</span><span class="n">freqstep</span><span class="o">=</span><span class="mi">16</span>
<span class="n">demix</span><span class="o">.</span><span class="n">demixtimestep</span><span class="o">=</span><span class="mi">60</span>
<span class="n">demix</span><span class="o">.</span><span class="n">demixfreqstep</span><span class="o">=</span><span class="mi">64</span>
</pre></div>
</div>
<p>The arguments “timestep” and “freqstep” compress the data in time and frequency, respectively, by the given factors. Demixing two sources at once can be very time consuming. Thus, “demixtimestep” and “demixfreqstep” have been chosen to have rather coarse values (usually default to “timestep” and “freqstep” without needing to be specified).</p>
<p>We can draw the demixed data to see the result:</p>
<img alt="_images/tut_demix_pre.png" class="align-center" src="_images/tut_demix_pre.png" />
<div class="figure align-center" id="id4">
<img alt="_images/tut_demix_post.png" src="_images/tut_demix_post.png" />
<p class="caption"><span class="caption-number">Fig. 54 </span><span class="caption-text">A Drawer plot of the data before and after demixing.</span></p>
</div>
<p>What if demixing is not needed? We can also just average in time and frequency. Here is an example parset that could be run through DPPP:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv_copy_flg</span><span class="o">.</span><span class="n">MS</span>
<span class="n">msout</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv_copy_flg_avg</span><span class="o">.</span><span class="n">MS</span>
<span class="n">numthreads</span><span class="o">=</span><span class="mi">4</span>
<span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">averager</span><span class="p">]</span>
<span class="n">averager</span><span class="o">.</span><span class="n">timestep</span><span class="o">=</span><span class="mi">10</span>
<span class="n">averager</span><span class="o">.</span><span class="n">freqstep</span><span class="o">=</span><span class="mi">16</span>
</pre></div>
</div>
<p>DPPP was designed to run pipelines containing multiple steps. The following parset combines all the steps run so far in this tutorial, except demixing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span>
<span class="n">msin</span><span class="o">.</span><span class="n">autoweight</span><span class="o">=</span><span class="n">true</span>
<span class="n">msout</span><span class="o">=</span><span class="n">L456104_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">dppp</span>
<span class="n">numthreads</span><span class="o">=</span><span class="mi">4</span>
<span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">preflagger</span><span class="p">,</span><span class="n">aoflagger</span><span class="p">,</span><span class="n">averager</span><span class="p">]</span>
<span class="n">preflagger</span><span class="o">.</span><span class="n">baseline</span><span class="o">=*&amp;&amp;&amp;</span><span class="p">;</span><span class="n">RS208HBA</span><span class="p">;</span><span class="n">RS210HBA</span><span class="p">;</span><span class="n">RS310HBA</span><span class="p">;</span><span class="n">RS406HBA</span><span class="p">;</span><span class="n">RS407HBA</span><span class="p">;</span><span class="n">RS409HBA</span><span class="p">;</span>
<span class="n">RS508HBA</span><span class="p">;</span><span class="n">RS509HBA</span><span class="p">;</span><span class="n">RS205HBA</span><span class="o">&amp;</span><span class="n">RS307HBA</span>
<span class="n">averager</span><span class="o">.</span><span class="n">timestep</span><span class="o">=</span><span class="mi">10</span>
<span class="n">averager</span><span class="o">.</span><span class="n">freqstep</span><span class="o">=</span><span class="mi">16</span>
</pre></div>
</div>
</div>
<div class="section" id="calibration">
<h2>Calibration<a class="headerlink" href="#calibration" title="Permalink to this headline">¶</a></h2>
<p>You will need to stage and download the calibrator data from the LOFAR LTA with the Observation ID (SAS ID): 456102. Place these in a folder named “calibrator”. The target data can be staged and downloaded in the same manner. Their observation ID is: 456106. Place the target data in a folder named “target”. You can inspect them and if needed, flag outliers in a manner analogous to the procedure given in the previous sub-section. You do not need to process the complete target data set. For example, a subset of 5 SBs can be selected for calibration.</p>
<p>Take the <strong>A-Team_lowres.skymodel</strong> file, place it in the top directory, and run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">Lofar</span>
<span class="n">makesourcedb</span> <span class="ow">in</span><span class="o">=</span><span class="n">A</span><span class="o">-</span><span class="n">Team_lowres</span><span class="o">.</span><span class="n">skymodel</span> <span class="n">out</span><span class="o">=</span><span class="n">A</span><span class="o">-</span><span class="n">Team_lowres</span><span class="o">.</span><span class="n">sourcedb</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;&lt;&quot;</span>
</pre></div>
</div>
<p>to create a sky-model in <strong>sourcedb</strong> format.</p>
<p>Move to the calibrator folder, copy the model there and create a <strong>predict_model.parset</strong> file with the contents:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span> <span class="o">=</span>
<span class="n">msin</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">DATA</span>
<span class="n">msin</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="p">[</span><span class="n">CR</span><span class="p">]</span><span class="n">S</span><span class="o">*&amp;</span>
<span class="n">msout</span> <span class="o">=</span> <span class="o">.</span>
<span class="n">msout</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">MODEL_DATA</span>
<span class="n">numthreads</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">predict</span><span class="p">]</span>
<span class="n">predict</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">predict</span>
<span class="n">predict</span><span class="o">.</span><span class="n">sourcedb</span><span class="o">=</span><span class="n">A</span><span class="o">-</span><span class="n">Team_lowres</span><span class="o">.</span><span class="n">sourcedb</span>
<span class="n">predict</span><span class="o">.</span><span class="n">sources</span><span class="o">=</span><span class="n">CygA</span>
<span class="n">predict</span><span class="o">.</span><span class="n">usebeammodel</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
<p>Predict the model data for all of the calibrator sub-bands by executing the following bash script:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>for i in *MS; do NDPPP predict_model.parset msin=$i msout=$i; done
</pre></div>
</div>
<p>Create the parset we will use for calibration, <strong>gaincal.parset</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span><span class="o">=</span>
<span class="n">msout</span><span class="o">=.</span>
<span class="n">msin</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">DATA</span>
<span class="n">msin</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="p">[</span><span class="n">CR</span><span class="p">]</span><span class="n">S</span><span class="o">*&amp;</span>
<span class="n">msout</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">CORRECTED_DATA</span>
<span class="n">numthreads</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">gaincal</span><span class="p">]</span>
<span class="c1">#gaincal.sourcedb=A-Team_lowres.sourcedb</span>
<span class="c1">#gaincal.sources = CygA</span>
<span class="c1">#gaincal.usebeammodel=true</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">usemodelcolumn</span><span class="o">=</span><span class="n">true</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">parmdb</span><span class="o">=</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">gaincal</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">caltype</span><span class="o">=</span><span class="n">diagonal</span>
</pre></div>
</div>
<p>and run DPPP for all the calibrator sub-bands</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>for i in *MS.flg; do NDPPP gaincal.parset msin=$i gaincal.parmdb=$i/instrument msout=$i; done
</pre></div>
</div>
<p>Collect the solutions for all the sub-bands together using:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>#!/bin/bash
# To copy the instrument tables in a globaldb
mkdir globaldb
i=0
for ms in `ls -d *MS`; do
echo &quot;Copying ${ms}/instrument&quot;
cd $ms
# copy other tables
if [ $i == 0 ]; then
cp -r ANTENNA ../globaldb
cp -r FIELD ../globaldb
cp -r sky ../globaldb
fi
cp -r instrument ../globaldb/instrument-$i
cd ..
i=$((i + 1))
done
</pre></div>
</div>
<p>Then, transform the global solutions into <strong>.h5</strong> format (suitable for LoSoTo):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">losoto</span>
<span class="n">H5parm_importer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">cal</span><span class="o">.</span><span class="n">h5</span> <span class="n">globaldb</span>
</pre></div>
</div>
<p>Plot, flag and merge the solutions:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">losoto</span> <span class="o">-</span><span class="n">v</span> <span class="n">cal</span><span class="o">.</span><span class="n">h5</span> <span class="n">losoto</span><span class="o">.</span><span class="n">parset</span>
</pre></div>
</div>
<p>using the LoSoTo parset:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#losoto parset</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">plotP1</span><span class="p">,</span> <span class="n">plotP2</span><span class="p">,</span> <span class="n">plotP3</span><span class="p">,</span> <span class="n">plotA1</span><span class="p">,</span> <span class="n">plotA2</span><span class="p">,</span> <span class="n">plotA3</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">flagextend</span><span class="p">,</span> <span class="n">merge</span><span class="p">]</span>
</pre></div>
</div>
<p>Then, export the merged solutions:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">H5parm_exporter</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">cal</span><span class="o">.</span><span class="n">h5</span> <span class="n">globaldb</span>
</pre></div>
</div>
<p>and copy back the solutions to the individual calibrator measurement sets:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>#!/bin/bash
# copy back the instrument tables from a globaldb
# to be run after H5parm_exporter.py
i=0
for ms in `ls -d *MS`; do
echo &quot;Copying back ${ms}/instrument&quot;
rm -r ${ms}/instrument
cp -r globaldb/sol000_instrument-$i ${ms}/instrument
i=$((i + 1))
done
</pre></div>
</div>
<p>Now, we need to transfer the solutions from the calibrator to the target. We have to re-write the solutions we have found so that they are time independent, since the target was observed at a different time:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>for i in *MS.flg; do parmexportcal in=$i/instrument out=$i/instrument_tind; done
</pre></div>
</div>
<p>then, we can transfer (apply) the solutions to the target using the following parset:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span> <span class="o">=</span>
<span class="n">msin</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">DATA</span>
<span class="n">msin</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="p">[</span><span class="n">CR</span><span class="p">]</span><span class="n">S</span><span class="o">*&amp;</span>
<span class="n">msout</span> <span class="o">=</span> <span class="o">.</span>
<span class="n">msout</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">CORRECTED_DATA</span>
<span class="n">numthreads</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">applycal</span><span class="p">,</span> <span class="n">applybeam</span><span class="p">]</span>
<span class="n">applycal</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">applycal</span>
<span class="n">applycal</span><span class="o">.</span><span class="n">correction</span> <span class="o">=</span> <span class="n">gain</span>
<span class="n">applycal</span><span class="o">.</span><span class="n">parmdb</span> <span class="o">=</span>
<span class="n">applybeam</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">applybeam</span>
<span class="n">applybeam</span><span class="o">.</span><span class="n">invert</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>which is needed by DPPP and executed for the complete calibrator and target sub-band list using following Python script (for example):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
          <span class="n">calib_instrument</span> <span class="o">=</span> <span class="s1">&#39;calibrator/L456102_SB00&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_uv.dppp.MS/instrument_tind&#39;</span>
      <span class="n">targetMS</span> <span class="o">=</span> <span class="s1">&#39;target/L456106_SB00&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_uv.dppp.MS&#39;</span>
       <span class="k">else</span><span class="p">:</span>
      <span class="n">calib_instrument</span><span class="o">=</span> <span class="s1">&#39;calibrator/L456102_SB0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_uv.dppp.MS/instrument_tind&#39;</span>
      <span class="n">targetMS</span> <span class="o">=</span> <span class="s1">&#39;target/L456106_SB0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_uv.dppp.MS&#39;</span>
<span class="c1">#</span>
       <span class="nb">print</span> <span class="s1">&#39;NDPPP appycal.parset msin=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">targetMS</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; applycal.parmdb=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">calib_instrument</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
       <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;NDPPP applycal.parset msin=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">targetMS</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; applycal.parmdb=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">calib_instrument</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, after the flux scale has been set, the target data need to be calibrated (phase only). We need a source model of the target field:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">target</span><span class="o">/</span>
<span class="n">gsm</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">p</span> <span class="n">patchname</span><span class="p">]</span> <span class="n">outfile</span> <span class="n">RA</span> <span class="n">DEC</span> <span class="n">radius</span> <span class="p">[</span><span class="n">vlssFluxCutoff</span><span class="p">[</span><span class="n">assocTheta</span><span class="p">]]</span>
<span class="n">gsm</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">p</span> <span class="n">P1</span> <span class="n">P1</span><span class="o">.</span><span class="n">sky</span> <span class="mf">315.00000000</span> <span class="mf">52.90000000</span> <span class="mi">5</span>
<span class="n">makesourcedb</span> <span class="ow">in</span><span class="o">=</span><span class="n">P1</span><span class="o">.</span><span class="n">sky</span> <span class="n">out</span><span class="o">=</span><span class="n">P1</span><span class="o">.</span><span class="n">sourcedb</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;&lt;&quot;</span>
</pre></div>
</div>
<p>and, using the following parset:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span><span class="o">=</span>
<span class="n">msout</span><span class="o">=</span>
<span class="n">msin</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">CORRECTED_DATA</span>
<span class="n">msin</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="p">[</span><span class="n">CR</span><span class="p">]</span><span class="n">S</span><span class="o">*&amp;</span>
<span class="n">msout</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">DATA</span>
<span class="n">numthreads</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">gaincal</span><span class="p">]</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">sourcedb</span><span class="o">=</span><span class="n">P1</span><span class="o">.</span><span class="n">sourcedb</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">parmdb</span><span class="o">=</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">gaincal</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">caltype</span><span class="o">=</span><span class="n">phaseonly</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">usebeammodel</span><span class="o">=</span><span class="n">false</span>
<span class="n">gaincal</span><span class="o">.</span><span class="n">applysolution</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
<p>we calibrate the target data:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>for i in *flg; do NDPPP ../phaseonly.parset msin=$i msout=$i.ph gaincal.parmdb=$i.ph/instrument; done
</pre></div>
</div>
<p>The last line in the parset applies the solutions to the data. Alternatively, we can omit it, and apply the solutions using <strong>applycal</strong> in DPPP with the following parset:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msin</span> <span class="o">=</span>
<span class="n">msin</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">DATA</span>
<span class="n">msin</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="p">[</span><span class="n">CR</span><span class="p">]</span><span class="n">S</span><span class="o">*&amp;</span>
<span class="n">msout</span> <span class="o">=</span> <span class="o">.</span>
<span class="n">msout</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">CORRECTED_DATA</span>
<span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">applycal</span><span class="p">]</span>
<span class="n">applycal</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">applycal</span>
<span class="n">applycal</span><span class="o">.</span><span class="n">parmdb</span> <span class="o">=</span>
</pre></div>
</div>
</div>
<div class="section" id="imaging">
<h2>Imaging<a class="headerlink" href="#imaging" title="Permalink to this headline">¶</a></h2>
<p>The Wsclean imager will be used for imaging. On CEP3, you can start it as: <strong>module load Wsclean</strong>. You can check the versioning: <strong>wsclean –version</strong>, or get to the command line help: <strong>wsclean</strong></p>
<p>First, pick a random sb and run wsclean as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="o">&lt;</span><span class="n">width</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">height</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">scale</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">quick</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>Change the sb number to your random sub-band number. Replace <strong>width</strong> and <strong>height</strong> by a number of pixels. <strong>val</strong> is the image resolution, here specified in asec. Determine good values for these for imaging this LOFAR set. You want to go a bit beyond the first beam null. Note that angularwidth <span class="math">\(\sim\)</span> width x scale.</p>
<p>Note that <strong>val</strong> and <strong>asec</strong> have no space between them, e.g.: <strong>-scale 2.5asec</strong>. Other units can be specified, e.g.: “6amin”, “50masec”, “0.1deg” In order to keep processing fast for this tutorial, don’t make images <span class="math">\(&gt;\)</span> 4k or wider than 20 deg. This quick imaging should not take more than <span class="math">\(\sim\)</span> 3 min. WSClean will always automatically perform appropriate w-correction (i.e., corrections necessary for wide-field imaging).</p>
<p>Example command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="mi">1400</span> <span class="mi">1400</span> <span class="o">-</span><span class="n">scale</span> <span class="mi">50</span><span class="n">sec</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">quick</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>This will output “quick-dirty.fits” and “quick-image.fits”. Inspect these with your favourite fitsviewer (e.g., kvis, ds9, casaviewer).</p>
<div class="figure align-center" id="id5">
<img alt="_images/tut-raw-example.png" src="_images/tut-raw-example.png" />
<p class="caption"><span class="caption-number">Fig. 55 </span><span class="caption-text">Example image of a random SB.</span></p>
</div>
<p>The main parameters for cleaning are:</p>
<ul class="simple">
<li><strong>-niter &lt;count&gt;</strong> Turns cleaning on and sets max iterations. Normally, cleaning should end at the threshold, not at the max iterations.</li>
<li><strong>-mgain &lt;gain&gt;</strong> How much flux of the peak is subtracted before a major iteration is restarted. Depends on how good your beam is. 0.8 is safe, 0.9 almost always works and is faster.</li>
<li><strong>-threshold &lt;flux&gt;</strong> Set the apparent flux (in Jy) at which to stop. Should typically be 3 x <span class="math">\(\sigma\)</span>.</li>
</ul>
<p>Run the following command: (still on a single subband):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="o">&lt;</span><span class="n">width</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">height</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">scale</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">niter</span> <span class="o">&lt;</span><span class="n">niter</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="o">&lt;</span><span class="n">flux</span><span class="o">&gt;</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">clean</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="mi">1400</span> <span class="mi">1400</span> <span class="o">-</span><span class="n">scale</span> <span class="mi">50</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">niter</span> <span class="mi">50000</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="mf">0.1</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">clean</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>It is convenient to store the above command in a shell script. Notice in the output the cleaning process:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Cleaning</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span>
<span class="n">Freed</span> <span class="mi">222</span> <span class="n">image</span> <span class="n">buffer</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span>
<span class="n">Initial</span> <span class="n">peak</span><span class="p">:</span> <span class="mf">3.2568</span>
<span class="n">Next</span> <span class="n">major</span> <span class="n">iteration</span> <span class="n">at</span><span class="p">:</span> <span class="mf">0.651359</span>
<span class="n">Iteration</span> <span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">602</span><span class="p">,</span><span class="mi">465</span><span class="p">),</span> <span class="mf">3.2568</span> <span class="n">Jy</span>
<span class="p">[</span><span class="o">..</span><span class="p">]</span>
<span class="n">Iteration</span> <span class="mi">100</span><span class="p">:</span> <span class="p">(</span><span class="mi">731</span><span class="p">,</span><span class="mi">561</span><span class="p">),</span> <span class="mf">0.789584</span> <span class="n">Jy</span>
<span class="n">Stopped</span> <span class="n">on</span> <span class="n">peak</span> <span class="mf">0.646578</span>
<span class="p">[</span><span class="o">..</span><span class="p">]</span>
<span class="o">==</span> <span class="n">Cleaning</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span>
<span class="p">[</span><span class="o">..</span><span class="p">]</span>
<span class="n">Stopped</span> <span class="n">on</span> <span class="n">peak</span> <span class="mf">0.130435</span>
<span class="p">[</span><span class="o">..</span><span class="p">]</span>
<span class="o">==</span> <span class="n">Cleaning</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span>
<span class="n">Major</span> <span class="n">iteration</span> <span class="n">threshold</span> <span class="n">reached</span> <span class="k">global</span> <span class="n">threshold</span> <span class="n">of</span> <span class="mf">0.1</span><span class="p">:</span> <span class="n">final</span> <span class="n">major</span> <span class="n">iteration</span><span class="o">.</span>
<span class="n">Iteration</span> <span class="mi">2000</span><span class="p">:</span> <span class="p">(</span><span class="mi">545</span><span class="p">,</span><span class="mi">542</span><span class="p">),</span> <span class="mf">0.12621</span> <span class="n">Jy</span>
<span class="n">Stopped</span> <span class="n">on</span> <span class="n">peak</span> <span class="o">-</span><span class="mf">0.0999906</span>
</pre></div>
</div>
<p>The threshold is reached in 2000 iterations.</p>
<p>Example command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="mi">1400</span> <span class="mi">1400</span> <span class="o">-</span><span class="n">scale</span> <span class="mi">50</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">niter</span> <span class="mi">50000</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="mf">0.1</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">clean</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<div class="figure align-center" id="id6">
<img alt="_images/tut-clean-example.png" src="_images/tut-clean-example.png" />
<p class="caption"><span class="caption-number">Fig. 56 </span><span class="caption-text">Example of a cleaned vs. dirty image.</span></p>
</div>
<p>The LOFAR beam is applied by adding <strong>-apply-primary-beam</strong>. Note that the beam was already applied on the phase centre during calibration (the “applybeam” step in NDPPP). WSClean needs to know this, otherwise it will use the wrong beam. This is specified by also adding <strong>-use-differential-lofar-beam</strong>. Repeat the previous imaging with the beam, similar to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="o">&lt;</span><span class="n">width</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">height</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">scale</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">apply</span><span class="o">-</span><span class="n">primary</span><span class="o">-</span><span class="n">beam</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">differential</span><span class="o">-</span><span class="n">lofar</span><span class="o">-</span><span class="n">beam</span> \
<span class="o">-</span><span class="n">niter</span> <span class="o">&lt;</span><span class="n">niter</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="o">&lt;</span><span class="n">flux</span><span class="o">&gt;</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">lofarbeam</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="mi">1400</span> <span class="mi">1400</span> <span class="o">-</span><span class="n">scale</span> <span class="mi">50</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">apply</span><span class="o">-</span><span class="n">primary</span><span class="o">-</span><span class="n">beam</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">differential</span><span class="o">-</span><span class="n">lofar</span><span class="o">-</span><span class="n">beam</span> \
<span class="o">-</span><span class="n">niter</span> <span class="mi">50000</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="mf">0.1</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">clean</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<div class="figure align-center" id="id7">
<img alt="_images/tut-beam-on.png" src="_images/tut-beam-on.png" />
<p class="caption"><span class="caption-number">Fig. 57 </span><span class="caption-text">Primary beam correction.</span></p>
</div>
<p>Read the documentation for <strong>-weight</strong>, <strong>-taper-gaussian</strong> and <strong>-trim</strong>, and optionally other weighting/tapering methods. Repeat the previous imaging, but with settings for these parameters that are useful to:</p>
<ul class="simple">
<li>accentuate the diffuse emission; and</li>
<li>to make the beam Gaussian like, to measure the flux of the emission more easily.</li>
</ul>
<p>Correct for the primary beam as before. Like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="o">&lt;</span><span class="n">width</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">height</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">scale</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">trim</span> <span class="o">&lt;</span><span class="n">trimwidth</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">trimheight</span><span class="o">&gt;</span> \
<span class="o">-</span><span class="n">apply</span><span class="o">-</span><span class="n">primary</span><span class="o">-</span><span class="n">beam</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">differential</span><span class="o">-</span><span class="n">lofar</span><span class="o">-</span><span class="n">beam</span> \
<span class="o">-</span><span class="n">niter</span> <span class="o">&lt;</span><span class="n">niter</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="o">&lt;</span><span class="n">flux</span><span class="o">&gt;</span> \
<span class="o">-</span><span class="n">weight</span> <span class="p">[</span><span class="n">briggs</span> <span class="o">&lt;</span><span class="n">robustness</span><span class="o">&gt;</span> <span class="ow">or</span> <span class="n">natural</span><span class="p">]</span> \
<span class="o">-</span><span class="n">taper</span><span class="o">-</span><span class="n">gaussian</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">amin</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">clean</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="mi">1800</span> <span class="mi">1800</span> <span class="o">-</span><span class="n">scale</span> <span class="mi">50</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">trim</span> <span class="mi">1400</span> <span class="mi">1400</span> <span class="o">-</span><span class="n">weight</span> <span class="n">briggs</span> <span class="mi">0</span> \
<span class="o">-</span><span class="n">niter</span> <span class="mi">50000</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="mf">0.1</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">weighting</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<div class="figure align-center" id="id8">
<img alt="_images/tut-weights.png" src="_images/tut-weights.png" />
<p class="caption"><span class="caption-number">Fig. 58 </span><span class="caption-text">Weighting.</span></p>
</div>
<p>Note the negative areas around the diffuse sources. Inspect the “model” image. How did WSClean model the diffuse emission and SNRs? Repeat the previous imaging, but use multiscale. If you feel adventurous, you can play with <strong>-multiscale-scales</strong> and <strong>-multiscale-scale-bias</strong>. However, for LOFAR this is hardly ever necessary.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="o">&lt;</span><span class="n">width</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">height</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">scale</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">trim</span> <span class="o">&lt;</span><span class="n">trimwidth</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">trimheight</span><span class="o">&gt;</span> \
<span class="o">-</span><span class="n">apply</span><span class="o">-</span><span class="n">primary</span><span class="o">-</span><span class="n">beam</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">differential</span><span class="o">-</span><span class="n">lofar</span><span class="o">-</span><span class="n">beam</span> \
<span class="o">-</span><span class="n">niter</span> <span class="o">&lt;</span><span class="n">niter</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="o">&lt;</span><span class="n">flux</span><span class="o">&gt;</span> \
<span class="o">-</span><span class="n">weight</span> <span class="p">[</span><span class="n">your</span> <span class="n">weighting</span> <span class="n">choice</span><span class="p">]</span> \
<span class="o">-</span><span class="n">taper</span><span class="o">-</span><span class="n">gaussian</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">amin</span> \
<span class="o">-</span><span class="n">multiscale</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">multiscale</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>Baseline-dependent averaging (only available for versions later than v1.12) lowers the number of visibilities that need to be gridded, which therefore speeds up the imaging. To enable it, one adds <strong>-baseline-averaging</strong> to the command line with the number of wavelengths (<span class="math">\(\lambda\)</span>) that can be averaged over. Use this rule: <span class="math">\(\lambda = \text{max baseline in } \lambda \times 2 \times \pi \times \text{integration time in sec } / (24 * 60 * 60)\)</span>. Rerun the previous imaging with b.d. averaging. Turn beam correction off (it does not work together with b.d. averaging yet). Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="mi">1800</span> <span class="mi">1800</span> <span class="o">-</span><span class="n">scale</span> <span class="mi">50</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">trim</span> <span class="mi">1400</span> <span class="mi">1400</span> <span class="o">-</span><span class="n">weight</span> <span class="n">briggs</span> <span class="mi">0</span> \
<span class="o">-</span><span class="n">multiscale</span> \
<span class="o">-</span><span class="n">niter</span> <span class="mi">100000</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="mf">0.15</span> \
<span class="o">-</span><span class="n">baseline</span><span class="o">-</span><span class="n">averaging</span> <span class="mf">2.0</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">required</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">bdaveraging</span> <span class="n">L456106_SB010_uv</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>Try a second run with more averaging and inspect the difference between the images. How much averaging is acceptable?</p>
<p>Several approaches are possible for combining all bands (i.e. measurement sets / SBs):</p>
<ul class="simple">
<li>Run WSClean on each band and combine images afterwards. Only limited cleaning possible.</li>
<li>Image all MSes in one run with WSClean. Clean deep, but assumes flux is constant over frequency.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="o">&lt;</span><span class="n">width</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">height</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">scale</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">asec</span> \
<span class="p">[</span><span class="o">..</span><span class="p">]</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">fullbandwidth</span> <span class="o">*.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">flg</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>This takes quite a lot of time. If you have time, you can run the command. You can also run it with only a few measurement sets. If you run clean on the full bandwidth, you can decrease the threshold significantly, because the system noise will go down by <span class="math">\(\sqrt{N}\)</span>.</p>
<p>Image all SBs and use multi-frequency deconvolution. Cleans deep and incorporates frequency dependency. Relevant parameters: <strong>-channelsout &lt;count&gt;</strong>, <strong>-joinchannels</strong>, <strong>-fit-spectral-pol &lt;terms&gt;</strong>, <strong>-deconvolution-channels &lt;count&gt;</strong>. Like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="o">&lt;</span><span class="n">width</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">height</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">scale</span> <span class="o">&lt;</span><span class="n">val</span><span class="o">&gt;</span><span class="n">asec</span> \
<span class="p">[</span><span class="o">..</span><span class="p">]</span> \
<span class="o">-</span><span class="n">channelsout</span> <span class="o">&lt;</span><span class="n">count</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">joinchannels</span> \
<span class="o">-</span><span class="n">fit</span><span class="o">-</span><span class="n">spectral</span><span class="o">-</span><span class="n">pol</span> <span class="o">&lt;</span><span class="n">terms</span><span class="o">&gt;</span> \
<span class="o">-</span><span class="n">deconvolution</span><span class="o">-</span><span class="n">channels</span> <span class="o">&lt;</span><span class="n">count</span><span class="o">&gt;</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">mfclean</span> <span class="o">*.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>Decrease the threshold to an appropriate level. Example command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wsclean</span> <span class="o">-</span><span class="n">size</span> <span class="mi">1800</span> <span class="mi">1800</span> <span class="o">-</span><span class="n">scale</span> <span class="mi">50</span><span class="n">asec</span> \
<span class="o">-</span><span class="n">apply</span><span class="o">-</span><span class="n">primary</span><span class="o">-</span><span class="n">beam</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">differential</span><span class="o">-</span><span class="n">lofar</span><span class="o">-</span><span class="n">beam</span> \
<span class="o">-</span><span class="n">trim</span> <span class="mi">1400</span> <span class="mi">1400</span> <span class="o">-</span><span class="n">weight</span> <span class="n">briggs</span> <span class="mi">0</span> \
<span class="o">-</span><span class="n">multiscale</span> \
<span class="o">-</span><span class="n">niter</span> <span class="mi">100000</span> <span class="o">-</span><span class="n">mgain</span> <span class="mf">0.8</span> <span class="o">-</span><span class="n">threshold</span> <span class="mf">0.15</span> \
<span class="o">-</span><span class="n">channelsout</span> <span class="mi">14</span> <span class="o">-</span><span class="n">joinchannels</span> <span class="o">-</span><span class="n">fit</span><span class="o">-</span><span class="n">spectral</span><span class="o">-</span><span class="n">pol</span> <span class="mi">2</span> \
<span class="o">-</span><span class="n">deconvolution</span><span class="o">-</span><span class="n">channels</span> <span class="mi">4</span> \
<span class="o">-</span><span class="n">name</span> <span class="n">mfclean</span> <span class="o">*.</span><span class="n">dppp</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">ph</span>
</pre></div>
</div>
<p>Analyse the individual output images and the MFS images.</p>
</div>
<div class="section" id="c295-a-bright-source-at-the-centre-of-the-field">
<h2>3C295 – A bright source at the centre of the field<a class="headerlink" href="#c295-a-bright-source-at-the-centre-of-the-field" title="Permalink to this headline">¶</a></h2>
<p>In this exercise, the user will calibrate LBA and HBA datasets for 3C295. By the end of the exercise the user should be able to:</p>
<ul class="simple">
<li>inspect raw LOFAR data,</li>
<li>automatically and manually flag data with DPPP, including demix the LBA data,</li>
<li>calibrate the data with DPPP,</li>
<li>produce maps with WSClean,</li>
<li>create a sky model from the data, and,</li>
<li>subtract bright sources using DPPP</li>
</ul>
<p>The data ara available on the LOFAR LTA, as described at the beginning of this chapter. You will see the HBA data set listed at the top of the page, and if you click on the “Unspecified process” at the bottom, the LBA data set will show up.</p>
<p>Log into one of the compute nodes above, and make a new directory, for example,</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">Y</span> <span class="n">lof019</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">scratch</span><span class="o">/&lt;</span><span class="n">username</span><span class="o">&gt;/</span>
<span class="n">mkdir</span> <span class="n">tutorial</span><span class="o">/</span>
<span class="n">mkdir</span> <span class="n">tutorial</span><span class="o">/</span><span class="mi">3</span><span class="n">c295</span><span class="o">/</span>
<span class="n">cd</span> <span class="n">tutorial</span><span class="o">/</span><span class="mi">3</span><span class="n">c295</span>
</pre></div>
</div>
<p>You will be using the LOFAR software tools. To initialise these use</p>
<blockquote>
<div>module load lofar</div></blockquote>
<div class="section" id="hba">
<h3>HBA<a class="headerlink" href="#hba" title="Permalink to this headline">¶</a></h3>
<p>The unique LOFAR observation number is L74759 and there are two sub-bands, SB000 and SB001.</p>
<p>The data set is in Measurement Set (MS) format and the filenames are respectively</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">L74759_SAP000_SB000_uv</span><span class="o">.</span><span class="n">MS</span>
<span class="n">L74759_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span>
</pre></div>
</div>
<p>for the two sub-bands.</p>
<div class="section" id="inspecting-the-raw-data">
<h4>Inspecting the raw data<a class="headerlink" href="#inspecting-the-raw-data" title="Permalink to this headline">¶</a></h4>
<p>It is always useful to find out what the details of the observation are (frequency, integration time, number of stations) before starting on the data reduction. This is done using the command,</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msoverview</span> <span class="ow">in</span><span class="o">=</span><span class="n">L74759_SAP000_SB000_uv</span><span class="o">.</span><span class="n">MS</span> <span class="n">verbose</span><span class="o">=</span><span class="n">T</span>
<span class="n">msoverview</span><span class="p">:</span> <span class="n">Version</span> <span class="mi">20110407</span><span class="n">GvD</span>
<span class="o">================================================================================</span>
          <span class="n">MeasurementSet</span> <span class="n">Name</span><span class="p">:</span>  <span class="o">/</span><span class="n">cep3home</span><span class="o">/</span><span class="n">williams</span><span class="o">/</span><span class="n">tutorial</span><span class="o">/</span><span class="n">L74759_SAP000_SB000_uv</span><span class="o">.</span><span class="n">MS</span>      <span class="n">MS</span> <span class="n">Version</span> <span class="mi">2</span>
<span class="o">================================================================================</span>
           <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">raw</span> <span class="n">LOFAR</span> <span class="n">MS</span> <span class="p">(</span><span class="n">stored</span> <span class="k">with</span> <span class="n">LofarStMan</span><span class="p">)</span>

   <span class="n">Observer</span><span class="p">:</span> <span class="n">unknown</span>     <span class="n">Project</span><span class="p">:</span> <span class="mi">2012</span><span class="n">LOFAROBS</span>
<span class="n">Observation</span><span class="p">:</span> <span class="n">LOFAR</span>
<span class="n">Antenna</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span> <span class="n">HBA_DUAL_INNER</span>

<span class="n">Data</span> <span class="n">records</span><span class="p">:</span> <span class="mi">5337090</span>       <span class="n">Total</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">3599</span> <span class="n">seconds</span>
   <span class="n">Observed</span> <span class="kn">from</span>   <span class="mi">12</span><span class="o">-</span><span class="n">Nov</span><span class="o">-</span><span class="mi">2012</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">00.0</span>   <span class="n">to</span>   <span class="mi">12</span><span class="o">-</span><span class="n">Nov</span><span class="o">-</span><span class="mi">2012</span><span class="o">/</span><span class="mi">13</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mf">59.0</span> <span class="p">(</span><span class="n">UTC</span><span class="p">)</span>


<span class="n">Fields</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">ID</span>   <span class="n">Code</span> <span class="n">Name</span>                <span class="n">RA</span>               <span class="n">Decl</span>           <span class="n">Epoch</span>        <span class="n">nRows</span>
  <span class="mi">0</span>         <span class="n">BEAM_0</span>              <span class="mi">14</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mf">20.500000</span> <span class="o">+</span><span class="mf">52.12</span><span class="o">.</span><span class="mf">10.00000</span> <span class="n">J2000</span>      <span class="mi">5337090</span>

<span class="n">Spectral</span> <span class="n">Windows</span><span class="p">:</span>  <span class="p">(</span><span class="mi">1</span> <span class="n">unique</span> <span class="n">spectral</span> <span class="n">windows</span> <span class="ow">and</span> <span class="mi">1</span> <span class="n">unique</span> <span class="n">polarization</span> <span class="n">setups</span><span class="p">)</span>
  <span class="n">SpwID</span>  <span class="n">Name</span>   <span class="c1">#Chans   Frame   Ch0(MHz)  ChanWid(kHz)  TotBW(kHz) CtrFreq(MHz)  Corrs</span>
  <span class="mi">0</span>      <span class="n">SB</span><span class="o">-</span><span class="mi">0</span>      <span class="mi">64</span>   <span class="n">TOPO</span>     <span class="mf">118.849</span>         <span class="mf">3.052</span>       <span class="mf">195.3</span>    <span class="mf">118.9453</span>   <span class="n">XX</span>  <span class="n">XY</span>  <span class="n">YX</span>  <span class="n">YY</span>

<span class="n">Antennas</span><span class="p">:</span> <span class="mi">54</span><span class="p">:</span>
  <span class="n">ID</span>   <span class="n">Name</span>  <span class="n">Station</span>   <span class="n">Diam</span><span class="o">.</span>    <span class="n">Long</span><span class="o">.</span>         <span class="n">Lat</span><span class="o">.</span>                <span class="n">Offset</span> <span class="kn">from</span> <span class="nn">array</span> <span class="n">center</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span>                <span class="n">ITRF</span> <span class="n">Geocentric</span> <span class="n">coordinates</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span>
                                                                     <span class="n">East</span>         <span class="n">North</span>     <span class="n">Elevation</span>               <span class="n">x</span>               <span class="n">y</span>               <span class="n">z</span>
  <span class="mi">0</span>    <span class="n">CS001HBA0LOFAR</span>     <span class="mf">31.3</span> <span class="n">m</span>   <span class="o">+</span><span class="mf">006.52</span><span class="o">.</span><span class="mf">07.1</span>  <span class="o">+</span><span class="mf">52.43</span><span class="o">.</span><span class="mf">34.7</span>         <span class="o">-</span><span class="mf">0.0006</span>       <span class="o">-</span><span class="mf">0.1610</span>  <span class="mf">6364572.0471</span>  <span class="mf">3826896.235000</span>   <span class="mf">460979.455000</span>  <span class="mf">5064658.203000</span>
  <span class="mi">1</span>    <span class="n">CS001HBA1LOFAR</span>     <span class="mf">31.3</span> <span class="n">m</span>   <span class="o">+</span><span class="mf">006.52</span><span class="o">.</span><span class="mf">02.2</span>  <span class="o">+</span><span class="mf">52.43</span><span class="o">.</span><span class="mf">31.8</span>         <span class="o">-</span><span class="mf">0.0013</span>       <span class="o">-</span><span class="mf">0.1617</span>  <span class="mf">6364572.3376</span>  <span class="mf">3826979.384000</span>   <span class="mf">460897.597000</span>  <span class="mf">5064603.189000</span>
  <span class="mi">2</span>    <span class="n">CS002HBA0LOFAR</span>     <span class="mf">31.3</span> <span class="n">m</span>   <span class="o">+</span><span class="mf">006.52</span><span class="o">.</span><span class="mf">07.6</span>  <span class="o">+</span><span class="mf">52.43</span><span class="o">.</span><span class="mf">46.8</span>         <span class="o">-</span><span class="mf">0.0005</span>       <span class="o">-</span><span class="mf">0.1582</span>  <span class="mf">6364570.0290</span>  <span class="mf">3826600.961000</span>   <span class="mf">460953.402000</span>  <span class="mf">5064881.136000</span>
  <span class="o">...</span>
  <span class="o">...</span>
  <span class="mi">43</span>   <span class="n">CS501HBA1LOFAR</span>     <span class="mf">31.3</span> <span class="n">m</span>   <span class="o">+</span><span class="mf">006.51</span><span class="o">.</span><span class="mf">59.7</span>  <span class="o">+</span><span class="mf">52.44</span><span class="o">.</span><span class="mf">25.8</span>         <span class="o">-</span><span class="mf">0.0017</span>       <span class="o">-</span><span class="mf">0.1489</span>  <span class="mf">6364565.9714</span>  <span class="mf">3825663.508000</span>   <span class="mf">460692.658000</span>  <span class="mf">5065607.883000</span>
  <span class="mi">44</span>   <span class="n">RS106HBALOFAR</span>     <span class="mf">31.3</span> <span class="n">m</span>   <span class="o">+</span><span class="mf">006.59</span><span class="o">.</span><span class="mf">05.6</span>  <span class="o">+</span><span class="mf">52.41</span><span class="o">.</span><span class="mf">21.6</span>          <span class="mf">0.0592</span>       <span class="o">-</span><span class="mf">0.1926</span>  <span class="mf">6364586.7503</span>  <span class="mf">3829205.598000</span>   <span class="mf">469142.533000</span>  <span class="mf">5062181.002000</span>
  <span class="o">...</span>
  <span class="o">...</span>
  <span class="mi">51</span>   <span class="n">RS503HBALOFAR</span>     <span class="mf">31.3</span> <span class="n">m</span>   <span class="o">+</span><span class="mf">006.51</span><span class="o">.</span><span class="mf">04.8</span>  <span class="o">+</span><span class="mf">52.45</span><span class="o">.</span><span class="mf">33.2</span>         <span class="o">-</span><span class="mf">0.0095</span>       <span class="o">-</span><span class="mf">0.1330</span>  <span class="mf">6364557.2108</span>  <span class="mf">3824138.566000</span>   <span class="mf">459476.972000</span>  <span class="mf">5066858.578000</span>
  <span class="mi">52</span>   <span class="n">RS508HBALOFAR</span>     <span class="mf">31.3</span> <span class="n">m</span>   <span class="o">+</span><span class="mf">006.57</span><span class="o">.</span><span class="mf">13.3</span>  <span class="o">+</span><span class="mf">53.03</span><span class="o">.</span><span class="mf">21.7</span>          <span class="mf">0.0431</span>        <span class="mf">0.1202</span>  <span class="mf">6364441.8110</span>  <span class="mf">3797136.484000</span>   <span class="mf">463114.447000</span>  <span class="mf">5086651.286000</span>
  <span class="mi">53</span>   <span class="n">RS509HBALOFAR</span>     <span class="mf">31.3</span> <span class="n">m</span>   <span class="o">+</span><span class="mf">006.47</span><span class="o">.</span><span class="mf">04.7</span>  <span class="o">+</span><span class="mf">53.13</span><span class="o">.</span><span class="mf">30.1</span>         <span class="o">-</span><span class="mf">0.0438</span>        <span class="mf">0.2644</span>  <span class="mf">6364384.5199</span>  <span class="mf">3783537.525000</span>   <span class="mf">450130.064000</span>  <span class="mf">5097866.146000</span>

<span class="n">The</span> <span class="n">MS</span> <span class="ow">is</span> <span class="n">fully</span> <span class="n">regular</span><span class="p">,</span> <span class="n">thus</span> <span class="n">suitable</span> <span class="k">for</span> <span class="n">BBS</span>
   <span class="n">nrows</span><span class="o">=</span><span class="mi">5337090</span>   <span class="n">ntimes</span><span class="o">=</span><span class="mi">3594</span>   <span class="n">nbands</span><span class="o">=</span><span class="mi">1</span>   <span class="n">nbaselines</span><span class="o">=</span><span class="mi">1485</span> <span class="p">(</span><span class="mi">54</span> <span class="n">autocorr</span><span class="p">)</span>
</pre></div>
</div>
<p>From this, you should see that  HBA_DUAL_INNER mode was used, i.e. the core stations are split in two HBA sub-fields, giving a total of 54 stations, and the size of the remote stations is the same as the core stations. The observation was <span class="math">\(\sim1\)</span> hour (3599 seconds) with 3594 timestamps so the time resolution is <span class="math">\(\sim1\)</span> s. There are 64 spectral channels and the frequency is 118.849 MHz for SB000 and  119.044 MHz for SB001, and the total bandwidth for each subband is <span class="math">\(\sim0.2\)</span> MHz.</p>
</div>
<div class="section" id="flagging-and-data-compression">
<h4>Flagging and data compression<a class="headerlink" href="#flagging-and-data-compression" title="Permalink to this headline">¶</a></h4>
<p>The data set that we are using is uncompressed and unflagged; the total size of each MS is $11$,GB. The data flagging and compression are carried out using <a class="reference external" href="./dppp.html">DPPP</a>. Typically, initial RFI flagging and averaging will be done by the averaging pipeline run by the Radio Observatory. Note that the limitation on the compression in frequency is set by the size of the field you wish to image and the amount of bandwidth smearing at the edges of the field. The time averaging is limited not only by the amount of time smearing you will allow but also by the changes in the ionosphere.</p>
<p>In this example we are flagging the data using the aoflagger algorithm within DPPP. Here we will compress the sub-band to 4 channels in frequency and 5 s in time. The parset file for the flagging and compression should be copied to your working directory,</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">NDPPP_HBA_preprocess</span><span class="o">.</span><span class="n">parset</span>

<span class="n">msin</span> <span class="o">=</span> <span class="n">L74759_SAP000_SB000_uv</span><span class="o">.</span><span class="n">MS</span>
<span class="n">msin</span><span class="o">.</span><span class="n">autoweight</span><span class="o">=</span><span class="n">TRUE</span>
<span class="n">msin</span><span class="o">.</span><span class="n">datacolumn</span><span class="o">=</span><span class="n">DATA</span>

<span class="n">msout</span> <span class="o">=</span> <span class="n">L74759_SAP000_SB000_uv</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">avg</span><span class="o">.</span><span class="n">dppp</span>
<span class="n">msout</span><span class="o">.</span><span class="n">datacolumn</span><span class="o">=</span><span class="n">DATA</span>

<span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">preflagger0</span><span class="p">,</span><span class="n">preflagger1</span><span class="p">,</span><span class="n">aoflagger</span><span class="p">,</span><span class="n">averager</span><span class="p">]</span>

<span class="n">preflagger0</span><span class="o">.</span><span class="n">chan</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">63</span><span class="p">]</span>
<span class="n">preflagger0</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">preflagger</span>

<span class="n">preflagger1</span><span class="o">.</span><span class="n">corrtype</span><span class="o">=</span><span class="n">auto</span>
<span class="n">preflagger1</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">preflagger</span>

<span class="n">aoflagger</span><span class="o">.</span><span class="n">autocorr</span><span class="o">=</span><span class="n">F</span>
<span class="n">aoflagger</span><span class="o">.</span><span class="n">timewindow</span><span class="o">=</span><span class="mi">0</span>
<span class="n">aoflagger</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">aoflagger</span>

<span class="n">averager</span><span class="o">.</span><span class="n">freqstep</span><span class="o">=</span><span class="mi">16</span>     <span class="c1"># compresses from 64 to 4 channels</span>
<span class="n">averager</span><span class="o">.</span><span class="n">timestep</span><span class="o">=</span><span class="mi">4</span>     <span class="c1"># compresses 4 time-slots into 1, i.e. 4s</span>
<span class="n">averager</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">averager</span>
</pre></div>
</div>
<p>This parset file will take the data set, flag and compress and then make a new copy in your working area. If necessary, edit the msin and msout fields to point at your working directory, using your favourite editor (e.g. vim, nano, nedit). To run DPPP use,</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DPPP</span> <span class="n">NDPPP_HBA_preprocess</span><span class="o">.</span><span class="n">parset</span> <span class="o">&gt;</span> <span class="n">log</span><span class="o">.</span><span class="n">ndppp</span><span class="o">.</span><span class="n">flagavg</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>In bash, the <strong>2&gt;&amp;1</strong> pipes both the stdout and stderr to the log file and the <strong>&amp;</strong> runs the task in the background so you can continue working on the terminal.</p>
<p>Depending on the use of the cluster, it will take about $sim5$ minutes to flag and average the data. The progress bar reports the stage of the initial DPPP steps, not the entire DPPP run, so it will keep running several minutes after the progress bar reaches 100%.</p>
<p>You can inspect the output log file by using,</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">log</span><span class="o">.</span><span class="n">ndppp</span><span class="o">.</span><span class="n">flagavg</span>
</pre></div>
</div>
<p>The log file lists the input and output parameters, the level of flagging at each step and the total amount of data flagged. You will see that the total data flagged for each of the flagging steps is 4.7%, 3.4% and 2.6% respectively.</p>
<p>Edit the msin and msout fields of the parset to do the same for the second sub-band. Or you can run it again using the same parset and supplying new msin and msout parameters on the command line, i.e.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DPPP</span> <span class="n">NDPPP_HBA_preprocess</span><span class="o">.</span><span class="n">parset</span> <span class="n">msin</span><span class="o">=</span><span class="n">L74759_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span> \
<span class="n">msout</span><span class="o">=</span><span class="n">L74759_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">avg</span><span class="o">.</span><span class="n">dppp</span>  <span class="o">&gt;</span> <span class="n">log</span><span class="o">.</span><span class="n">ndppp</span><span class="o">.</span><span class="n">flagavg1</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>The flagged and compressed data set should now be in your working directory and each MS should have a total size of 333 MB, which is much more manageable than before. You can use msoverview to look at a summary of this data set using.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msoverview</span> <span class="ow">in</span><span class="o">=</span><span class="n">L74759_SAP000_SB000_uv</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">avg</span><span class="o">.</span><span class="n">dppp</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="section" id="post-compression-data-inspection-and-flagging">
<h4>Post-compression data inspection and flagging<a class="headerlink" href="#post-compression-data-inspection-and-flagging" title="Permalink to this headline">¶</a></h4>
<p>We will use the CASA task plotms to inspect the data. Only limited information for using plotms is given here, the User is directed to the <a class="reference external" href="href{http://casa.nrao.edu/Doc/Cookbook/casa_cookbook.pdf">CASA cookbook</a> for full details.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">casa</span>
<span class="n">casaplotms</span>
</pre></div>
</div>
<p><a class="reference internal" href="#amptime"><span class="std std-numref">Fig. 59</span></a> and <a class="reference internal" href="#ampuv"><span class="std std-numref">Fig. 60</span></a> show the Amp. vs. time and Amp. vs. UV distance (wavelengths) for SB000. Through inspecting the data in casaplotms you should be able to see that CS302HBA0 has consistently low amplitudes and is the only station contributing to the few high amplitudes. If you look back at the logs from the initial NDPPP preprocessing you will notice that about 40-50% of the data for this station was flagged by aoflagger.</p>
<div class="figure align-center" id="id9">
<span id="amptime"></span><img alt="_images/tutorial_hba_plotms_raw_amp_time.png" src="_images/tutorial_hba_plotms_raw_amp_time.png" />
<p class="caption"><span class="caption-number">Fig. 59 </span><span class="caption-text">Plotting the XX visibility amplitude against time.</span></p>
</div>
<div class="figure align-center" id="id10">
<span id="ampuv"></span><img alt="_images/tutorial_hba_plotms_raw_amp_uvwave_ant.png" src="_images/tutorial_hba_plotms_raw_amp_uvwave_ant.png" />
<p class="caption"><span class="caption-number">Fig. 60 </span><span class="caption-text">Plotting the visibility amplitude against UV distance in wavelengths.</span></p>
</div>
<p>We will remove CS302HBA0 now with DPPP. This can be done either by flagging it with a preflagger step or, as we will do here, filtering it out. In this way it is completely removed from the MS so we have to specify a new output MS. The DPPP parsets are:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cat NDPPP.split.sb000.parset

msin = L74759_SAP000_SB000_uv.MS.avg.dppp
msin.baseline = !CS302HBA0
msin.datacolumn = DATA
msout = L74759_SAP000_SB000_uv.MS.avg.dppp.flag

steps=[]

DPPP NDPPP.split.sb000.parset &gt; ndppp.flag0.log 2&gt;&amp;1 &amp;
</pre></div>
</div>
<p>and likewise for the other subband:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">DPPP</span> <span class="n">NDPPP</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">sb000</span><span class="o">.</span><span class="n">parset</span> <span class="n">msin</span><span class="o">=</span><span class="n">L74759_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">avg</span><span class="o">.</span><span class="n">dppp</span> \
<span class="n">msout</span><span class="o">=</span><span class="n">L74759_SAP000_SB001_uv</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">avg</span><span class="o">.</span><span class="n">dppp</span><span class="o">.</span><span class="n">flag</span> <span class="o">&gt;</span> <span class="n">ndppp</span><span class="o">.</span><span class="n">flag1</span><span class="o">.</span><span class="n">log</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>The visibilities after removing CS302HBA0 are shown in <a class="reference internal" href="#plotms1a"><span class="std std-numref">Fig. 61</span></a>.</p>
<div class="figure align-center" id="id11">
<span id="plotms1a"></span><img alt="_images/tutorial_hba_plotms_raw_amp_uvwave_ant1.png" src="_images/tutorial_hba_plotms_raw_amp_uvwave_ant1.png" />
<p class="caption"><span class="caption-number">Fig. 61 </span><span class="caption-text">SB000. Plotting the XX visibility amplitude against UV distance in wavelengths after flagging CS302HBA0. (The colour scheme ‘Antenna1’ is used here.)</span></p>
</div>
</div>
<div class="section" id="calibration-with-dppp">
<h4>Calibration with DPPP<a class="headerlink" href="#calibration-with-dppp" title="Permalink to this headline">¶</a></h4>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>The author of this Chapter is <a class="reference external" href="mailto:w&#46;williams&#37;&#52;&#48;herts&#46;ac&#46;uk">Wendy Williams</a>. Contribution was also given by many commissioners: Alicia Berciano Alba, Valentina Vacca, Poppy Martin, Maciej Ceglowski, Carmen Toribio, Emanuela Orru, Andre Offringa and Neal Jackson.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Note that you should load the casa module before loading the lofar module on CEP3 for them to function as intended.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="changelog.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="awimager.html" class="btn btn-neutral" title="The AW Imager" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      Last updated on Jan 08, 2018.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'22.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Factor: Facet Calibration for LOFAR &mdash; LOFAR Imaging Cookbook 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="LOFAR Imaging Cookbook 0.0.1 documentation" href="index.html"/>
        <link rel="next" title="Practical examples" href="tutorial.html"/>
        <link rel="prev" title="Source detection and sky model manipulation: PyBDSF and LSMTool" href="sourcedetection.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> LOFAR Imaging Cookbook
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Getting started </a></li>
<li class="toctree-l1"><a class="reference internal" href="datainspection.html">Data inspection </a></li>
<li class="toctree-l1"><a class="reference internal" href="aoflagger.html">AOFlagger </a></li>
<li class="toctree-l1"><a class="reference internal" href="dppp.html">The Default Pre-Processing Pipeline (DPPP) </a></li>
<li class="toctree-l1"><a class="reference internal" href="dpppcalibrate.html">Gain calibration with DPPP </a></li>
<li class="toctree-l1"><a class="reference internal" href="losoto.html">LoSoTo: LOFAR Solution Tool </a></li>
<li class="toctree-l1"><a class="reference internal" href="wsclean.html">The WSClean Imager </a></li>
<li class="toctree-l1"><a class="reference internal" href="sourcedetection.html">Source detection and sky model manipulation: PyBDSF and LSMTool </a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Factor: Facet Calibration for LOFAR </a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-preparation-pre-facet-calibration-pipeline">Data preparation: Pre-facet calibration pipeline </a><ul>
<li class="toctree-l3"><a class="reference internal" href="#download-and-set-up">Download and set-up</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overview-and-examples">Overview and examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#factor-tutorials">Factor tutorials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#quick-start">Quick-start</a></li>
<li class="toctree-l3"><a class="reference internal" href="#selecting-the-dde-calibrators-and-facets">Selecting the DDE calibrators and facets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#imaging-a-target-source">Imaging a target source</a></li>
<li class="toctree-l3"><a class="reference internal" href="#peeling-bright-sources">Peeling bright sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="#checking-the-results-of-a-run">Checking the results of a run</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dealing-with-failed-self-calibration">Dealing with failed self calibration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#imaging-at-the-end-of-a-run">Imaging at the end of a run</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resuming-and-resetting-a-run">Resuming and resetting a run</a></li>
<li class="toctree-l3"><a class="reference internal" href="#finding-the-final-output-products">Finding the final output products</a></li>
<li class="toctree-l3"><a class="reference internal" href="#archiving-a-factor-run">Archiving a Factor run</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Practical examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Useful resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="bbs.html">Black-Board Selfcal (BBS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="shapelets.html">Sky Model Construction Using Shapelets </a></li>
<li class="toctree-l1"><a class="reference internal" href="sagecal.html">SAGECAL </a></li>
<li class="toctree-l1"><a class="reference internal" href="awimager.html">The AW Imager </a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LOFAR Imaging Cookbook</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Factor: Facet Calibration for LOFAR </li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/factor.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="factor-facet-calibration-for-lofar">
<h1>Factor: Facet Calibration for LOFAR <a class="footnote-reference" href="#f1" id="id1">[1]</a><a class="headerlink" href="#factor-facet-calibration-for-lofar" title="Permalink to this headline">¶</a></h1>
<p>Factor is a Python package that allows for the production of wide-field HBA LOFAR images using the facet calibration scheme described in van Weeren et al. (2016) to correct for direction-dependent effects (DDEs). To initialize your environment for Factor, users on CEP3 should run the following command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">~</span><span class="n">rafferty</span><span class="o">/</span><span class="n">init_factor</span>
</pre></div>
</div>
<p>If you want to install Factor yourself, follow the instructions in the <strong>README.md</strong> file at <a class="reference external" href="https://github.com/lofar-astron/factor">https://github.com/lofar-astron/factor</a>. Detailed documentation for Factor is available at <a class="reference external" href="http://www.astron.nl/citt/facet-doc">http://www.astron.nl/citt/facet-doc</a>.</p>
<div class="section" id="data-preparation-pre-facet-calibration-pipeline">
<h2>Data preparation: Pre-facet calibration pipeline <a class="footnote-reference" href="#f2" id="id2">[2]</a><a class="headerlink" href="#data-preparation-pre-facet-calibration-pipeline" title="Permalink to this headline">¶</a></h2>
<p>The input data to Factor must have the average amplitude scale set and average clock offsets removed. Furthermore, the LOFAR beam towards the phase center should be removed. The data should be concatenated in frequency to bands of about 2 MHz bandwidth (so about 10–12~subbands). All bands (= input measurement sets) need to have the same number of frequency channelsfootnote{Factor does lots of averaging by different amounts to keep the data-size and computing time within limits. If the input files have different numbers of channels then finding valid averaging steps for all files gets problematic.}. Also the number of channels should have many divisors to make averaging to different scales easy. The data should then undergo direction-independent, phase-only self calibration, and the resulting solutions must be provided to Factor.</p>
<p>The pre-facet calibration pipelines are intended to prepare the observed data so that they can be used in Factor. The pipelines are defined as parsets for the genericpipeline, that first calibrate the calibrator, then transfer the gain amplitudes, clock delays and phase offsets to the target data, do a direction-independent phase calibration of the target, and finally image and subtract sources.</p>
<p>Please have a look at the documentation for the genericpipeline at <a class="reference external" href="http://www.astron.nl/citt/genericpipeline/">http://www.astron.nl/citt/genericpipeline/</a>. You should be reasonably familiar with setting up and running a genericpipeline before running this pipeline parset.</p>
<div class="section" id="download-and-set-up">
<h3>Download and set-up<a class="headerlink" href="#download-and-set-up" title="Permalink to this headline">¶</a></h3>
<p>The pipeline parsets and associated scripts can be found at: <a class="reference external" href="https://github.com/lofar-astron/prefactor">https://github.com/lofar-astron/prefactor</a>. These pipelines require as input data that has been pre-processed by the ASTRON averaging pipeline. They can work both with observations that had a second beam on a calibrator and with interleaved observations in which the calibrator was observed just before and after the target. No demixing is done, but A-Team clipping is performed for the target data <a class="footnote-reference" href="#f3" id="id3">[3]</a>.</p>
<p>To run the genericpipeline you need a correctly set up configuration file for the genericpipeline, see <a class="reference external" href="http://www.astron.nl/citt/genericpipeline/#quick-start">http://www.astron.nl/citt/genericpipeline/#quick-start</a>. In addition to the usual settings you need to ensure that the plugin scripts are found, for that you need to add the pre-facet calibration directory to the <strong>recipe_directories</strong> in the pipeline parset (so that the <strong>plugins</strong> directory is a subdirectory of one of the <strong>recipe_directories</strong>).</p>
</div>
<div class="section" id="overview-and-examples">
<h3>Overview and examples<a class="headerlink" href="#overview-and-examples" title="Permalink to this headline">¶</a></h3>
<p>The most recent overview of the pre-facet pipeline functionality as well as several use cases and troubleshooting information can be found on the pre-facet pipeline GitHub wiki at: <a class="reference external" href="https://github.com/lofar-astron/prefactor/wiki">https://github.com/lofar-astron/prefactor/wiki</a>.</p>
<p>After the pipeline was run successfully, the resulting measurement sets are moved to the specified directory. The instrument table of the direction-independent, phase-only calibration are inside the measurement sets with the names <strong>instrument_directioninpendent</strong>. These measurement sets are the input to the Initial-Subtract pipeline, which should be run next to do the imaging and source subtraction. Once the Initial-Subtract pipeline has finished, the data are ready to be processed by Factor.</p>
</div>
</div>
<div class="section" id="factor-tutorials">
<h2>Factor tutorials<a class="headerlink" href="#factor-tutorials" title="Permalink to this headline">¶</a></h2>
<p>This section includes examples of setting up and using Factor. Setting up a Factor run mainly involves creating a parset that defines the reduction parameters. For many of these parameters, the default values will work well, and hence their values do not need to be explicitly specified in the parset. Therefore, only the parameters relevant to each example are described below. For a description of all parameters, see <a class="reference external" href="http://www.astron.nl/citt/facet-doc/parset.html">http://www.astron.nl/citt/facet-doc/parset.html</a>.</p>
<div class="section" id="quick-start">
<h3>Quick-start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h3>
<p>Below are the basic steps in a typical Factor run on a single machine (e.g., a single CEP3 node).</p>
<ul>
<li><p class="first">Collect the input bands and Initial-Subtract sky models (produced as described in sub-section ref{factor:pre-facet-pipeline}) in a single directory. The MS names must end in “.MS” or “.ms”:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[/data/factor_input]$ ls
L99090_SB041_uv.dppp_122298A79t_119g.pre-cal.ms
L99090_SB041_uv.dppp_122298A79t_119g.pre-cal.wsclean_low2-model.merge
L99090_SB041_uv.dppp_122298A79t_121g.pre-cal.ms
L99090_SB041_uv.dppp_122298A79t_121g.pre-cal.wsclean_low2-model.merge
L99090_SB041_uv.dppp_122298A79t_123g.pre-cal.ms
L99090_SB041_uv.dppp_122298A79t_123g.pre-cal.wsclean_low2-model.merge
L99090_SB041_uv.dppp_122298A79t_125g.pre-cal.ms
L99090_SB041_uv.dppp_122298A79t_125g.pre-cal.wsclean_low2-model.merge
</pre></div>
</div>
</li>
<li><p class="first">Edit the Factor parset (described in detail at <a class="reference external" href="http://www.astron.nl/citt/facet-doc/parset.html">http://www.astron.nl/citt/facet-doc/parset.html</a>) to fit your reduction and computing resources. For example, the parset for a single machine could be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[/data]$ more factor.parset
[global]
dir_working = /data/factor_output
dir_ms = /data/factor_input

[directions]
flux_min_jy = 0.3
size_max_arcmin = 1.0
separation_max_arcmin = 9.0
max_num = 40
</pre></div>
</div>
</li>
<li><p class="first">Run the reduction:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[/data]$ runfactor factor.parset
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="selecting-the-dde-calibrators-and-facets">
<h3>Selecting the DDE calibrators and facets<a class="headerlink" href="#selecting-the-dde-calibrators-and-facets" title="Permalink to this headline">¶</a></h3>
<p>Before facet calibration can be done, suitable DDE calibrators must be selected. Generally, a suitable calibrator is a bright, compact source (or a group of such sources) <a class="footnote-reference" href="#f4" id="id5">[4]</a>. The DDE calibrators can be provided to Factor in a file (see <a class="reference external" href="http://www.astron.nl/citt/facet-doc/directions.html">http://www.astron.nl/citt/facet-doc/directions.html</a> for details) or can be selected internally. This example shows how to set the parameters needed for internal selection.</p>
<p>Three parameters in the <strong>[directions]</strong> section of the parset are most important for the internal calibrator selection: <strong>flux_min_Jy</strong>, <strong>size_max_arcmin</strong>, and <strong>separation_max_arcmin</strong>. These parameters set the minimum flux density (in the highest-frequency band) and maximum size of the calibrators and the maximum allowed separation that two sources may have to be grouped together as a single calibrator (see <a class="reference external" href="http://www.astron.nl/citt/facet-doc/parset.html">http://www.astron.nl/citt/facet-doc/parset.html</a> for details). The following are good values to use as a starting point:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">directions</span><span class="p">]</span>
<span class="n">flux_min_Jy</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">size_max_arcmin</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">separation_max_arcmin</span> <span class="o">=</span> <span class="mf">9.0</span>
</pre></div>
</div>
<p>It is recommended that you set <strong>interactive = True</strong> under <strong>[global]</strong> while experimenting with the calibrator selection, as Factor will select the calibrators and then pause to allow you to verify them. Now, run Factor (with <strong>runfactor factor.parset</strong>) and once it asks for verification, open one of the <strong>*high2</strong>} images generated during the Initial Subtract pipeline in ds9 or casaviewer. Then load the region files located in the <strong>dir_working/regions/</strong>} directory (where <strong>dir_working</strong> is the working directory defined in your Factor parset). Figure~ref{F:example_field_layout} shows an example of such an image with the regions overlaid.</p>
<div class="figure align-center" id="id8">
<img alt="_images/factor_field_layout_example.png" src="_images/factor_field_layout_example.png" />
<p class="caption"><span class="caption-text">Example of internally generated calibrators and facets. Yellow boxes show the regions to be imaged during self calibration (the inner box shows the region over which sources are added back to the empty datasets) and green regions show the facets. Each direction is labeled twice: once for the calibrator region and once for the facet region. Note the elliptical region that encompasses the faceted area. This region is controlled by the <strong>faceting_radius_deg</strong> parameter under [directions] in the parset: inside this radius (adjusted for the mean primary beam shape), full facets are used; outside this radius, only small patches are used that are much faster to process. This radius can be adjusted to limit the size of the outer facets and the region to be imaged.</span></p>
</div>
<p>Check that none of the calibrator image regions are overlapping significantly. If they are, try adjusting the above parameters to either group the calibrators together (so that they form a single calibrator) or remove one of them. Also check that no facet is larger than a degree or so. If such large facets are present, try adjusting the above parameters to obtain more calibrators (e.g., by lowering <strong>flux_min_Jy</strong>). If the large facets are on the outer edge of the faceted region, you should also consider reducing <strong>faceting_radius_deg</strong> to limit their size.</p>
<p>Once the calibrator and facet selection is acceptable, Factor will make a directions file named <strong>factor_directions.txt</strong> in <strong>dir_working</strong>. This file can now be edited by hand if desired (e.g., to specify a sky model or clean mask for a calibrator).</p>
</div>
<div class="section" id="imaging-a-target-source">
<h3>Imaging a target source<a class="headerlink" href="#imaging-a-target-source" title="Permalink to this headline">¶</a></h3>
<p>If you are interested only in a single target source, you may want to process just the brightest sources in the field and those nearest the target. Figure~ref{F:example_target_layout} shows the layout of an example field, with the target source (a galaxy cluster) indicated by the blue circle in facet_patch_468. Note that the faceting radius has been reduced substantially to speed up processing (since facets outside of this radius are small patches that run much more quickly than full facets). A few facets (e.g., facet_patch_566 and facet_patch_273) contain bright sources with artifacts that affect the target. Additionally, although they contain fainter sources, artifacts from the neighboring facets (e.g., facet_patch_424) can also affect the target significantly. Therefore, a good strategy is to process these facets before processing the target. Note that the lowest possible noise would be obtained by processing the entire field but would require much longer to complete.</p>
<div class="figure align-center" id="id9">
<img alt="_images/factor_target_layout_example.png" src="_images/factor_target_layout_example.png" />
<p class="caption"><span class="caption-text">Example of the field layout for a case in which an image is desired only for a single target source (indicated by the blue circle). A region of avoidance was also specified (with a larger radius than the blue circle) that resulted in the curved bulges to the boundary to the north and south of the target.</span></p>
</div>
<p>We can limit the processing to the sources above by moving them to the top of the directions file (named <strong>dir_working/factor_directions.txt</strong> if generated automatically) and setting <strong>ndir_process</strong> under <strong>[directions]</strong> in the parset to the number of sources we wish to be processed (including the facet with the target source). Note that you should typically have many more calibrators in the directions file than directions to be processed, as the facets shapes and sizes are determined from all calibrators together and too few can result in very large facets. An example directions file is shown below (note that only the first two columns are shown). In this case, the target facet (facet_patch_468) will be the seventh direction to be processed, so we set <strong>ndir_process = 7</strong> under <strong>[directions]</strong> in the parset. Lastly, set <strong>image_target_only = True</strong> under <strong>[imaging]</strong> so that only the target facet is imaged.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># name position ...</span>

<span class="n">facet_patch_566</span> <span class="mi">14</span><span class="n">h29m38</span><span class="o">.</span><span class="mi">5962</span><span class="n">s</span><span class="p">,</span><span class="mi">44</span><span class="n">d59m14</span><span class="o">.</span><span class="mi">0061</span><span class="n">s</span> <span class="o">...</span>
<span class="n">facet_patch_499</span> <span class="mi">14</span><span class="n">h31m36</span><span class="o">.</span><span class="mi">5221</span><span class="n">s</span><span class="p">,</span><span class="mi">44</span><span class="n">d41m39</span><span class="o">.</span><span class="mi">6252</span><span class="n">s</span> <span class="o">...</span>
<span class="n">facet_patch_424</span> <span class="mi">14</span><span class="n">h34m38</span><span class="o">.</span><span class="mi">5876</span><span class="n">s</span><span class="p">,</span><span class="mi">44</span><span class="n">d48m00</span><span class="o">.</span><span class="mi">415</span><span class="n">ss</span> <span class="o">...</span>
<span class="n">facet_patch_379</span> <span class="mi">14</span><span class="n">h36m04</span><span class="o">.</span><span class="mi">2603</span><span class="n">s</span><span class="p">,</span><span class="mi">44</span><span class="n">d45m16</span><span class="o">.</span><span class="mi">2451</span><span class="n">s</span> <span class="o">...</span>
<span class="n">facet_patch_273</span> <span class="mi">14</span><span class="n">h40m14</span><span class="o">.</span><span class="mi">6989</span><span class="n">s</span><span class="p">,</span><span class="mi">45</span><span class="n">d10m53</span><span class="o">.</span><span class="mi">6821</span><span class="n">s</span> <span class="o">...</span>
<span class="n">facet_patch_573</span> <span class="mi">14</span><span class="n">h29m33</span><span class="o">.</span><span class="mi">1473</span><span class="n">s</span><span class="p">,</span><span class="mi">44</span><span class="n">d19m43</span><span class="o">.</span><span class="mi">2515</span><span class="n">s</span> <span class="o">...</span>
<span class="n">facet_patch_468</span> <span class="mi">14</span><span class="n">h32m44</span><span class="o">.</span><span class="mi">3536</span><span class="n">s</span><span class="p">,</span><span class="mi">44</span><span class="n">d20m50</span><span class="o">.</span><span class="mi">7736</span><span class="n">s</span> <span class="o">...</span>
<span class="o">......</span>
<span class="n">facet_patch_550</span> <span class="mi">14</span><span class="n">h30m03</span><span class="o">.</span><span class="mi">9315</span><span class="n">s</span><span class="p">,</span><span class="mi">46</span><span class="n">d51m44</span><span class="o">.</span><span class="mi">6965</span><span class="n">s</span> <span class="o">...</span>
<span class="n">facet_patch_480</span> <span class="mi">14</span><span class="n">h32m28</span><span class="o">.</span><span class="mi">9389</span><span class="n">s</span><span class="p">,</span><span class="mi">45</span><span class="n">d13m49</span><span class="o">.</span><span class="mi">3407</span><span class="n">s</span> <span class="o">...</span>
<span class="n">facet_patch_778</span> <span class="mi">14</span><span class="n">h20m03</span><span class="o">.</span><span class="mi">7803</span><span class="n">s</span><span class="p">,</span><span class="mi">44</span><span class="n">d09m40</span><span class="o">.</span><span class="mi">3293</span><span class="n">s</span> <span class="o">...</span>
</pre></div>
</div>
<p>Additionally, if the target source is diffuse, Factor may not be able to adjust the facet boundaries properly to ensure that it lies entirely within a single facet. To ensure that no facet boundary passes through the target source, you can define the position and the size of an avoidance region under the <strong>[directions]</strong> section of the parset. The <strong>target_ra</strong>, <strong>target_dec</strong>, and <strong>target_radius_arcmin</strong> parameters determine this avoidance region. An example of such a region for the target above is given below and the resulting facets are shown in Figure~ref{F:example_target_layout}. Note that the boundaries of the target facet (facet_patch_468) are curved to avoid this region.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">directions</span><span class="p">]</span>
<span class="n">target_ra</span> <span class="o">=</span> <span class="mi">14</span><span class="n">h31m59</span><span class="o">.</span><span class="mi">7</span><span class="n">s</span>
<span class="n">target_dec</span> <span class="o">=</span> <span class="o">+</span><span class="mi">44</span><span class="n">d15m48s</span>
<span class="n">target_radius_arcmin</span> <span class="o">=</span> <span class="mi">15</span>
</pre></div>
</div>
</div>
<div class="section" id="peeling-bright-sources">
<h3>Peeling bright sources<a class="headerlink" href="#peeling-bright-sources" title="Permalink to this headline">¶</a></h3>
<p>In many observations there will be one or more strong sources that lie far outside the FWHM of the primary beam but nevertheless cause significant artifacts inside it. However, because of strong variations in the beam with frequency at these locations, self calibration does not generally work well. Therefore, Factor includes the option to peel these outlier sources. A high-resolution sky model (in makesourcedb format) is needed for this peeling. Factor includes a number of such sky models for well-known calibrators (see <a class="reference external" href="https://github.com/lofar-astron/factor/tree/master/factor/skymodels">https://github.com/lofar-astron/factor/tree/master/factor/skymodels</a> for a list). If an appropriate sky model is not available inside Factor, you must obtain one and specify it in the directions file. To enable peeling, the <strong>outlier_source</strong> entry in the directions file must be set to <strong>True</strong> for the source.</p>
<p>It is also possible that a strong source (such as 3C295) will lie inside a facet. Such a source can be peeled to avoid dynamic-range limitations. Peeling will be done if a source exceeds <strong>peel_flux_Jy</strong> (set under the <strong>[calibration]</strong> section of the parset) and a sky model is available. After peeling, the facet is then imaged as normal.</p>
</div>
<div class="section" id="checking-the-results-of-a-run">
<h3>Checking the results of a run<a class="headerlink" href="#checking-the-results-of-a-run" title="Permalink to this headline">¶</a></h3>
<p>You can check the progress of a run with the checkfactor script by supplying the Factor parset as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[/data]$ checkfactor factor.parset
</pre></div>
</div>
<p>A plot showing the field layout will be displayed (see Figure~ref{F:checkfactor_example}), with facets colored by their status. Left-click on a facet to see a summary of its state, and press “c” to see a plot of the self calibration images and their clean masks. An example of such a plot is shown in Figure~ref{F:factor_success_example}. For a successful self calibration, you should see a gradual improvement from <strong>image02</strong> to <strong>image42</strong>.</p>
<div class="figure align-center" id="id10">
<img alt="_images/factor_checkfactor_example.png" src="_images/factor_checkfactor_example.png" />
<p class="caption"><span class="caption-text">Example <strong>checkfactor</strong> plot.</span></p>
</div>
<div class="figure align-center" id="id11">
<img alt="_images/factor_success_example.png" src="_images/factor_success_example.png" />
<p class="caption"><span class="caption-text">Example of self calibration images for a successful run. The self calibration process starts with <strong>image02</strong> (the image obtained after applying only the direction-independent solutions from pre-Factor) and proceeds to <strong>image12</strong>, <strong>image22</strong>, etc. In some cases, Factor will iterate a step until no more improvement is seen. These steps are indicated by the “iter” suffix.</span></p>
</div>
<p>If self calibration has completed for a direction, select it and press “t” to see plots of the differential TEC and scalar phase solutions and “g” to see plots of the slow gain solutions. These plots can be useful in identifying periods of bad data or other problems.</p>
</div>
<div class="section" id="dealing-with-failed-self-calibration">
<h3>Dealing with failed self calibration<a class="headerlink" href="#dealing-with-failed-self-calibration" title="Permalink to this headline">¶</a></h3>
<p>Self calibration may occasionally fail to converge for a direction, causing to Factor to skip the subtraction of the corresponding facet model. An example in which self calibration failed is shown in Figure~ref{F:factor_multires_example}. Note how the image noise does not improve much in this case during the self calibration process. While Factor can continue with the processing of other directions and apply the calibration solutions from the nearest successful facet to the failed one (depending on the value of the <strong>exit_on_selfcal_failure</strong> option under <strong>[calibration]</strong> in the parset; see <a class="reference external" href="http://www.astron.nl/citt/facet-doc/parset.html">http://www.astron.nl/citt/facet-doc/parset.html</a> for details), it is generally better to stop Factor and try to correct the problem.  In these cases, turning on multi-resolution self calibration or supplying a custom clean mask may improve the results.</p>
<p>Multi-resolution self calibration involves imaging at decreasing resolutions, from 20 arcsec to full resolution (<span class="math">\(\approx 5\)</span> arcsec). This process can stabilize clean in the presence of calibration errors. An example of such a situation is shown in Figure~ref{F:factor_multires_example}. Multi-resolution self calibration can be enabled by setting <strong>multires_selfcal = True</strong> under <strong>[calibration]</strong> in the parset.</p>
<div class="figure align-center" id="id12">
<img alt="_images/factor_multires_example.png" src="_images/factor_multires_example.png" />
<p class="caption"><span class="caption-text">Example of self calibration images at the same stage of reduction for an unsuccessful run (left) in which an incorrect source structure is present (the bright sources both have “L”-shaped morphologies) and the successful run (right) in which multi-resolution self calibration was used.</span></p>
</div>
<p>In some cases, usually when the calibrator has a complex structure, it may be necessary to supply a clean mask made by hand. Such a clean mask can be made by opening one of the self calibration images (e.g., <strong>*image22.image</strong>; see <a class="reference external" href="http://www.astron.nl/citt/facet-doc/operations.html">http://www.astron.nl/citt/facet-doc/operations.html</a> for details of the <strong>facetselfcal</strong> output) in casaviewer and drawing a region that encloses the source emission but excludes any artifacts. Save the region in CASA format to a file and specify the full path to this file in the <strong>region_selfcal</strong> column of the directions file
(named <strong>dir_working/factor_directions.txt</strong> if generated automatically) for the appropriate direction. Note that the supplied mask must include all significant emission within the self calibration region.</p>
<p>Lastly, it is possible that the DDE calibrator is too faint to produce good self calibration results. In this case, the slow-gain solutions are generally noisy and the images produced after the slow-gain calibration (e.g., <strong>*image32.image</strong>) are worse than those before ((e.g., <strong>*image22.image</strong>). To fix this problem, either process other, brighter facets first (to lower the overall noise) or skip self calibration of the problematic facet.</p>
<p>To restart self calibration for the failed direction, you will need to reset it. See Section~ref{S:resumming_factor} below for instructions on how to reset a direction.</p>
</div>
<div class="section" id="imaging-at-the-end-of-a-run">
<h3>Imaging at the end of a run<a class="headerlink" href="#imaging-at-the-end-of-a-run" title="Permalink to this headline">¶</a></h3>
<p>By default, once self calibration has been completed, Factor will image all facets at full resolution (1.5 arcsec cellsize, robust of -0.25, and no taper). To image the facets with different parameters, set one or more of the following facet parameters in the parset under <strong>[imaging]</strong>: <strong>facet_cellsize_arcsec</strong>, <strong>facet_robust</strong>, <strong>facet_taper_arcsec</strong>, and <strong>facet_min_uv_lambda</strong>. These parameters can be lists, with one set of images for each entry. For example, the following settings will make two images per facet, one at full resolution (1.5 arcsec cellsize, robust of -0.25, and no taper) and one at lower resolution (15 arcsec cellsize, robust of -0.5, and a 45 arcsec taper):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">imaging</span><span class="p">]</span>
<span class="n">facet_cellsize_arcsec</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">]</span>
<span class="n">facet_robust</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]</span>
<span class="n">facet_taper_arcsec</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">]</span>
</pre></div>
</div>
<p>This run will produce two output directories: <strong>dir_working/results/facetimage/</strong> (with the full-resolution images) and <strong>dir_working/results/facetimage_c15.0r-0.5t45.0u0.0/</strong> (with the lower-resolution images).</p>
</div>
<div class="section" id="resuming-and-resetting-a-run">
<h3>Resuming and resetting a run<a class="headerlink" href="#resuming-and-resetting-a-run" title="Permalink to this headline">¶</a></h3>
<p>If a Factor run is interrupted, it can be resumed by simply running it again with the same command. Occasionally, however, you will want to change some settings (e.g., to supply a clean mask for self calibration) or something will go wrong that prevents resumption. In these cases, you can reset the processing for a direction with the “-r” flag to <strong>runfactor</strong>. For example, to reset direction facet_patch_350, the following command should be used:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">runfactor</span> <span class="n">factor</span><span class="o">.</span><span class="n">parset</span> <span class="o">-</span><span class="n">r</span> <span class="n">facet_patch_350</span>
</pre></div>
</div>
</div>
<div class="section" id="finding-the-final-output-products">
<h3>Finding the final output products<a class="headerlink" href="#finding-the-final-output-products" title="Permalink to this headline">¶</a></h3>
<p>Usually, the final, primary-beam-corrected image of the field or target will be located in <strong>dir_working/results/fieldmosaic/field</strong> and will be called <strong>*correct_mosaic.pbcor.fits</strong>. A full description of the primary output products generated by Factor is available at <a class="reference external" href="http://www.astron.nl/citt/facet-doc/products.html">http://www.astron.nl/citt/facet-doc/products.html</a>.</p>
<p>Additionally, it may be desirable to image a facet by hand using the calibrated data (e.g., to ensure that any diffuse emission is properly cleaned). To do so, one can use <strong>archivefactor</strong> (see Section~ref{S:archiving_factor}) to archive the calibrated data for a facet in a convenient form for use in CASA or WSClean. Note that these data have not been corrected for any primary beam attenuation but have had the beam effects at the field phase center removed.</p>
</div>
<div class="section" id="archiving-a-factor-run">
<h3>Archiving a Factor run<a class="headerlink" href="#archiving-a-factor-run" title="Permalink to this headline">¶</a></h3>
<p>A Factor run can be archived at any point with <strong>archivefactor</strong>. For example, the following will produce a minimal archive (including images and plots, but no visibility data):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">archivefactor</span> <span class="n">factor</span><span class="o">.</span><span class="n">parset</span> <span class="n">dir_output</span>
</pre></div>
</div>
<p>To include the calibrated visibility data for one of more facets in the archive, add the “-d” flag followed by the names of the facets:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">archivefactor</span> <span class="n">factor</span><span class="o">.</span><span class="n">parset</span> <span class="n">dir_output</span> <span class="o">-</span><span class="n">d</span> <span class="n">facet_patch_468</span><span class="p">,</span><span class="n">facet_patch_350</span>
</pre></div>
</div>
<p>Lastly, to make an archive from which a Factor run can later be resumed, use the “-r” flag:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">archivefactor</span> <span class="n">factor</span><span class="o">.</span><span class="n">parset</span> <span class="n">dir_output</span> <span class="o">-</span><span class="n">r</span>
</pre></div>
</div>
<p>To resume from such an archive, use <strong>unarchivefactor</strong>. See <a class="reference external" href="http://www.astron.nl/citt/facet-doc/archiving.html">http://www.astron.nl/citt/facet-doc/archiving.html</a> for details.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>This chapter is maintained by David Rafferty(<strong>drafferty&#64;hs.uni-hamburg.de</strong>).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>This section was written by Andreas Horneffer (<strong>ahorneffer&#64;mpifr-bonn.mpg.de</strong>) with a lot of help from Tim Shimwell.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>Versions of the pipeline (parset) which also do demixing are being planned.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td>Ideally calibrators should be selected that provide roughly uniform coverage of the field with separations less than the typical distance over which the direction-dependent effects vary strongly (this distance depends on the severity of the ionospheric conditions, but is usually less than a degree or so). However, the achievable uniformity of coverage will vary from field to field, depending on the specific distribution of sources.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorial.html" class="btn btn-neutral float-right" title="Practical examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sourcedetection.html" class="btn btn-neutral" title="Source detection and sky model manipulation: PyBDSF and LSMTool" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Sarrvesh Sridhar.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>
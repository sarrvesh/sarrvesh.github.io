

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LoSoTo: LOFAR Solution Tool &mdash; LOFAR Imaging Cookbook 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="LOFAR Imaging Cookbook 0.0.1 documentation" href="index.html"/>
        <link rel="next" title="The WSClean Imager" href="wsclean.html"/>
        <link rel="prev" title="Gain calibration with DPPP" href="dpppcalibrate.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> LOFAR Imaging Cookbook
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Getting started </a></li>
<li class="toctree-l1"><a class="reference internal" href="datainspection.html">Data inspection </a></li>
<li class="toctree-l1"><a class="reference internal" href="aoflagger.html">AOFlagger </a></li>
<li class="toctree-l1"><a class="reference internal" href="dppp.html">The Default Pre-Processing Pipeline (DPPP) </a></li>
<li class="toctree-l1"><a class="reference internal" href="dpppcalibrate.html">Gain calibration with DPPP </a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">LoSoTo: LOFAR Solution Tool </a><ul>
<li class="toctree-l2"><a class="reference internal" href="#h5parm">H5parm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hdf5-format">HDF5 format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#characteristics-of-the-h5parm">Characteristics of the H5parm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-of-h5parm-content">Example of H5parm content</a></li>
<li class="toctree-l3"><a class="reference internal" href="#h5parm-benchmarks">H5parm benchmarks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#losoto">LoSoTo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tools">Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operations">Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#losoto-parset">LoSoTo parset</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#developing-in-losoto">Developing in LoSoTo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#clock-tec-separation">Clock/TEC separation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="wsclean.html">The WSClean Imager </a></li>
<li class="toctree-l1"><a class="reference internal" href="sourcedetection.html">Source detection and sky model manipulation: PyBDSF and LSMTool </a></li>
<li class="toctree-l1"><a class="reference internal" href="factor.html">Factor: Facet Calibration for LOFAR </a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Practical examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Useful resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="bbs.html">Black-Board Selfcal (BBS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="shapelets.html">Sky Model Construction Using Shapelets </a></li>
<li class="toctree-l1"><a class="reference internal" href="sagecal.html">SAGECAL </a></li>
<li class="toctree-l1"><a class="reference internal" href="awimager.html">The AW Imager </a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LOFAR Imaging Cookbook</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>LoSoTo: LOFAR Solution Tool </li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/losoto.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="losoto-lofar-solution-tool">
<h1>LoSoTo: LOFAR Solution Tool <a class="footnote-reference" href="#f1" id="id1">[1]</a><a class="headerlink" href="#losoto-lofar-solution-tool" title="Permalink to this headline">¶</a></h1>
<p>The LOFAR Solution Tool is a Python package which handles LOFAR solutions in a variety of ways. The data files used by LoSoTo are not in the standard parmdb format used by BBS/NDPPP (e.g. the “instrument” table). LoSoTo uses instead an innovative data file, called H5parm, which is based on the HDF5 standard <a class="footnote-reference" href="#f2" id="id2">[2]</a>.</p>
<p>LoSoTo can be accessed on CEP3 by</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">losoto</span>
</pre></div>
</div>
<div class="section" id="h5parm">
<h2>H5parm<a class="headerlink" href="#h5parm" title="Permalink to this headline">¶</a></h2>
<p>H5parm is simply a list of rules which specify how data are stored inside the tables of an HDF5 compliant file. We can say that H5parm relates to HDF5 in the same way that parmdb relates to MeasurementSet. The major advantage of using HDF5 is that it is an opensource project developed by a large community of people. It has therefore a very easy-to-use Python interface (the <strong>pytables</strong> module) and it has better performance than competitors.</p>
<div class="section" id="hdf5-format">
<h3>HDF5 format<a class="headerlink" href="#hdf5-format" title="Permalink to this headline">¶</a></h3>
<p>There are three different types of nodes used in H5parm:</p>
<ul class="simple">
<li><strong>Array</strong>: all elements are of the same type.</li>
<li><strong>CArray</strong>: like Arrays, but here the data are stored in chunks, which allows easy access to slices of huge arrays, without loading all data in memory. These arrays can be much larger than the physically available memory, as long as there is enough disk space.</li>
<li><strong>Tables</strong>: each row has the same fields/columns, but the type of the columns can be different within each other. It is a database-like structure.</li>
</ul>
<p>The use of tables to create a database-like structure was investigated and found to be not satisfactory in terms of performance. Therefore LoSoTo is now based on CArrays organized in a hierarchical fashion which provides enough flexibility but preserves performance.</p>
</div>
<div class="section" id="characteristics-of-the-h5parm">
<h3>Characteristics of the H5parm<a class="headerlink" href="#characteristics-of-the-h5parm" title="Permalink to this headline">¶</a></h3>
<p>H5parm is organized in a hierarchical way, where solutions of multiple datasets can be stored in the same H5parm (e.g. the calibrator and the target field solutions of the same observation) into different <strong>solution-sets</strong> (solset). Each solset can be thought as a container for a logically related group of solutions. Although its definition is arbitrary, usually there is one solset for each beam and for each scan. Each solset can have a custom name or by default it is called sol### (where ### is an increasing integer starting from 000).</p>
<p>Each solset contains an arbitrary number of <strong>solution-tables</strong> (soltab) plus a couple of Tables with some information on antenna locations and pointing directions. Soltabs also can have an arbitrary name. If no name is provided, then it is by default set to the solution-type name (amplitudes, phases, clock, tec…) plus again an increasing integer (e.g. amplitudes000, phase000…). Since soltab names are arbitrary the proper solution-type is stated in the <strong>parmdb_type</strong> attribute of the soltab node. Supported values are: amplitude, phase, scalarphase, rotation, clock, tec, tecscreen and phase_offset.</p>
<p>Soltabs are also just containers; inside each soltab there are several CArrays which are the real data holders. Typically there are a number of 1-dimensional CArrays storing the <strong>axes</strong> values (see Table~ref{losoto:tab:axes}) and two $n$-dimensional (where <span class="math">\(n\)</span> is the number of axes) CArrays, “values” and “weights”, which contain the solution values and the relative weights.</p>
<p>Soltabs can have an arbitrary number of axes of whatever type. Here we list some examples:</p>
<ul class="simple">
<li><strong>amplitudes</strong>: time, freq, pol, dir, ant</li>
<li><strong>phases</strong>: time, freq, pol, dir, ant</li>
<li><strong>clock</strong>: time, ant, [pol]</li>
<li><strong>tec</strong>: time, ant, dir, [pol]</li>
<li><strong>foobar</strong>: foo, bar…</li>
</ul>
<p>Theoretically the values/weights arrays can be only partially populated, leaving NaNs (with 0 weight) in the gaps. This allows to have e.g. different time resolution in the core stations and in the remote stations (obviously this ends up in an increment of the data size). Moreover, solution intervals do not have to be equally spaced along any axis (e.g. when one has solutions on frequencies that are not uniformly distributed across the band). The attribute <em>axes</em> of the “values” CArrays states the axes names and, more important, their order.</p>
<table border="1" class="docutils" id="id7">
<caption><span class="caption-text">Default names and formats for axes values.</span><a class="headerlink" href="#id7" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Axis name</th>
<th class="head">Format</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>time (s)</td>
<td>float64</td>
<td>[4.867e+09, 4.868e+09, 4.869e+09]</td>
</tr>
<tr class="row-odd"><td>freq (Hz)</td>
<td>float64</td>
<td>[120e6,122e6,130e6…]</td>
</tr>
<tr class="row-even"><td>ant</td>
<td>string</td>
<td>[CS001LBA]</td>
</tr>
<tr class="row-odd"><td>pol</td>
<td>string (2 char)</td>
<td>[?XX?, ?XY?, ?RR?, ?RL?]</td>
</tr>
<tr class="row-even"><td>dir</td>
<td>string (16 char)</td>
<td>[?3C196?,?pointing?]</td>
</tr>
<tr class="row-odd"><td>val</td>
<td>float64</td>
<td>[34.543,5345.423,123.3213]</td>
</tr>
<tr class="row-even"><td>weight (0 = flagged)</td>
<td>float32 [from 0 or 1]</td>
<td>[0,1,0.9,0.7,1,0]</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="example-of-h5parm-content">
<h3>Example of H5parm content<a class="headerlink" href="#example-of-h5parm-content" title="Permalink to this headline">¶</a></h3>
<p>Here is an example of the content of an H5parm file having a single solset (sol000) containing a single soltab (amplitude000).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># this is the solset</span>
<span class="o">/</span><span class="n">sol000</span> <span class="p">(</span><span class="n">Group</span><span class="p">)</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># this is the antenna Table</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">antenna</span> <span class="p">(</span><span class="n">Table</span><span class="p">(</span><span class="mi">36</span><span class="p">,),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;Antenna names and positions&#39;</span>
 <span class="n">description</span> <span class="p">:</span><span class="o">=</span> <span class="p">{</span>
 <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">StringCol</span><span class="p">(</span><span class="n">itemsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
 <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">Float32Col</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">dflt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;little&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">2340</span><span class="p">,)</span>

<span class="c1"># this is the source Table</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">source</span> <span class="p">(</span><span class="n">Table</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;Source names and directions&#39;</span>
 <span class="n">description</span> <span class="p">:</span><span class="o">=</span> <span class="p">{</span>
 <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">StringCol</span><span class="p">(</span><span class="n">itemsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
 <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="n">Float32Col</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">dflt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;little&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">2730</span><span class="p">,)</span>

<span class="c1"># this is the soltab</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span> <span class="p">(</span><span class="n">Group</span><span class="p">)</span> <span class="s1">&#39;amplitude&#39;</span>

<span class="c1"># this is the antenna axis, with all antenna names</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span><span class="o">/</span><span class="n">ant</span> <span class="p">(</span><span class="n">CArray</span><span class="p">(</span><span class="mi">36</span><span class="p">,),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;&#39;</span>
 <span class="n">atom</span> <span class="p">:</span><span class="o">=</span> <span class="n">StringAtom</span><span class="p">(</span><span class="n">itemsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
 <span class="n">maindim</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
 <span class="n">flavor</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;irrelevant&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,)</span>

<span class="c1"># direction axis, with all directions</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span><span class="o">/</span><span class="nb">dir</span> <span class="p">(</span><span class="n">CArray</span><span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;&#39;</span>
 <span class="n">atom</span> <span class="p">:</span><span class="o">=</span> <span class="n">StringAtom</span><span class="p">(</span><span class="n">itemsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
 <span class="n">maindim</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
 <span class="n">flavor</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;irrelevant&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>

<span class="c1"># frequency axis, with all the frequency values</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span><span class="o">/</span><span class="n">freq</span> <span class="p">(</span><span class="n">CArray</span><span class="p">(</span><span class="mi">5</span><span class="p">,),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;&#39;</span>
 <span class="n">atom</span> <span class="p">:</span><span class="o">=</span> <span class="n">Float64Atom</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
 <span class="n">maindim</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
 <span class="n">flavor</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;little&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,)</span>

<span class="c1"># polarization axis</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span><span class="o">/</span><span class="n">pol</span> <span class="p">(</span><span class="n">CArray</span><span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;&#39;</span>
 <span class="n">atom</span> <span class="p">:</span><span class="o">=</span> <span class="n">StringAtom</span><span class="p">(</span><span class="n">itemsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
 <span class="n">maindim</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
 <span class="n">flavor</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;irrelevant&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>

<span class="c1"># time axis</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span><span class="o">/</span><span class="n">time</span> <span class="p">(</span><span class="n">CArray</span><span class="p">(</span><span class="mi">4314</span><span class="p">,),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;&#39;</span>
 <span class="n">atom</span> <span class="p">:</span><span class="o">=</span> <span class="n">Float64Atom</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
 <span class="n">maindim</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
 <span class="n">flavor</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;little&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">4314</span><span class="p">,)</span>

<span class="c1"># this is the CArray with the solutions, note that its shape is the product of all axes</span>
<span class="n">shapes</span> <span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span><span class="o">/</span><span class="n">val</span> <span class="p">(</span><span class="n">CArray</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4314</span><span class="p">),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;&#39;</span>
 <span class="n">atom</span> <span class="p">:</span><span class="o">=</span> <span class="n">Float64Atom</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
 <span class="n">maindim</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
 <span class="n">flavor</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;little&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1079</span><span class="p">)</span>

<span class="c1"># weight CArray, same shape of the &quot;val&quot; array</span>
<span class="o">/</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span><span class="o">/</span><span class="n">weight</span> <span class="p">(</span><span class="n">CArray</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4314</span><span class="p">),</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">lzo</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="s1">&#39;&#39;</span>
 <span class="n">atom</span> <span class="p">:</span><span class="o">=</span> <span class="n">Float64Atom</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dflt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
 <span class="n">maindim</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
 <span class="n">flavor</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
 <span class="n">byteorder</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;little&#39;</span>
 <span class="n">chunkshape</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1079</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="h5parm-benchmarks">
<h3>H5parm benchmarks<a class="headerlink" href="#h5parm-benchmarks" title="Permalink to this headline">¶</a></h3>
<p>For a typical single-SB parmdb of 37 MB the relative H5parm is around 5 MB large. A typical H5parm for an 8 hrs observation using 244 SBs is <span class="math">\(\sim 3\)</span> GB (LBA) and <span class="math">\(\sim 5\)</span> GB (HBA). Reading times between compressed and non-compressed H5parms are comparable within a factor of 2 (compressed is slower). Compared to parmdb the reading time of the python implementation of H5parm (mid-compression) is a factor of a few (2 to 10) faster.</p>
<p>This is a benchmark example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span> <span class="n">H5parm</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">L99289</span><span class="o">-</span><span class="n">cal_SB081</span><span class="o">.</span><span class="n">h5</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">parmdb</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">L99289</span><span class="o">-</span><span class="n">cal_SB081</span><span class="o">.</span><span class="n">MS</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span>
<span class="n">INFO</span><span class="p">:</span> <span class="c1">### Read all frequencies for a pol/dir/station</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">PARMDB</span> <span class="o">--</span> <span class="mf">1.9</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">H5parm</span> <span class="o">--</span> <span class="mf">0.28</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="c1">### Read all times for a pol/dir/station</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">PARMDB</span> <span class="o">--</span> <span class="mf">1.85</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">H5parm</span> <span class="o">--</span> <span class="mf">0.28</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="c1">### Read all rotations for 1 station (slice in time)</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">PARMDB</span> <span class="o">--</span> <span class="mf">1.94</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">H5parm</span> <span class="o">--</span> <span class="mf">0.3</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="c1">### Read all rotations for all station (slice in time)</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">PARMDB</span> <span class="o">--</span> <span class="mf">8.05</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">H5parm</span> <span class="o">--</span> <span class="mf">0.26</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="c1">### Read all rotations for remote stations (slice in ant)</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">PARMDB</span> <span class="o">--</span> <span class="mf">3.81</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">H5parm</span> <span class="o">--</span> <span class="mf">1.65</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="c1">### Read all rotations for a dir/station and write them back</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">PARMDB</span> <span class="o">--</span> <span class="mf">2.01</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">H5parm</span> <span class="o">--</span> <span class="mf">0.47</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="c1">### Read and tabulate the whole file</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">parmdb</span> <span class="o">--</span> <span class="mf">0.67</span> <span class="n">s</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">H5parm</span> <span class="o">--</span> <span class="mf">0.02</span> <span class="n">s</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="losoto">
<h2>LoSoTo<a class="headerlink" href="#losoto" title="Permalink to this headline">¶</a></h2>
<p>LoSoTo is made by several components. It has some tools used mostly to transform parmdb to H5parm and back (see Sec.~ref{losoto:tools}). A separate program (<strong>losoto.py</strong>) is instead used to perform operations on the specified H5parm. The script <strong>losoto.py</strong> receives its commands by reading a parset file that has the same syntax of BBS/NDPPP parsets (see Sec.ref{losoto:parset}).</p>
<div class="section" id="tools">
<h3>Tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h3>
<p>There are currently four tools shipped with LoSoTo:</p>
<ul class="simple">
<li><strong>parmdb_benchmark.py</strong> provides a comparison between parmdb and H5parm for reading/writing</li>
<li><strong>parmdb_collector.py</strong> fetches parmdb tables from the cluster using a gds file</li>
<li><strong>H5parm_importer.py</strong> creates an h5parm file from an instrument table (parmdb) or a globaldb created by hand or with <strong>parmdb_collector.py</strong></li>
<li><strong>H5parm_merge.py</strong> copies a solset from an H5parm files into another one</li>
<li><strong>H5parm_exporter.py</strong> exports an H5parm to a pre-existing parmdb</li>
</ul>
<p>The usage of these tools is described in Sec.~ref{losoto:usage}.</p>
</div>
<div class="section" id="operations">
<h3>Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h3>
<p>These are the operations that LoSoTo can perform:</p>
<ul class="simple">
<li><strong>ABS</strong>: takes the absolute value of the solutions (probably most meaningful for amplitudes).</li>
<li><strong>CLIP</strong>: clip all solutions $n$ times above and <span class="math">\(1/n\)</span> times below the median value (only for amplitudes).</li>
<li><strong>CLOCKTEC</strong>: perform clock/tec separation (code maintained by Maaijke Mevius).</li>
<li><strong>DUPLICATE</strong>: duplicate a solution table.</li>
<li><strong>FARADAY</strong>: extract Faraday rotation solutions from the difference between RR and LL phase solutions.</li>
<li><strong>FLAG</strong>: iteratively remove a general trend from the solutions and then perform noisy region detection and outlier rejection. For phases this is done in real/imaginary space, for amplitude in log space.</li>
<li><strong>FLAGEXTEND</strong>: flag a point if surrounded by enough other flags in a chosen N-dimensional space</li>
<li><strong>INTERP</strong>: interpolate solutions along whatever (even multiple) axis. Typically one can interpolate in time and/or frequency. This operation can also simply rescale the solutions to match the median of the calibrator solution on a specific axis.</li>
<li><strong>NORM</strong>: normalize solutions of an axis to have a chosen average value.</li>
<li><strong>PLOT</strong>: plot solutions in 1D/2D plots.</li>
<li><strong>PLOTTECSCREEN</strong>: plot TEC screen (code maintained by David Rafferty).</li>
<li><strong>RESET</strong>: reset the solution values to 1 for all kind of solutions but for phases which are set to 0.</li>
<li><strong>RESIDUAL</strong>: subtract a table from another (e.g. remove TEC from phases).</li>
<li><strong>REWEIGHT</strong>: manually set weights to a specific values (can be used to hand-flag data, e.g. a bad antenna/timerange).</li>
<li><strong>SMOOTH</strong>: smooth solutions using a multidimensional running median. The n-dimensional surface generated by multiple axis (e.g. time and freq) can be smoothed in one operation using a different FWHM for each axis.</li>
<li><strong>TECFIT</strong>: fit TEC values per direction and station to phase solutions (code maintained by David Rafferty).</li>
<li><strong>TECSCREEN</strong>: fit TEC screens to TEC values (code maintained by David Rafferty).</li>
<li><strong>EXAMPLE</strong>: this is just an example operation aimed to help developing of new operations.</li>
</ul>
<div class="figure align-center" id="id8">
<img alt="_images/solph.png" src="_images/solph.png" />
<p class="caption"><span class="caption-text">Example phase solutions plotted using PLOT operation after the FLAG operation. White pixels are flagged data, every plot is an antenna, X-axis is time and Y-axis is frequency.</span></p>
</div>
<div class="figure align-center" id="id9">
<img alt="_images/solamp.png" src="_images/solamp.png" />
<p class="caption"><span class="caption-text">Example amplitude solutions plotted using PLOT operation after the FLAG operation. White pixels are flagged data, every plot is an antenna, X-axis is time and Y-axis is frequency.</span></p>
</div>
<p>Beside these operations which require the activation through a LoSoTo parset file (see Sec.~ref{losoto:parset}), one can call <strong>losoto.py</strong> with the “-i” option passing an H5parm as argument to obtain some information on it. Information on a specific subset of solsets can be obtained with “-i -f solset_name(s)”. If “-i” is combined with “-v” (verbose), LoSoTo will take a bit more time and outputs also the percentage of flagged data and the values of all axes will be written in a file (e.g. file.h5-axes_values.txt). Using the “-d” options instead one can delete a chosen soltab (e.g. “losoto.py -d sol000/phase000 file.h5”).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ losoto.py -i -v single.h5
WARNING: Axes values saved in single.h5-axes_values.txt

Summary of single.h5

Solution set &#39;sol000&#39;:
======================

Directions: 3C196
            pointing

Stations: CS001LBA   CS002LBA   CS003LBA   CS004LBA
          CS005LBA   CS006LBA   CS007LBA   CS011LBA
          CS017LBA   CS021LBA   CS024LBA   CS026LBA
          CS028LBA   CS030LBA   CS031LBA   CS032LBA
          CS101LBA   CS103LBA   CS201LBA   CS301LBA
          CS302LBA   CS401LBA   CS501LBA   RS106LBA
          RS205LBA   RS208LBA   RS305LBA   RS306LBA
          RS307LBA   RS310LBA   RS406LBA   RS407LBA
          RS409LBA   RS503LBA   RS508LBA   RS509LBA

Solution table &#39;amplitude000&#39; (type: amplitude): 2 pols, 2 dirs, 36 ants, 5 freqs,
4314 times
Flagged data 1.131%

   History:
   2014-12-17 13:29:25: CREATE (by H5parm_importer.py from
                        lof011:/home/fdg/scripts/losoto/examples/single.globaldb)

Solution table &#39;rotation000&#39; (type: rotation): 2 dirs, 36 ants, 5 freqs, 4314 times
Flagged data 1.131%

   History:
   2014-12-17 13:29:25: CREATE (by H5parm_importer.py from
                        lof011:/home/fdg/scripts/losoto/examples/single.globaldb)

Solution table &#39;phase000&#39; (type: phase): 2 pols, 2 dirs, 36 ants, 5 freqs, 4314 times
Flagged data 1.131%

   History:
   2014-12-17 13:29:25: CREATE (by H5parm_importer.py from
                        lof011:/home/fdg/scripts/losoto/examples/single.globaldb)
</pre></div>
</div>
</div>
<div class="section" id="losoto-parset">
<h3>LoSoTo parset<a class="headerlink" href="#losoto-parset" title="Permalink to this headline">¶</a></h3>
<p>This is an example parset for the interpolation in amplitude:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">interp</span><span class="p">]</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Solset</span> <span class="o">=</span> <span class="p">[</span><span class="n">sol000</span><span class="p">]</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Soltab</span> <span class="o">=</span> <span class="p">[</span><span class="n">sol000</span><span class="o">/</span><span class="n">amplitude000</span><span class="p">]</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">SolType</span> <span class="o">=</span> <span class="p">[</span><span class="n">amplitude</span><span class="p">]</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">ant</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">pol</span> <span class="o">=</span> <span class="p">[</span><span class="n">XX</span><span class="p">,</span><span class="n">YY</span><span class="p">]</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">INTERP</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">InterpAxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">freq</span><span class="p">,</span> <span class="n">time</span><span class="p">]</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">InterpMethod</span> <span class="o">=</span> <span class="n">nearest</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">MedAxes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">Rescale</span> <span class="o">=</span> <span class="n">F</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">CalSoltab</span> <span class="o">=</span> <span class="n">cal000</span><span class="o">/</span><span class="n">amplitude000</span>
<span class="n">LoSoTo</span><span class="o">.</span><span class="n">Steps</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">CalDir</span> <span class="o">=</span> <span class="mi">3</span><span class="n">C295</span>
</pre></div>
</div>
<p>In the first part of the parset “global” values are defined. These are values named LoSoTo.val_name. In Table~ref{losoto:tab:global_val} the reader can find all the possible global values.</p>
<table border="1" class="docutils" id="id10">
<caption><span class="caption-text">Definition of global variables in LoSoTo parset.</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Variable name</th>
<th class="head">Format</th>
<th class="head">Example</th>
<th class="head">Comment</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>LoSoTo.Steps</td>
<td>list of steps</td>
<td>[flag, plot, smoothPhases, plot2]</td>
<td>sequence of steps names in order</td>
</tr>
<tr class="row-odd"><td>LoSoTo.Solset</td>
<td>list of solset names</td>
<td>[sol000, sol001]</td>
<td>restrict to these solsets</td>
</tr>
<tr class="row-even"><td>LoSoTo.Soltab</td>
<td>list of soltabs: Solset/soltab</td>
<td>[sol000/amplitude000]</td>
<td>restrict to these soltabs</td>
</tr>
<tr class="row-odd"><td>LoSoTo.SolType</td>
<td>list of solution types</td>
<td>[phase]</td>
<td>restrict to soltab of this solution type</td>
</tr>
<tr class="row-even"><td>LoSoTo.ant</td>
<td>antenna names</td>
<td>[CS001_HBA]</td>
<td>restrict to these antenna</td>
</tr>
<tr class="row-odd"><td>LoSoTo.pol</td>
<td>polarization</td>
<td>[XX, YY]</td>
<td>restrict to these polarizations</td>
</tr>
<tr class="row-even"><td>LoSoTo.dir <a class="footnote-reference" href="#f4" id="id3">[4]</a></td>
<td>directions</td>
<td>[pointing, 3C196]</td>
<td>restrict to these pointing directions</td>
</tr>
<tr class="row-odd"><td>LoSoTo.freq</td>
<td>frequencies</td>
<td>[30076599.12109375]</td>
<td>restrict to these frequencies</td>
</tr>
<tr class="row-even"><td>LoSoTo.time</td>
<td>times</td>
<td>[123456789.1234]</td>
<td>restrict to these times</td>
</tr>
<tr class="row-odd"><td>LoSoTo.Ncpu <a class="footnote-reference" href="#f5" id="id4">[5]</a></td>
<td>integer</td>
<td>10</td>
<td>number of processes of spawn</td>
</tr>
</tbody>
</table>
<p>For every stepname mentioned in the global “steps” variable the user can specify step-specific parameters using the syntax: LoSoTo.Steps.stepname.val_name. At least one of these options must always be present, which is the “Operation” option that specifies which kind of operation is performed by that step among those listed in Sec.~ref{losoto:operations}. All the global variables (except from the “steps” one) are also usable inside a step to change (override) the selection criteria for that specific step. Selection can be a string (interpreted as a regular expression), a list of values (exact match) or can have a min/max/step value which is activated using the axisName.minmax sintax (e.g. LoSoTo.freq.minmax = [30e6,1e9,5] to select 1 point every 5 from 30 MHz to 1 GHz). A list of step-specific parameters is given in <a class="reference external" href="https://github.com/revoltek/losoto">https://github.com/revoltek/losoto</a>.</p>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>This following is a possible sequence of commands to run LoSoTo on a typical observation:</p>
<ul>
<li><p class="first">Collect the parmdb of calibrator and target:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">parmdb_collector</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">d</span> <span class="s2">&quot;target.gds&quot;</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;clusterdesc&quot;</span> <span class="o">-</span><span class="n">g</span> <span class="n">globaldb_tgt</span>
<span class="n">parmdb_collector</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">d</span> <span class="s2">&quot;calibrator.gds&quot;</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;clusterdesc&quot;</span> <span class="o">-</span><span class="n">g</span> <span class="n">globaldb_cal</span>
</pre></div>
</div>
</li>
</ul>
<p>where “[target/calibrator].gds” is the gds file (made with combinevds) of all the SB you want to use. You need to run the collector once for the calibrator and once for the target. “Clusterdesc” is a cluster description file as the one used for BBS (not stand-alone).</p>
<p>One can create the globaldb also by hand. Just create a directory, copy all the instrument (parmdb) tables you need calling them: instrument-1, instrument-2, and so on. Then copy from one of the MS (they are all the same) the ANTENNA, FIELD and sky tables. This directory is now a valid globaldb.</p>
<ul>
<li><p class="first">Convert the set of parmdbs into an h5parm</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">H5parm_importer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">tgt</span><span class="o">.</span><span class="n">h5</span> <span class="n">globaldb_tgt</span>
<span class="n">H5parm_importer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">cal</span><span class="o">.</span><span class="n">h5</span> <span class="n">globaldb_cal</span>
</pre></div>
</div>
</li>
</ul>
<p>This command converts ALL the instrument tables (parmdb) inside the globaldb directories in a single solset inside tgt.h5.</p>
<p>One can then merge the two h5parms in a single file (this is needed if you want to interpolate/rescale/copy solutions in time/freq from the cal to the target):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">H5parm_merge</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">cal</span><span class="o">.</span><span class="n">h5</span><span class="p">:</span><span class="n">sol000</span> <span class="n">tgt</span><span class="o">.</span><span class="n">h5</span><span class="p">:</span><span class="n">cal000</span>
</pre></div>
</div>
<p>An easier approach is to directly append the second globaldb to the h5parm file of the first (note the same name for the h5parm)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">H5parm_importer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">tgt</span><span class="o">.</span><span class="n">h5</span> <span class="n">globaldb_tgt</span>
<span class="n">H5parm_importer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">tgt</span><span class="o">.</span><span class="n">h5</span> <span class="n">globaldb_cal</span>
</pre></div>
</div>
<p>One can create a h5parm also from a single SB</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">H5parm_importer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">LXXXXX_3c295</span><span class="o">.</span><span class="n">h5</span> <span class="n">LXXXXX_3c295</span><span class="o">.</span><span class="n">MS</span>
</pre></div>
</div>
<p>This command converts the “instrument” (parmdb) table inside the MS in a solset inside LXXXXX_3c295.h5. Note that given the definition of globaldb above, a single-SB measurement set is a perfect valid one.</p>
<ul>
<li><p class="first">Run LoSoTo using e.g. the parset given in Sec.~ref{losoto:parset}:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">losoto</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="n">tgt</span><span class="o">.</span><span class="n">h5</span> <span class="n">losoto</span><span class="o">-</span><span class="n">interp</span><span class="o">.</span><span class="n">parset</span>
</pre></div>
</div>
</li>
<li><p class="first">Convert back the h5parm into parmdb:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">H5parm_exporter</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">c</span> <span class="n">tgt</span><span class="o">.</span><span class="n">h5</span> <span class="n">globaldb_tgt</span>
</pre></div>
</div>
</li>
<li><p class="first">Redistribute back the parmdb tables into globaldb_tgt that are now updated (inspect with parmdbplot), there’s no automatic tool for that yet.</p>
</li>
</ul>
</div>
<div class="section" id="developing-in-losoto">
<h2>Developing in LoSoTo<a class="headerlink" href="#developing-in-losoto" title="Permalink to this headline">¶</a></h2>
<p>LoSoTo is much more than a stand alone program, the user can use LoSoTo to play easily with solutions and to experiment. The code is freely available and is already the result of the collaborative effort of several people. If interested in developing your own operation, please have a look at: <a class="reference external" href="https://github.com/revoltek/losoto/">https://github.com/revoltek/losoto/</a>.</p>
<p>In the “tools” directory the user can find all the tools described in Sec.~ref{losoto:tools} plus some other program. All these programs are stand-alone. <strong>losoto.py</strong> is the main program which calls all the operations (one per file) present in the “operation” directory. It relays on the <strong>h5parm.py</strong> library which deals with reading and writing from an H5parm file and the <strong>operations_lib.py</strong> library which has some functions common to several operations.</p>
<p>An example operation one can use to start coding its own, is present in the “operation” directory under the name <strong>example.py</strong>. That is the first point to start when interested in writing a new operation. The most important thing shown in the example operation is the use of the H5parm library to quickly fetch an write back solutions in the H5parm file.</p>
</div>
<div class="section" id="clock-tec-separation">
<h2>Clock/TEC separation<a class="headerlink" href="#clock-tec-separation" title="Permalink to this headline">¶</a></h2>
<p>In LoSoTo an algorithm is implemented with which it is possible to separate the BBS phase solutions into a instrumental delay (clock) and an ionospheric component (TEC, a measure of the differential ionospheric electron content). This is done using the difference in frequency dependence of both effects: The phase shift due to a delay error goes as <span class="math">\(\nu\)</span>, whereas ionospheric refraction gives to first order an phase shift proportional to <span class="math">\(1/\nu\)</span>. Accordingly, one needs to have solutions over a large enough bandwidth to be able to do the separation <a class="footnote-reference" href="#f3" id="id6">[3]</a>.</p>
<p>There are three situations for which Clock/TEC separation could be useful. The first is if one needs to transfer from a calibrator not only the amplitudes, but also the phase solutions, eg. to be able to combine more sub-bands before doing a phase self-calibration on the target field. Since the ionospheric refraction is a direction dependent effect, in most cases it does not make sense to transfer the ionospheric phases. It is then possible to only apply the clock solutions from the calibrator to the target field. However, one should take note that the delays between stations drift and therefore this method is only useful if calibrator data was taken simultaneously with the target field.</p>
<p>A more experimental case for Clock/TEC separation is the fit of a TECscreen that can be applied during imaging with the AWimager, to correct for the direction dependent ionospheric effects. In this case, it is good to remove the direction independent instrumental effects as good as possible and only use the fitted TEC as input for the TECscreen. This has only been tested in very limited cases.</p>
<p>Finally, the TEC solutions of the clock/TEC separation give insight in the general ionospheric conditions of your observation. This could be of relevance if one wants eg. to estimate the noise due to remaining ionospheric errors.</p>
<p>It is important (especially for LBA) to correct for differential Faraday rotation before attempting to do a clock/TEC separation on the diagonal phases. The most straightforward way to do this, is to solve in BBS for diagonal gains and a common rotation angle.</p>
<p>The Clock/TEC fit as it is implemented in LoSoTo, returns per timeslot and station two arrays, one with clock errors (in s) and one with differential TEC solutions (in  TEC-units). Furthermore a constant (in time) phase offset per station can be estimated. The remaining phase errors (eg. due to cable reflections) are of second order.</p>
<p>It is possible to write the clock solutions to the instrument tables and thus correct for them in BBS.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>This chapter is maintained by Francesco de Gasperin (<strong>astro[at]voo[dot]it</strong>).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://www.hdfgroup.org/HDF5/">http://www.hdfgroup.org/HDF5/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[3]</a></td><td>The exact bandwidth requirements have not been tested yet, but it has been shown that on good S/N (calibrator) HBA data, it is possible to do the clock/TEC separation with 15 solutions, evenly distributed over 60 MHz.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[4]</a></td><td>It is important to notice that the default direction (e.g. those related to BBS solving for anything that is not “directional”:Gain, CommonRotationAngle, CommonScalarPhase, and so on) has the direction named “pointing”.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[5]</a></td><td>Only some operations have been parallelized.</td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="wsclean.html" class="btn btn-neutral float-right" title="The WSClean Imager" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="dpppcalibrate.html" class="btn btn-neutral" title="Gain calibration with DPPP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Sarrvesh Sridhar.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>
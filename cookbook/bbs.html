

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Calibration with BBS &mdash; LOFAR Imaging Cookbook 22.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="LOFAR Imaging Cookbook 22.0.0 documentation" href="index.html"/>
        <link rel="next" title="Sky Model Construction Using Shapelets" href="shapelets.html"/>
        <link rel="prev" title="Acknowledgements" href="acknowledgements.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> LOFAR Imaging Cookbook
          

          
          </a>

          
            
            
              <div class="version">
                22.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Introduction to computing facilities at ASTRON </a></li>
<li class="toctree-l1"><a class="reference internal" href="datainspection.html">Data inspection </a></li>
<li class="toctree-l1"><a class="reference internal" href="aoflagger.html">AOFlagger </a></li>
<li class="toctree-l1"><a class="reference internal" href="dppp.html">The Default Pre-Processing Pipeline (DPPP) </a></li>
<li class="toctree-l1"><a class="reference internal" href="dpppcalibrate.html">Gain calibration with DPPP </a></li>
<li class="toctree-l1"><a class="reference internal" href="losoto.html">LoSoTo: LOFAR Solution Tool </a></li>
<li class="toctree-l1"><a class="reference internal" href="wsclean.html">The WSClean Imager </a></li>
<li class="toctree-l1"><a class="reference internal" href="sourcedetection.html">Source detection and sky model manipulation: PyBDSF and LSMTool </a></li>
<li class="toctree-l1"><a class="reference internal" href="factor.html">Factor: Facet Calibration for LOFAR </a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Useful resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Calibration with BBS </a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#source-catalog">Source catalog</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gaussian-sources">Gaussian sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spectral-index">Spectral index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rotation-measure">Rotation measure</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gsm">GSM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#special-cases">Special cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="#instrument-tables">Instrument tables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#model">Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#beam-model">Beam model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#solver">Solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-reductions">Example reductions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#simulation">Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gain-calibration-direction-independent">Gain calibration (direction-independent)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gain-calibration-direction-dependent-with-source-subtraction">Gain calibration (direction-dependent) with source subtraction</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tweaking-bbs-to-run-faster">Tweaking BBS to run faster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#multithreading">Multithreading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#global-parameter-estimation">Global parameter estimation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-your-environment">Setting up your environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-a-global-solve">Defining a global solve</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pre-computed-visibilities">Pre-computed visibilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inspecting-the-solutions">Inspecting the solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-global-bandpass">The global bandpass</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lba">LBA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hba">HBA</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gain-transfer-from-a-calibrator-to-the-target-source">Gain transfer from a calibrator to the target source </a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-traditional-approach">The “traditional” approach</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-lofar-multi-beam-approach">The LOFAR multi-beam approach</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#post-processing">Post-processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#common-problems">Common problems</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="shapelets.html">Sky Model Construction Using Shapelets </a></li>
<li class="toctree-l1"><a class="reference internal" href="sagecal.html">SAGECAL </a></li>
<li class="toctree-l1"><a class="reference internal" href="awimager.html">The AW Imager </a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Practical examples </a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LOFAR Imaging Cookbook</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Calibration with BBS </li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/bbs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="calibration-with-bbs">
<h1>Calibration with BBS <a class="footnote-reference" href="#f1" id="id1">[1]</a><a class="headerlink" href="#calibration-with-bbs" title="Permalink to this headline">¶</a></h1>
<p>BBS is a software package that was designed for the calibration and simulation of LOFAR data. This section provides a practical guide to reducing LOFAR data with BBS. Do not expect a description of the optimal way to calibrate LOFAR data that works on all possible fields. Much still has to be learned about the reduction of LOFAR data. This chapter should rather be viewed as a written record of the experience gained so far, through the efforts of many commissioners and developers.</p>
<p>NOTE: the most common calibration scenarios can now be performed in DPPP, which is a lot faster (at least 10 times). Please first see if your calibration can be done with DPPP, see <a class="reference external" href="./dpppcalibrate.html">gain calibration with DPPP</a>.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The sky as observed by LOFAR is the “true” sky distorted by characteristics of the instrument (station beam, global bandpass, clock drift, and so on) and the environment (ionosphere). The goal of calibration (and imaging) is to compute an accurate estimate of the “true” sky from the distorted measurements.</p>
<p>The influence of the instrument and the environment on the measured signal can be described by the <strong>measurement equation</strong>. Calibration involves solving the following inverse problem: Given the measured signal (observations) and a parameterized measurement equation (model), find the set of parameter values that minimizes the difference between the model and the observations.</p>
<p>The core functionality of BBS can conceptually be split into two parts. One part concerns the simulation of visibilities given a model. The other part concerns estimating best-fit parameter values given a model and a set of observed visibilities. This is an iterative procedure: A set of simulated visibilities is computed using the current values of the parameters. Then, the values of the parameters are adjusted to minimize the difference between simulated visibilities and observed visibilities, and an updated set of simulated visibilities is computed. This continues in a loop until a convergence criteria is met.</p>
<p>BBS has two modes of running. The first is to run as a stand-alone tool to calibrate one subband. If a single subband does not contain enough signal, BBS offers the possibility to use data from multiple subbands together for parameter estimation. This is called <em>global</em> parameter estimation. In this chapter, we will focus on the stand-alone version; only in section <a class="reference internal" href="#global-parameter-estimation">global parameter estimation</a> we will treat the global solve.</p>
<p>As input, BBS requires an observation (one or more subbands / measurement sets), a <a class="reference internal" href="#source-catalog">source catalog</a>, a table of initial model parameters (see section on <a class="reference internal" href="#instrument-tables">instrument tables</a>), and a configuration file (also called <em>parset</em>, see section <a class="reference internal" href="#example-reductions">example reductions</a>) that specifies the operations that need to be performed on the observation as a whole. As output, BBS produces a processed observation, a table of estimated model parameters, and a bunch of log files.</p>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>To calibrate a single MS, execute the <strong>calibrate-stand-alone</strong> script on the command line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">calibrate</span><span class="o">-</span><span class="n">stand</span><span class="o">-</span><span class="n">alone</span> <span class="o">-</span><span class="n">f</span> <span class="o">&lt;</span><span class="n">MS</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">parset</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">source</span> <span class="n">catalog</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The important arguments provided to the <strong>calibrate-stand-alone</strong> script in this example are:</p>
<ul class="simple">
<li><strong>&lt;MS&gt;</strong>, which is the name of the MS to process.</li>
<li><strong>&lt;parset&gt;</strong>, which defines the reduction (see section <a class="reference internal" href="#example-reductions">example reductions</a>).</li>
<li><strong>&lt;source catalog&gt;</strong>, which defines a list of sources that can be used for calibration (see section <a class="reference internal" href="#source-catalog">source catalog</a>).</li>
<li>The <strong>-f</strong> option, which overwrites stale information (the instrument table and sky model) from previous runs.</li>
</ul>
<p>You can run the script without arguments for a description of all the options and the mandatory arguments, such as the <strong>-v</strong> option to get a more verbose output.</p>
</div>
<div class="section" id="source-catalog">
<span id="sourcecatalog"></span><h2>Source catalog<a class="headerlink" href="#source-catalog" title="Permalink to this headline">¶</a></h2>
<p>The source catalog / sky model defines the sources that can be used (referred to) in the reduction. It is a plain text file that is translated by the <strong>makesourcedb</strong> tool into a form that BBS can use. (Internally, the script converts the catalog file to a sourcedb by running <strong>makesourcedb</strong> on it, before starting BBS.)</p>
<p>A sky model can be created by hand using a text editor. Using tools like <strong>awk</strong> and <strong>sed</strong>, it is relatively straight-forward to convert existing text based catalogs into <strong>makesourcedb</strong> format. Various catalog files created by commissioners have been collected in a <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Cookbook">GitHub repository</a>.</p>
<p>Alternatively, a catalog file in <strong>makesourcedb</strong> format can be created using the <strong>gsm.py</strong> tool. This tool extracts sources in a cone of a given radius around a given position on the sky from the <em>Global Sky Model</em> or GSM. The GSM contains all the sources from the VLSS, NVSS, and WENSS survey catalogs. See section <a class="reference internal" href="#gsm">GSM</a> for more information about the GSM and <strong>gsm.py</strong>.</p>
<p>Below is an example catalog file for 3C196. In this example, 3C196 is modelled as a point source with a flux of 153 Jy and a spectral index of -0.56 with a curvature of -0.05212 at a reference frequency of 55.468 MHz.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># (Name,Type,Ra,Dec,I, ReferenceFrequency=&#39;55.468e6&#39;, SpectralIndex) = format</span>
<span class="mi">3</span><span class="n">C196</span><span class="p">,</span> <span class="n">POINT</span><span class="p">,</span> <span class="mi">08</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">36.062300</span><span class="p">,</span> <span class="o">+</span><span class="mf">48.13</span><span class="o">.</span><span class="mf">02.24900</span><span class="p">,</span> <span class="mf">153.0</span><span class="p">,</span> <span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05212</span><span class="p">]</span>
</pre></div>
</div>
<p>Another example catalog file describes a model for Cygnus~A. It is modelled as two point sources that represent the Eastern and the Western lobe respectively, with a flux ratio of 1:1.25.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># (Name, Type, Ra, Dec, I) = format</span>
<span class="n">CygA</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">POINT</span><span class="p">,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">31.60000</span><span class="p">,</span> <span class="o">+</span><span class="mf">40.43</span><span class="o">.</span><span class="mf">48.3000</span><span class="p">,</span> <span class="mf">1.25</span>
<span class="n">CygA</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">POINT</span><span class="p">,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">25.00000</span><span class="p">,</span> <span class="o">+</span><span class="mf">40.44</span><span class="o">.</span><span class="mf">15.7000</span><span class="p">,</span> <span class="mf">1.0</span>
</pre></div>
</div>
<p>For each source, values should be specified for the fields listed in the header line, in the same order. The only mandatory fields are: <strong>Name</strong>, <strong>Type</strong>, <strong>Ra</strong>, and <strong>Dec</strong>. The declination separators have to be dots, not colons, unless you want the declination to be interpreted as hours (i.e., multiplied by a factor 15).</p>
<p>If a field is left blank (e.g. the <strong>ReferenceFrequency</strong> in the 3C196 example above), the default value specified in the header line is used. If this is not available, then the application defined default value is used instead.</p>
<p>When a catalog contains sources defined by shapelets as well as point sources or Gaussian sources, it is easiest to create two catalog files (one containing the shapelet sources and one containing the rest). Using the <strong>append</strong> option of the <strong>makesourcedb</strong> tool, a single sourcedb containing all the sources can then be created and fed to the <strong>calibrate-stand-alone</strong> script using the <strong>sourcedb</strong> option.</p>
<p>For more information about the recognized fields, default values, and units, please refer to the <strong>makesourcedb</strong> documentation on the <a class="reference external" href="http://www.lofar.org/operations/doku.php?id=public:user_software:documentation:makesourcedb">LOFAR wiki</a>.</p>
<div class="section" id="gaussian-sources">
<h3>Gaussian sources<a class="headerlink" href="#gaussian-sources" title="Permalink to this headline">¶</a></h3>
<p>A Gaussian source can be specified as follows.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># (Name, Type, Ra, Dec, I, Q, U, V, ReferenceFrequency=&#39;60e6&#39;, SpectralIndex=&#39;[0.0]&#39;, MajorAxis, MinorAxis, Orientation) = format</span>
<span class="n">sim_gauss</span><span class="p">,</span> <span class="n">GAUSSIAN</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mf">49.62</span><span class="p">,</span><span class="o">+</span><span class="mf">13.31</span><span class="o">.</span><span class="mf">59.10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,,,,,[</span><span class="o">-</span><span class="mf">0.7</span><span class="p">],</span> <span class="mf">96.3</span><span class="p">,</span> <span class="mf">58.3</span><span class="p">,</span> <span class="mf">62.6</span>
</pre></div>
</div>
<p>Note that the header line beginning with “<strong># (Name, …</strong>” must be a single line, and has been spread over multiple lines here for clarity (indicated by a backslash). There is a known issue about the definition of the <strong>Orientation</strong>: it’s defined relative to the north of some image and not relative to ‘true’ north. This is only relevant if the Gaussian is not symmetric, i.e. the major axis and minor axis differ, and you are transferring a Gaussian model component to another pointing over a large angular distance.</p>
</div>
<div class="section" id="spectral-index">
<h3>Spectral index<a class="headerlink" href="#spectral-index" title="Permalink to this headline">¶</a></h3>
<p>The spectral index used in the source catalog file is defined as follows:</p>
<div class="math">
\[{\rm \log}_{10}(S) = {\rm \log}_{10}(S_{0}) + c_{0} {\rm \log}_{10}\left(\frac{\nu}{\nu_{0}}\right) + c_{1}\left[{\rm \log}_{10}\left(\frac{\nu}{\nu_{0}}\right)\right]^{2} + \ldots + c_{n}\left[{\rm \log}_{10}\left(\frac{\nu}{\nu_{0}}\right)\right]^{n+1}\]</div>
<p>with <span class="math">\(\nu_{0}\)</span> being the reference frequency specified in the <strong>ReferenceFrequency</strong> field, <span class="math">\(c_{0}\)</span> the spectral index, <span class="math">\(c_{1}\)</span> the curvature, and <span class="math">\(c_{2}, \ldots, c_{n}\)</span> the higher order curvature terms. The <strong>SpectralIndex</strong> field should contain a list of coefficients <span class="math">\([c_{0}, \ldots, c_{n}]\)</span>.</p>
</div>
<div class="section" id="rotation-measure">
<h3>Rotation measure<a class="headerlink" href="#rotation-measure" title="Permalink to this headline">¶</a></h3>
<p>For polarized sources, Stokes <span class="math">\(Q\)</span> and <span class="math">\(U\)</span> fluxes can be specified explicitly, or implicitly by specifying the intrinsic rotation measure <span class="math">\(RM\)</span>, the polarization angle <span class="math">\(\chi_{0}\)</span> at <span class="math">\(\lambda = 0\)</span>, and the polarized fraction <span class="math">\(p\)</span>.</p>
<p>In the latter case, Stokes <span class="math">\(Q\)</span> and <span class="math">\(U\)</span> fluxes at a wavelength <span class="math">\(\lambda\)</span> are computed as:</p>
<div class="math">
\begin{eqnarray}
Q(\lambda) &amp;=&amp; p \; I(\lambda) \; \cos(2\chi(\lambda)) \\

U(\lambda) &amp;=&amp; p \; I(\lambda) \; \sin(2\chi(\lambda)) \\

\chi(\lambda) &amp;=&amp; \chi_{0} + RM \; \lambda^{2}
\end{eqnarray}</div><p>Here, <span class="math">\(I(\lambda)\)</span> is the total intensity at wavelength <span class="math">\(\lambda\)</span>, which depends on the spectral index of the source.</p>
<p>The intrinsic rotation measure of a source can be specified by means of the field <strong>RotationMeasure</strong>. The polarization angle <span class="math">\(\chi_{0}\)</span> at <span class="math">\(\lambda = 0\)</span> and the polarized fraction <span class="math">\(p\)</span> can be specified in two ways:</p>
<ul class="simple">
<li>Explicitly by means of the fields <strong>PolarizationAngle</strong> and <strong>PolarizedFraction</strong>.</li>
<li>Implicitly, by means of the fields <strong>Q</strong>, <strong>U</strong>, and <strong>ReferenceWavelength</strong>.</li>
</ul>
<p>When specifying <span class="math">\(Q\)</span> and <span class="math">\(U\)</span> at a reference wavelength <span class="math">\(\lambda_{0}\)</span>, the polarization angle <span class="math">\(\chi_{0}\)</span> at <span class="math">\(\lambda = 0\)</span>, and the polarized fraction <span class="math">\(p\)</span> will be computed as:</p>
<div class="math">
\begin{eqnarray}
\chi_{0} &amp;=&amp; \frac{1}{2}\tan^{-1}(\frac{U}{Q}) - \lambda_{0}^2 \; RM \\

p &amp;=&amp; \frac{\sqrt{(Q^{2} + U^{2})}}{I(\lambda_{0})}
\end{eqnarray}</div><p>Here, <span class="math">\(I(\lambda_{0})\)</span> is the total intensity at reference wavelength <span class="math">\(\lambda_{0}\)</span>, which depends on the spectral index of the source. Note that the reference wavelength <span class="math">\(\lambda_{0}\)</span> must be <span class="math">\(&gt;0\)</span> if the source has a spectral index.</p>
</div>
</div>
<div class="section" id="gsm">
<span id="id2"></span><h2>GSM<a class="headerlink" href="#gsm" title="Permalink to this headline">¶</a></h2>
<p>The <strong>Global Sky Model</strong> or GSM is a database that contains the reported source properties from the VLSS, WENSS and NVSS surveys. The <strong>gsm.py</strong> script can be used to create a catalog file in <strong>makesourcedb</strong> format (see <a class="reference internal" href="#source-catalog">Source catalog</a>) from the information available in the GSM. As such, the <strong>gsm.py</strong> script serves as the interface between the GSM and BBS.</p>
<p>A catalog file created by <strong>gsm.py</strong> contains the VLSS sources that are in the field of view. For every VLSS source, counterparts in the other catalogs are searched and associated depending on criteria described below. Spectral index and higher-order terms are fitted according to equation  in section <a class="reference internal" href="#spectral-index">Spectral index</a>.</p>
<p>On CEP, there is a GSM database instance and is loaded with all the sources and their reported properties from the VLSS, WENSS and NVSS surveys. The WENSS survey is actually split up into two catalogs according to their frequencies: A main (<span class="math">\(\delta \leq 75.8\)</span>, <span class="math">\(\nu=325\)</span> MHz) and a polar (<span class="math">\(\delta \geq 74.5\)</span>, <span class="math">\(\nu=352\)</span> MHz) part. The VLSS and NVSS surveys are taken at 73.8 MHz and 1400 MHz, respectively.</p>
<p>The python wrapper script <strong>gsm.py</strong> can be used to generate a catalog file in <strong>makesourcedb</strong> format and can be run as:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">gsm</span><span class="o">.</span><span class="n">py</span> <span class="n">outfile</span> <span class="n">RA</span> <span class="n">DEC</span> <span class="n">radius</span> <span class="p">[</span><span class="n">vlssFluxCutoff</span> <span class="p">[</span><span class="n">assocTheta</span><span class="p">]]</span>
</pre></div>
</div>
<p>The input arguments are explained in <a class="reference internal" href="#gsmparams"><span class="std std-numref">Table 4</span></a>. The arguments RA and DEC can be copy-pasted from the output of ‘msoverview’ to select the pointing of your observation. A sensible value for <strong>radius</strong> is, 5 degrees.</p>
<span id="gsmparams"></span><table border="1" class="docutils" id="id30">
<caption><span class="caption-number">Table 4 </span><span class="caption-text">The parameters and criteria that are used for creating the initial Global Sky Model.</span><a class="headerlink" href="#id30" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Unit</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>outfile</td>
<td>string</td>
<td>Path to the <strong>makesourcedb</strong> catalog file. If it exists, it will be overwritten.</td>
</tr>
<tr class="row-odd"><td>RA, DEC</td>
<td>degrees</td>
<td>Central position of conical search.</td>
</tr>
<tr class="row-even"><td>radius</td>
<td>degrees</td>
<td>Extent of conical search.</td>
</tr>
<tr class="row-odd"><td>vlssFluxCutoff</td>
<td>Jy</td>
<td>Minimum flux of VLSS source in outfile. Defaults to 4 Jy.</td>
</tr>
<tr class="row-even"><td>assocTheta</td>
<td>degrees</td>
<td>Search radius centered on VLSS source for which counterparts are searched. Defaults to 10 arcsec taking into account the VLSS resolution of 80 arcsec.</td>
</tr>
</tbody>
</table>
<p>The <strong>gsm.py</strong> script calls the function <strong>expected_fluxes_in_fov()</strong> in <strong>gsmutils.py</strong> that does the actual work. It makes a connection to the GSM database and selects all the VLSS sources that fulfill the criteria. The area around every found VLSS source (out to radius <strong>assocTheta</strong>) is searched for candidate counterparts in the other surveys. The dimensionless distance association parameter, <span class="math">\(\rho_{i,\star}\)</span>, is used to quantify the association of VLSS source-candidate counterpart further. It weights the positional differences by the postion errors of the pair and follows a Rayleigh distribution (De Ruiter et al., 1977). A value of <span class="math">\(3.717\)</span> corresponds to an acceptance of missing 0.1% genuine source associations (Scheers, 2011). The dimensionless radius is not an input argument to <strong>gsm.py</strong>, but it is to the above mentioned function. For completeness, we give its definition below:</p>
<div class="math">
\[\rho_{i,\star} \equiv \sqrt{ \frac{(\alpha_i \cos \delta_i - \alpha^{\star} \cos \delta^{\star})^2}{\sigma^2_{\alpha_i} + \sigma^2_{\alpha^{\star}}} + \frac{(\delta_i -\delta^{\star})^2}{\sigma^2_{\delta_i} + \sigma^2_{\delta^{\star}}}}.\]</div>
<p>Here the sub- and superscripts <span class="math">\(\star\)</span> refers to the VLSS source and <span class="math">\(i\)</span> to its <strong>candidate</strong> counterpart in one of the other surveys.</p>
<p>After being associated (or not), the corresponding fluxes and frequencies are used to fit the spectral-index and higher-order terms according to the equation in section <a class="reference internal" href="#source-catalog">Source catalog</a>. Therefore, we use the python <strong>numpy.poly1d()</strong> functions. If no counterparts were found a default spectral index of <span class="math">\(-0.7\)</span> is assumed.</p>
<p>Another optional argument when calling the function <strong>expected_fluxes_in_fov()</strong> in <strong>gsmutils.py</strong> is the boolean <strong>storespectraplots</strong>. When true and not performance driven, this will plot all the spectra of the sources in the catalog file, named by their VLSS name.</p>
<div class="section" id="special-cases">
<h3>Special cases<a class="headerlink" href="#special-cases" title="Permalink to this headline">¶</a></h3>
<p>There might be cases that a VLSS source has more than one WENSS counterpart. This might occur when the mutiple subcomponents of a multicomponent WENSS source are associated to the VLSS source. WENSS sources that are flagged as a subcomponent (<strong>‘C’</strong>) are omitted in the inclusion. Only single component WENSS sources (<strong>‘S’</strong>) and multicomponent WENSS sources (<strong>‘M’</strong>) are included in the counterpart search.</p>
</div>
<div class="section" id="instrument-tables">
<h3>Instrument tables<a class="headerlink" href="#instrument-tables" title="Permalink to this headline">¶</a></h3>
<p>When calibrating, we try to estimate parameters in the measurement equation. The values of these model parameters are stored in a so-called “parmdb” (table). Usually, this parmdb is stored inside a measurement set and is called <strong>instrument</strong>. To inspect or create a parmdb, use the command <a class="reference external" href="http://www.lofar.org/operations/doku.php?id=public:user_software:documentation:parmdbm">parmdb</a>. To view the contents of a parmdb, use the tool <strong>parmdbplot.py</strong> (see section <a class="reference internal" href="#inspecting-the-solutions">Inspecting the solutions</a>).</p>
<p>A parmdb can contain two sorts of parameters: normal parameters that are both time and frequency dependent, and <strong>default parameters</strong> that are neither frequency nor time dependent. The default parameters can be used as fallback if a model parameter is not known, but they can also be used in some schemes for transferring solutions, see section on <a class="reference internal" href="#gain-transfer">gain transfer</a> below.</p>
<p>Before even starting the actual BBS, there need to be values in the parmdb, because they are used as starting values by BBS <a class="footnote-reference" href="#f3" id="id3">[2]</a>. For gains (<strong>Gain</strong> and <strong>DirectionalGain</strong>), the default starting value of <span class="math">\(0\)</span> is not adequate. For this reason, the <strong>calibrate-stand-alone</strong> script implicitly creates a default parmdb that contains initial values of <span class="math">\(1\)</span> for these parameters.</p>
<p>Please note that if you create your own parmdb, you will almost always want to include the default <strong>adddef</strong> commands listed below to set the correct defaults for <strong>Gain</strong>, <strong>DirectionalGain</strong>. Otherwise, estimating these parameters will not work correctly. The default parameters are automatically created if you use <strong>calibrate-stand-alone</strong> with the option <strong>-f</strong> or <strong>–replace-parmdb</strong>. To set default values in a parmdb manually, use the following commands in <a class="reference external" href="http://www.lofar.org/operations/doku.php?id=public:user_software:documentation:parmdbm">parmdbm</a>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">adddef</span> <span class="n">Gain</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">Ampl</span>  <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">adddef</span> <span class="n">Gain</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">Ampl</span>  <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">adddef</span> <span class="n">Gain</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">Real</span>  <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">adddef</span> <span class="n">Gain</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">Real</span>  <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">adddef</span> <span class="n">DirectionalGain</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">Ampl</span>  <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">adddef</span> <span class="n">DirectionalGain</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">Ampl</span>  <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">adddef</span> <span class="n">DirectionalGain</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">Real</span>  <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">adddef</span> <span class="n">DirectionalGain</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">Real</span>  <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="model">
<h2>Model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h2>
<p>As already mentioned, BBS consists of two parts: a part to solve equations and a part to simulation of visibilities given a sky model. This section is about the latter. BBS uses the measurement equation, which is an equation that describes all effects that happen to the signal that was sent by the sky, before they are captured in your data. All these effects are Jones matrices: <span class="math">\(2\times 2\)</span> matrices that work on the two components (the two polarizations) of your data. An important thing to note is that these Jones matrices do not commute: the order in which they are matters.</p>
<p>The most commonly used effects that BBS can handle are given in <a class="reference internal" href="#bbseffects"><span class="std std-numref">Table 5</span></a>, in the order that they are applied (from sky to antenna). The direction dependent effects are different for each <strong>patch</strong> you specify in your source model.</p>
<span id="bbseffects"></span><table border="1" class="docutils" id="id31">
<caption><span class="caption-number">Table 5 </span><span class="caption-text">Effects that BBS handles. The first half are direction dependent effects (DDEs), which means that the effect is different for each patch. The bottom effects are direction independent effects (DIEs).</span><a class="headerlink" href="#id31" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Effect</th>
<th class="head">Description</th>
<th class="head">Jones matrix</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ScalarPhase</td>
<td>A phase that is equal for both dipoles</td>
<td><span class="math">\(\left( \begin{smallmatrix} e^{\alpha_p}&amp; 0\\ 0 &amp; e^{\alpha_p} \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-odd"><td>Rotation <a class="footnote-reference" href="#f20" id="id4">[19]</a></td>
<td>Faraday Rotation without frequency dependency</td>
<td><span class="math">\($\left( \begin{smallmatrix} \cos(\alpha_p) &amp; -\sin(\alpha_p)\\ \sin(\alpha_p) &amp; \cos(\alpha_p) \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-even"><td>FaradayRotation <a class="footnote-reference" href="#f21" id="id5">[20]</a></td>
<td>Faraday Rotation, <span class="math">\(\rho_p=\alpha_p\cdot\text{(channel wavelength)}^2\)</span></td>
<td><span class="math">\(\left( \begin{smallmatrix} \cos(\rho_p) &amp; -\sin(\rho_p)\\ \sin(\rho_p) &amp; \cos(\rho_p) \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-odd"><td>Directional TEC</td>
<td>TEC (ionosphere), <span class="math">\(\phi_p=\frac{-8.44797245\cdot 10^9\alpha_p}{\textrm{channel frequency}}\)</span></td>
<td><span class="math">\(\left( \begin{smallmatrix} e^{\phi_p} &amp; 0\\ 0 &amp; e^{\phi_p} \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-even"><td>Beam <a class="footnote-reference" href="#f22" id="id6">[21]</a></td>
<td>The LOFAR beam model</td>
<td>See section on Beam model</td>
</tr>
<tr class="row-odd"><td>DirectionalGain</td>
<td>Directional gain</td>
<td><span class="math">\(\left( \begin{smallmatrix} \alpha:0:0:p &amp; \alpha:0:1:p\\ \alpha:1:0:p &amp; \alpha:1:1:p \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-even"><td>CommonScalarPhase</td>
<td>Scalar phase</td>
<td><span class="math">\(\left( \begin{smallmatrix} e^\alpha &amp; 0\\ 0 &amp; e^\alpha \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-odd"><td>CommonRotation</td>
<td>Rotation</td>
<td><span class="math">\(\left( \begin{smallmatrix} \cos(\alpha) &amp; -\sin(\alpha)\\ \sin(\alpha) &amp; \cos(\alpha) \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-even"><td>TEC</td>
<td>TEC (ionosphere), <span class="math">\(\phi=\frac{-8.44797245\cdot 10^9\alpha}{\text{channel frequency}}\)</span></td>
<td><span class="math">\(\left( \begin{smallmatrix} e^\phi &amp; 0\\ 0 &amp; e^\phi \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-odd"><td>Gain</td>
<td>Gain</td>
<td><span class="math">\(\left( \begin{smallmatrix} \alpha:0:0 &amp; \alpha:0:1\\ \alpha:1:0 &amp; \alpha:1:1 \end{smallmatrix}\right)\)</span></td>
</tr>
<tr class="row-even"><td>Clock</td>
<td>Clock, <span class="math">\(\phi=\alpha\cdot 2\pi\cdot\text{channel frequency}\)</span></td>
<td><span class="math">\(\left( \begin{smallmatrix} e^\phi &amp; 0\\ 0 &amp; e^\phi \end{smallmatrix}\right)\)</span></td>
</tr>
</tbody>
</table>
<p>The two most commonly used effects, Gain and DirectionalGain, have only one option: <strong>Phasors</strong>. When set to <strong>True</strong> (or <strong>T</strong>), the gains are expressed like <span class="math">\(A\cdot e^{i\phi}\)</span>, otherwise they are specified in the form <span class="math">\(a + b\cdot i\)</span>. While mathematically equivalent, this does make a difference because the solver in BBS solves for real variables. When you are solving for phases or amplitudes only, it is necessary to specify <strong>Phasors = True</strong>. Specify this like</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="o">.</span><span class="n">Gain</span><span class="o">.</span><span class="n">Phasors</span> <span class="o">=</span> <span class="n">T</span>
</pre></div>
</div>
<p>For configuration of the beam model that is used, see section <a class="reference internal" href="#beam-model">Beam model</a>.</p>
<div class="section" id="beam-model">
<h3>Beam model<a class="headerlink" href="#beam-model" title="Permalink to this headline">¶</a></h3>
<p>The beam model tries to emulate all kinds of distortions to the signal that are caused by the beam of the station. These effects are split into two parts: the <strong>element beam</strong>, which is the response of a single dipole, and the <strong>array factor</strong>, which emulates the effect of combining the signal of the many dipoles in a station. In HBA, the array factor model also models the effect of the analogue tile beam former.</p>
<p>To have a look at different elements of the beam, you can specifically use only the element beam or only the array factor (if you don’t know the details, you need both the element beam and the array factor, which is the default). The options are</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="o">.</span><span class="n">Beam</span><span class="o">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">ELEMENT</span>       <span class="c1"># only element beam</span>
<span class="n">Model</span><span class="o">.</span><span class="n">Beam</span><span class="o">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">ARRAY_FACTOR</span>  <span class="c1"># only array factor</span>
<span class="n">Model</span><span class="o">.</span><span class="n">Beam</span><span class="o">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">DEFAULT</span>       <span class="c1"># both element beam and array factor (default)</span>
</pre></div>
</div>
<p>The tile beam former in the HBA tiles forms a beam for a certain reference frequency. When modeling this beam, the beam model should of course do this for the same frequency. Usually, this works automatically: the reference frequency is stored in the measurement set. Things are different when you compress a number of subbands as channels into one measurement set (usually done with DPPP).  Then each ‘channel’ was beamformed at a different reference frequency. In this case, the reference frequency is only right for one of the ‘channels’. To handle this case well, there is an option that tells the beam model to use the channel frequency (which is usually the center frequency of the compressed subband). This option is</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Step</span><span class="o">.</span><span class="n">Solve</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Beam</span><span class="o">.</span><span class="n">UseChannelFreq</span> <span class="o">=</span> <span class="n">T</span>
</pre></div>
</div>
<p>Note that the beam model is a direction dependent effect like any other in BBS. That means that over a patch, the beam is assumed to be constant (it is evaluated at the centroid of the patch). This may change in the future.</p>
</div>
</div>
<div class="section" id="solver">
<h2>Solver<a class="headerlink" href="#solver" title="Permalink to this headline">¶</a></h2>
<p>BBS performs parameter estimation on the measurement equation to find parameters that best match the observed visibilities. To improve signal to noise, one can assume that the parameters are constant for a number of time samples or a number of frequencies. In this way, there are more measurements available to estimate the same parameter. To specify these, use <strong>Step.&lt;name&gt;.Solve.CellSize.Time</strong> and <strong>Step.&lt;name&gt;.Solve.CellSize.Freq</strong>. The unit of <strong>CellSize.Time</strong> is number of time slots, so <strong>CellSize.Time=1</strong> corresponds to the correlator integration time. If <strong>CellSize.Time=0</strong>, one solution is calculated for the entire scan.</p>
<p>The underlying solver is a Levenberg-Marquardt solver. Several parameters exist to this solver, however the defaults should be fine.</p>
</div>
<div class="section" id="example-reductions">
<h2>Example reductions<a class="headerlink" href="#example-reductions" title="Permalink to this headline">¶</a></h2>
<p>The sequence of operations that BBS will perform on the data are defined in a configuration or <strong>parset</strong> file <a class="footnote-reference" href="#f4" id="id7">[3]</a>. The BBS documentation on the LOFAR wiki documents all the options (see the <a class="reference external" href="http://www.lofar.org/operations/doku.php?id=public:user_software:documentation:bbs">LOFAR wiki</a>), and it is highly recommended that you obtain a hard-copy of this for future reference.</p>
<p>A BBS parset file consists of two sections: The <strong>Strategy</strong> section, which defines the operations (or <strong>steps</strong>) to be carried out, and the <strong>Step</strong> section, which defines the details of each step. The following sections describe a few typical reductions along with the corresponding parset.</p>
<p>The parsets shown in the following sections are intentionally verbose. Often, default settings have been included for clarity. For example, the default input column is <strong>DATA</strong>. The line <strong>Strategy.InputColumn = DATA</strong> is therefore redundant and can be left out.</p>
<div class="section" id="simulation">
<h3>Simulation<a class="headerlink" href="#simulation" title="Permalink to this headline">¶</a></h3>
<p>Given a source catalog and (optionally) a table of model parameters, BBS can be used to compute simulated <em>uv</em>-data (without noise) <a class="footnote-reference" href="#f5" id="id8">[4]</a>. Simulated data can sometimes be useful as a debugging aid. Imaging simulated data can provide an impression of what you would expect to see with an ideal telescope under ideal conditions and without noise. Comparing observed data to simulated data can provide useful clues, although in practice this is limited to cases where the signal to noise ratio of the observed data is high.</p>
<p>Simulated data produced by BBS (or any other software package) can also be used as model data during calibration using the same parset syntax as described in section <a class="reference internal" href="#pre-computed-visibilities">Pre-computed visibilities</a>.</p>
<p>An example parset file <a class="footnote-reference" href="#f6" id="id9">[5]</a> to simulate {it uv}-data for all the sources in the source catalog is shown below.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># simulation.parset</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">InputColumn</span> <span class="o">=</span> <span class="n">DATA</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">TimeRange</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">Baselines</span> <span class="o">=</span> <span class="o">*&amp;</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">ChunkSize</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">Steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">predict</span><span class="p">]</span>
<span class="n">Step</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">PREDICT</span>
<span class="n">Step</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Sources</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Step</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">Column</span> <span class="o">=</span> <span class="n">MODEL_DATA</span>
</pre></div>
</div>
</div>
<div class="section" id="gain-calibration-direction-independent">
<h3>Gain calibration (direction-independent)<a class="headerlink" href="#gain-calibration-direction-independent" title="Permalink to this headline">¶</a></h3>
<p>The following parset <a class="footnote-reference" href="#f7" id="id10">[6]</a> describes a direction independent gain calibration. The meaning of each parameter is the same as in section <a class="reference internal" href="#simulation">Simulation</a> unless otherwise stated. Enabling / disabling of model components can be either done by a short-hand <strong>T</strong> and <strong>F</strong> which is equivalent to explicit <strong>True</strong> and <strong>False</strong>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># uv-plane-cal.parset</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">InputColumn</span> <span class="o">=</span> <span class="n">DATA</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">TimeRange</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">Baselines</span> <span class="o">=</span> <span class="o">*&amp;</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">ChunkSize</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">Steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">solve</span><span class="p">,</span> <span class="n">correct</span><span class="p">]</span>

<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">SOLVE</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Sources</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="n">C196</span><span class="p">]</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Gain</span><span class="o">.</span><span class="n">Enable</span> <span class="o">=</span> <span class="n">T</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Solve</span><span class="o">.</span><span class="n">Parms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Gain:0:0:*&quot;</span><span class="p">,</span> <span class="s2">&quot;Gain:1:1:*&quot;</span><span class="p">]</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CellSize</span><span class="o">.</span><span class="n">Freq</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CellSize</span><span class="o">.</span><span class="n">Time</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1">#Step.solve.Model.Beam.Enable = True  &lt;-uncomment if you want to apply the beam</span>

<span class="n">Step</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">CORRECT</span>
<span class="n">Step</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Gain</span><span class="o">.</span><span class="n">Enable</span> <span class="o">=</span> <span class="n">T</span>
<span class="n">Step</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">Column</span> <span class="o">=</span> <span class="n">CORRECTED_DATA</span>
<span class="c1">#Step.correct.Model.Beam.Enable = True &lt;-uncomment if you want to apply the beam</span>
</pre></div>
</div>
<p>The CORRECT step performs a correction of the <em>uv</em>-data for a particular direction. This can be done for exactly <strong>one</strong> source from the skymodel. If <strong>Model.Sources</strong> contains multiple sources, BBS will throw an exception, because it cannot correct for more than one direction at a time.</p>
<p>BBS also accepts an empty source list in the CORRECT step. In that case it will correct for the phase center direction of the MS. This does then, of course, not include direction dependent effects such as <strong>DirectionalGain</strong>, <strong>DirectionalTEC</strong>, et cetera, which are inherently bound to a patch name and therefore can only be corrected for if a patch name is specified. This implicit behaviour must be kept in mind when correcting your data.</p>
<p>Note that a CORRECT step cannot be “undone”. If a CORRECTED_DATA column is used for further calibration later on, one has to be aware of the consequences. For example, if in the first correct the beam was enabled, this prevents proper use of the beam in the following steps <a class="footnote-reference" href="#f8" id="id11">[7]</a>.</p>
</div>
<div class="section" id="gain-calibration-direction-dependent-with-source-subtraction">
<h3>Gain calibration (direction-dependent) with source subtraction<a class="headerlink" href="#gain-calibration-direction-dependent-with-source-subtraction" title="Permalink to this headline">¶</a></h3>
<p>This section has been adapted from a document written by <a class="reference external" href="mailto:annalisa&#46;bonafede&#37;&#52;&#48;hs&#46;uni-hamburg&#46;de">Annalisa Bonafede</a>. In the following, we report the parset <a class="footnote-reference" href="#f9" id="id12">[8]</a> file and skymodel used for the subtraction of Cas A and Cyg A from the observation of the radio source 3C380.</p>
<p>The parset includes the following steps:</p>
<ul>
<li><p class="first">Solve for the gain in the direction of each source in the source catalog.</p>
</li>
<li><p class="first">Subtract the sources CygA.E, CygA.W, and CasA, each with their own individual gain.</p>
</li>
<li><p class="first">Correct the data for the gain in the direction of 3C380 (the target).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># image-plane-cal.parset</span>
<span class="c1">#</span>

<span class="n">Strategy</span><span class="o">.</span><span class="n">ChunkSize</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">Strategy</span><span class="o">.</span><span class="n">Steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">solve</span><span class="p">,</span> <span class="n">subtract</span><span class="p">,</span> <span class="n">correct</span><span class="p">]</span>

<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">SOLVE</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">DirectionalGain</span><span class="o">.</span><span class="n">Enable</span> <span class="o">=</span> <span class="n">T</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Solve</span><span class="o">.</span><span class="n">Parms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DirectionalGain:0:0:*&quot;</span><span class="p">,</span><span class="s2">&quot;DirectionalGain:1:1:*&quot;</span><span class="p">]</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CellSize</span><span class="o">.</span><span class="n">Freq</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Step</span><span class="o">.</span><span class="n">solve</span><span class="o">.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CellSize</span><span class="o">.</span><span class="n">Time</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">Step</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">SUBTRACT</span>
<span class="n">Step</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">CygA</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">CygA</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">CasA</span><span class="p">]</span>
<span class="n">Step</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">DirectionalGain</span><span class="o">.</span><span class="n">Enable</span> <span class="o">=</span> <span class="n">T</span>

<span class="n">Step</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">CORRECT</span>
<span class="n">Step</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Sources</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="n">C380</span><span class="p">]</span>
<span class="n">Step</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">DirectionalGain</span><span class="o">.</span><span class="n">Enable</span> <span class="o">=</span> <span class="n">T</span>
<span class="n">Step</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">Column</span> <span class="o">=</span> <span class="n">CORRECTED_DATA</span>
</pre></div>
</div>
</li>
</ul>
<p>The source catalog used for calibration is reported below <a class="footnote-reference" href="#f10" id="id13">[9]</a></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">############################################################</span>
<span class="c1"># 3C380-bbs.skymodel</span>
<span class="c1"># (Name, Type, Ra, Dec, I, ReferenceFrequency, SpectralIndex) = format</span>

<span class="n">CygA</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">POINT</span><span class="p">,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">29.99</span><span class="p">,</span> <span class="o">+</span><span class="mf">40.43</span><span class="o">.</span><span class="mf">57.53</span><span class="p">,</span> <span class="mi">4421</span><span class="p">,</span> <span class="mf">73.8e6</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.7</span><span class="p">]</span>
<span class="n">CygA</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">POINT</span><span class="p">,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">23.23</span><span class="p">,</span> <span class="o">+</span><span class="mf">40.44</span><span class="o">.</span><span class="mf">23.03</span><span class="p">,</span> <span class="mi">2998</span><span class="p">,</span> <span class="mf">73.8e6</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.7</span><span class="p">]</span>
<span class="n">CasA</span><span class="p">,</span> <span class="n">POINT</span><span class="p">,</span> <span class="mi">23</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">24.0</span><span class="p">,</span> <span class="o">+</span><span class="mf">58.48</span><span class="o">.</span><span class="mf">54.0</span><span class="p">,</span> <span class="mi">20000</span>
<span class="mi">3</span><span class="n">C380</span><span class="p">,</span> <span class="n">POINT</span><span class="p">,</span> <span class="mi">18</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mf">31.8</span><span class="p">,</span> <span class="o">+</span><span class="mf">48.44</span><span class="o">.</span><span class="mf">46.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">178.e6</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.7</span><span class="p">]</span>
</pre></div>
</div>
<p>The flux of 3C380 has been set to the arbitrary value of 1 Jy. Its spectral index has been roughly estimated by comparing VLSS and 3C flux. The subtraction can also be performed without specifying the correct flux of the sources and determining the flux of the target source with self calibration.</p>
<p>The resulting image in shown in <a class="reference internal" href="#c380compare"><span class="std std-numref">Fig. 19</span></a>, compared to the map obtained without subtraction.</p>
<div class="figure align-center" id="id33">
<span id="c380compare"></span><img alt="_images/3C380_comparison_zoom.png" src="_images/3C380_comparison_zoom.png" />
<p class="caption"><span class="caption-number">Fig. 19 </span><span class="caption-text">The radio source 3C380 imaged by LOFAR at 135~MHz (observation ID <strong>L2010_08567</strong>). <strong>Left panel</strong>: Self calibration has been applied with directional-gain correction and subtraction of CygA and CasA. <strong>Right panel</strong>: Self calibration has been applied without correction. The lowest contour level is at  3 mJy <span class="math">\(\mathrm{beam}^{-1}\)</span>; subsequent contour levels are spaced by factors of <span class="math">\(\sqrt{2}\)</span>. The resolution is <span class="math">\(83.29&quot; \times  59.42&quot;\)</span>. The negative contour is in red.</span></p>
</div>
</div>
</div>
<div class="section" id="tweaking-bbs-to-run-faster">
<h2>Tweaking BBS to run faster<a class="headerlink" href="#tweaking-bbs-to-run-faster" title="Permalink to this headline">¶</a></h2>
<p>BBS can take a long time to calibrate your huge dataset. Luckily, there are some ways to tune it. You have to know a bit about how BBS works to do this.</p>
<p>BBS views the data as a grid of time slots times vs channels (see <a class="reference internal" href="#solvedomains"><span class="std std-numref">Fig. 21</span></a>). A solution cell is defined as the number of timeslots times the number of channels on which a constant parameter solution is computed. For example, if you specify <strong>CellSize.Freq = 1</strong>, a different solution is computed for every channel independently. In <a class="reference internal" href="#solvedomains"><span class="std std-numref">Fig. 21</span></a>, the solution cells are outlined with blue lines.</p>
<p>Because the evaluation of the model is computationally expensive, and a lot of intermediate results can be reused, the model is evaluated for a number of cells simultaneously. There is a trade-off here: if one cell would converge to a solution very slowly, the model is evaluated for all the cells in the cell chunk, even the ones that have converged. The number of cells in a cell chunk is specified by <strong>CellChunkSize</strong>, which specifies the number of solution cells in the time direction. Dependent on the amount of frequency cells, a value of <strong>CellChunkSize = 10 – 25</strong> could be good.</p>
<p>First, BBS loads a lot of timeslots into memory. The amount of timeslots is specified by <strong>ChunkSize</strong>. If you specify <strong>ChunkSize = 0</strong> then the whole MS will be read into memory, which will obviously not work if your data is 80 Gb large. Depending on the number of baselines and channels, usually 100 is a good choice. Monitor the amount of memory that is used (for example by running <strong>top</strong>) to see if you’re good. The <strong>ChunkSize</strong> should be an integer multiple of <strong>CellSize.Time</strong> <span class="math">\(\times\)</span> <strong>CellChunkSize</strong>, so that in every chunk the same number of cell chunks are handled and all cell chunks have the same size.</p>
<div class="figure align-center" id="id35">
<span id="solvedomains"></span><img alt="_images/solve_domains.png" src="_images/solve_domains.png" />
<p class="caption"><span class="caption-number">Fig. 21 </span><span class="caption-text">The different solve domains and chunk parameters for BBS. In this example, <strong>CellSize.Time=8</strong>, <strong>CellSize.Freq=8</strong>, <strong>ChunkSize=32</strong>, <strong>CellChunkSize=2</strong> (do not use these values yourself, they are probably not good for actual use).</span></p>
</div>
<div class="section" id="multithreading">
<h3>Multithreading<a class="headerlink" href="#multithreading" title="Permalink to this headline">¶</a></h3>
<p>BBS can do a bit of multithreading. Be warned in advance that if you use <span class="math">\(N\)</span> threads, BBS will most likely not run <span class="math">\(N\)</span> times faster. Again, a bit of tweaking may be necessary.</p>
<p>The multithreading is done on solve part, not on the model building part. So it works only on problems that are ‘solve-dominated’. The multithreading is performed over the solution cells. For this to give any speedup, there need to be at least as many solution cells as the number of threads. You usually get a decent speed-up if the number of solution cells is about 5–6 times the number of threads. So if you solve over all frequencies (the number of frequency cells is 1), <strong>CellChunkSize = 5</strong> <span class="math">\(\times\)</span> <strong>nThreads</strong> should give you some speedup.</p>
<p>You can instruct <strong>calibrate-stand-alone</strong> <a class="footnote-reference" href="#f11" id="id14">[10]</a> to run with multithreading with the parameter <strong>-t</strong> or <strong>–numthreads</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">calibrate</span><span class="o">-</span><span class="n">stand</span><span class="o">-</span><span class="n">alone</span> <span class="o">--</span><span class="n">numthreads</span> <span class="mi">8</span> <span class="o">&lt;</span><span class="n">MS</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">parset</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">source</span> <span class="n">catalog</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="global-parameter-estimation">
<h2>Global parameter estimation<a class="headerlink" href="#global-parameter-estimation" title="Permalink to this headline">¶</a></h2>
<p>BBS was designed to run on a compute cluster, calibrating across multiple subbands which reside on separate compute nodes. BBS consists of three separate executables: <strong>bbs-controller</strong>, <strong>bbs-reducer</strong>, and <strong>bbs-shared-estimator</strong>. The <strong>bbs-controller</strong> process monitors and controls a set of <strong>bbs-reducer</strong> processes, and possibly one or more <strong>bbs-shared-estimator</strong> processes. Each <em>subband</em> is processed by a separate <strong>bbs-reducer</strong> process. When working with <strong>calibrate-stand-alone</strong>, the script actually launches one <strong>bbs-reducer</strong> for you. To setup a calibration across subbands, the script <strong>calibrate</strong> can be used, which sets up the appropriate processes on different nodes.</p>
<p>Each <strong>bbs-reducer</strong> process computes a set of equations and sends this to the <strong>bbs-shared-estimator</strong> process assigned to the group it is part of. The <strong>bbs-shared-estimator</strong> process merges the set of equations with the sets of equations it receives from the other <strong>bbs-reducer</strong> processes in the group. Once it has received a set of equations from all the <strong>bbs-reducer</strong> in its group, the <strong>bbs-shared-estimator</strong> process computes a new estimate of the model parameters. This is sent back to all <strong>bbs-reducer</strong> processes in the group and the whole process repeats itself until convergence is reached.</p>
<div class="section" id="setting-up-your-environment">
<h3>Setting up your environment<a class="headerlink" href="#setting-up-your-environment" title="Permalink to this headline">¶</a></h3>
<p>Before using the distributed version of BBS, you will have to set up a personal database. In principle, this needs to be done only once. You only have to recreate your database when the BBS SQL code has changed, for example to support new functionality. Such changes are kept to a minimum.</p>
<p>Also, on each <strong>lce</strong> or <strong>locus</strong> node that you are going to use you need to create a working directory. Make sure you use the same path name on all the nodes . This has to be done only once.</p>
<p>The distributed version of BBS requires a file that describes the compute cluster (an example of such a file is <strong>cep1.clusterdesc</strong> <a class="footnote-reference" href="#f12" id="id15">[11]</a>) and a configuration or <em>parset</em> <a class="footnote-reference" href="#f13" id="id16">[12]</a> file that describes the reduction.</p>
<p>For each MS that we want to calibrate it is necessary to create a <em>vds</em> file that describes its contents and location. This can be done by running the following command</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">makevds</span> <span class="n">cep1</span><span class="o">.</span><span class="n">clusterdesc</span> <span class="o">&lt;</span><span class="n">directory</span><span class="o">&gt;/&lt;</span><span class="n">MS</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>After this, all <em>vds</em> files need to be combined into a single <em>gds</em> file, ready for calibration and/or imaging. This is done by typing</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">combinevds</span> <span class="o">&lt;</span><span class="n">output</span> <span class="n">file</span><span class="o">&gt;.</span><span class="n">gds</span> <span class="o">&lt;</span><span class="n">vds</span> <span class="n">file</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">vds</span> <span class="n">file</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>Instead of specifying the list of input <em>vds</em> files, you could type <strong>*.vds</strong>. Note that the <strong>combine</strong> step is required even if we want to calibrate a single subband only, although normally you would calibrate a single subband using the stand-alone version of BBS.</p>
</div>
<div class="section" id="id17">
<h3>Usage<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>To calibrate an observation with the distributed version of BBS <em>on the Groningen cluster</em>, execute the <strong>calibrate</strong> script on the command line</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">calibrate</span> <span class="o">-</span><span class="n">f</span> <span class="o">--</span><span class="n">key</span> <span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">desc</span> <span class="o">~/</span><span class="n">imaging</span><span class="o">.</span><span class="n">clusterdesc</span> <span class="o">--</span><span class="n">db</span> <span class="n">ldb001</span> <span class="o">--</span><span class="n">db</span><span class="o">-</span><span class="n">user</span> <span class="n">postgres</span> <span class="o">&lt;</span><span class="n">gds</span> <span class="n">file</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">parset</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">source</span> <span class="n">catalog</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">working</span> <span class="n">directory</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>which is a single command, spread over multiple lines, as indicated by a backslash. The important arguments provided to the <strong>calibrate</strong> script in this example are:</p>
<ul class="simple">
<li><strong>&lt;key&gt;</strong>, which is a single word that identifies the BBS run. If you want to start a BBS run <em>while another run is still active</em>, make sure that the runs have <em>different</em> keys (using this option).</li>
<li><strong>&lt;gds file&gt;</strong>, which contains the locations of all the MS (subbands) that constitute the observation. It should be given here by its full path, for example /data/scratch/<span class="math">\(&lt;`username:math:\)</span>&gt;`/<span class="math">\(&lt;`global gds file:math:\)</span>&gt;`.</li>
<li><strong>&lt;parset&gt;</strong>, which defines the reduction (see section <a class="reference internal" href="#example-reductions">Example reductions</a>).</li>
<li><strong>&lt;source catalog&gt;</strong>, which defines a list of sources that can be used for calibration (see section <a class="reference internal" href="#source-catalog">Source catalog</a>).</li>
<li><strong>&lt;working directory&gt;</strong>, which is the working directory where BBS processes will be run and where the logs will be written (usually <strong>/data/scratch/&lt;user name&gt;</strong>). It should be created on each compute node that you intend to use. You can use the <strong>cexec</strong> command for this (see section <a class="reference internal" href="gettingstarted.html#logging-on-to-cep3"><span class="std std-ref">Logging on to CEP3</span></a>).</li>
<li>The <strong>-f</strong> option, which overwrites stale information from previous runs.</li>
</ul>
<p>You can run the <strong>calibrate</strong> script without arguments for a description of all the options and the mandatory arguments. You can also use the <strong>-v</strong> option to get a more verbose output. Note that the arguments of <strong>calibrate</strong> are very much like <a class="footnote-reference" href="#f14" id="id18">[13]</a> those of <strong>calibrate-stand-alone</strong>.</p>
<p>The <strong>calibrate</strong> script does not show progress information, which makes it difficult to estimate how long a BBS run will take to complete. One way around this is to log on to one of the compute nodes where BBS is processing, change to your local working directory, and monitor one of the <strong>bbs-reducer</strong> log files. These log files are named <strong>&lt;key&gt;_-kernel_-&lt;pid&gt;.log</strong>. The default key is <strong>default</strong>, and therefore you will often see log files named e.g. <strong>default_-kernel_-12345.log</strong>. The following command will print the number of times a chunk of visibility data was read from disk:</p>
<blockquote>
<div>&gt; grep “nextchunk” default_kernel_12345.log | wc -l</div></blockquote>
<p>You can compute the total number of chunks by dividing the total number of time stamps in the observation by the chunk size specified in the parset (<strong>Strategy.ChunkSize</strong>). Of course, if you make the chunk size large, it may take BBS a long time to process a single chunk and this way of gauging progress is not so useful. Generally, it is not advisable to use a chunk size larger than several hundreds of time samples. This will waste memory. A chunk size smaller than several tens of time stamps is also not advisable, because it leads to inefficient disk access patterns.</p>
</div>
<div class="section" id="defining-a-global-solve">
<h3>Defining a global solve<a class="headerlink" href="#defining-a-global-solve" title="Permalink to this headline">¶</a></h3>
<p>Solving across multiple subbands can be useful if there is not enough signal in a single subband to achieve reasonable calibration solutions, i.e. the phase and amplitude solutions look more or less random. Basically, there should be enough source flux in the field for calibration. Of course, one first has to verify that the sky model used for calibration is accurate enough, because using an inaccurate sky model can also result in bad calibration solutions.</p>
<p>To enable global parameter estimation, include the following keys in your parset. Note that the value of the <strong>Step.&lt;name&gt;.Solve.CalibrationGroups</strong> key is just an example. This key is described in more detail below</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Strategy</span><span class="o">.</span><span class="n">UseSolver</span> <span class="o">=</span> <span class="n">T</span>
<span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CalibrationGroups</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<p>The <strong>Step.&lt;name&gt;.Solve.CalibrationGroups</strong> key specifies the partition of the set of all available subbands into separate <em>calibration groups</em>. Each value in the list specifies the number of subbands that belong to the same calibration group. Subbands are ordered from the lowest to the highest starting frequency. The sum of the values in the list <strong>must</strong> equal the total number of subbands in the <strong>gds</strong> file. By default, the <strong>CalibrationGroups</strong> key is set to the empty list. This indicates that there are no interdependencies and therefore each subband can use its own solver. Global parameter estimation will <em>not</em> be used in this case (even if <strong>Strategy.UseSolver = T</strong>).</p>
<p>When using global parameter estimation, it is important to realize that drifting station clocks and the ionosphere cause frequency dependent phase changes. Additionally, due to the global bandpass, the effective sensitivity of the telescope is a function of frequency. Therefore, at this moment, it is not very useful to perform global parameter estimation using more than about 1–2 MHz of bandwidth (5–10 consecutive subbands).</p>
<p>A few examples of using global parameter estimation with 10 bands would be:</p>
<ul>
<li><p class="first">Estimate parameters using all bands together:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CalibrationGroups</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">Estimate parameters for the first 5 bands together, and separately for the last 5 bands together</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CalibrationGroups</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">Do not use global parameter estimation (even if <strong>Strategy.UseSolver = T</strong>)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CalibrationGroups</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</li>
<li><p class="first">Estimate parameters for band 0 separately, bands 1–3 together, bands 4–5 together, and bands 6–9 together (note that 1+3+2+4=10, the total number of subbands in our example)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CalibrationGroups</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="pre-computed-visibilities">
<h2>Pre-computed visibilities<a class="headerlink" href="#pre-computed-visibilities" title="Permalink to this headline">¶</a></h2>
<p>Diffuse, extended sources can only be approximately represented by a collection of point sources. Exporting clean-component (CC) models from catalogues (e.g. VLSS, WENSS) or first iteration major cycle selfcal images tend to contain many CCs, ranging up to 50,000. By using <strong>casapy2bbs.py</strong> these can be imported into a BBS catalog file, but processing these can take long and memory requirements might not even allow their usage at all. <a class="footnote-reference" href="#f15" id="id19">[14]</a></p>
<p>An alternative lies in (fast) Fourier transforming model images directly into <em>uv</em>-data columns. These can then be used in BBS as model data. The import can be done with a tool called <strong>addUV2MS</strong>.</p>
<p>The first argument is the MS to which the <em>uv</em>-data is to be added. The second argument is a CASA image (extension .model). The filename of the image is stripped of its leading path and file extension. This is then the column name it is identified by in the parset, and can be seen in the MS. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&gt; addUV2MS -w 512 L24380SB030uv.MS.dppp.dppp $HOME/Images/3C196_5SBs.model
</pre></div>
</div>
<p>This will create a column of name <strong>3C196_5SBs</strong>, containing the <em>uv</em>-data FFT’ed from this model image, using 512 w-projection planes. You can run <strong>addUV2MS</strong> multiple times with different images, or also with several images as additional command arguments, to create more than one <em>uv</em>-data column. While this works in principle with normal images, it is advisable to use clean component model images generated by CASA.</p>
<p>A few notes of caution though:</p>
<ul class="simple">
<li>The image must have the same phase center as the MS, because the internal CASA-routine which is used, does not do any phase shifting.</li>
<li>For wide field images you should set an appropriate value for the number of w-planes used in the w-projection term (default=128).</li>
<li>Direction dependent effects cannot be handled for “large” images. This means the image has to be small on the scale over which the direction dependent effects change.</li>
<li><strong>addUV2MS</strong> temporarily overwrites the frequency in the input images to match that in the MS. It restores the original frequency, but only one (multi-frequency channel images aren’t supported). Aborting the run may leave you then with a model image having an incorrect frequency entry.</li>
<li>Successive runs with the same input model image will overwrite the data in the respective column.</li>
</ul>
<p>The column name generated by <strong>addUV2MS</strong> can be used in the BBS parset as:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Model</span><span class="o">.</span><span class="n">Sources</span> <span class="o">=</span> <span class="p">[</span><span class="nd">@columnname</span><span class="p">]</span>
</pre></div>
</div>
<p>You can use <strong>casabrowser</strong> to find out which data columns are available in a given MS. Be careful about dots in the filename, and verify that your model refers to the name of the created column. Running <strong>addUV2MS -h</strong> will give you more information about its usage.</p>
<p>You can use <strong>cexecms</strong> to add model <em>uv</em>-data to more than one MS, for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">cexecms</span> <span class="s2">&quot;addUV2MS -w 512 &lt;FN&gt; $HOME/Images/3C1965_SBs.model&quot;</span> <span class="s2">&quot;/data/scratch/pipeline/L2011_08175/*&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="inspecting-the-solutions">
<h2>Inspecting the solutions<a class="headerlink" href="#inspecting-the-solutions" title="Permalink to this headline">¶</a></h2>
<p>You can inspect the solutions using the python script <strong>parmdbplot.py</strong>. To start <strong>parmdbplot.py</strong> from the command line, you should first initialize the <strong>lofar</strong> environment (see <a class="reference internal" href="gettingstarted.html#setting-up-your-working-environment"><span class="std std-ref">Setting up your working environment</span></a>). Then you can type, for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">parmdbplot</span><span class="o">.</span><span class="n">py</span> <span class="n">SB23</span><span class="o">.</span><span class="n">MS</span><span class="o">.</span><span class="n">dppp</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span>
</pre></div>
</div>
<p>The first thing you should see after starting the script should be the main window (see <a class="reference internal" href="#parmdb-mainwindow"><span class="std std-numref">Fig. 22</span></a>). Here you can select a set of parameters of the same type to be plotted together in a single plot. Note that some features will not be available if you select multiple parameters. Parmdbplot is able to properly handle the following solution types: Gain, DirectionalGain, CommonRotationAngle, RotationAngle, CommonScalarPhase, ScalarPhase, Clock, TEC, RM. The last three (Clock, TEC and RM) are properly converted into a phase – they are stored differently in the parmdb internally.</p>
<p>The “Use resolution” option is best left <em>unchecked</em>. If it is checked, the plotter tries to find a resolution that will yield a <span class="math">\(100 \times 100\)</span> grid in <span class="math">\(\mathrm{frequency} \times \mathrm{time}\)</span>. Usually, you just want to use the sampling intervals that are present in the parmdb. In that case, leave the box unchecked.</p>
<div class="figure align-center" id="id36">
<span id="parmdb-mainwindow"></span><img alt="_images/parmdbplot_main.png" src="_images/parmdbplot_main.png" />
<p class="caption"><span class="caption-number">Fig. 22 </span><span class="caption-text">The main window of <strong>parmdbplot</strong>.</span></p>
</div>
<div class="figure align-center" id="id37">
<span id="parmdb-plotwindow"></span><img alt="_images/parmdbplot_figure.png" src="_images/parmdbplot_figure.png" />
<p class="caption"><span class="caption-number">Fig. 23 </span><span class="caption-text">The plot window of <strong>parmdbplot</strong>.</span></p>
</div>
<div class="figure align-center" id="id38">
<span id="parmdb-phasesum"></span><img alt="_images/parmdbplot_phasesum.png" src="_images/parmdbplot_phasesum.png" />
<p class="caption"><span class="caption-number">Fig. 24 </span><span class="caption-text">The plot window of <strong>parmdbplot</strong> with a phase sum.</span></p>
</div>
<p>Once you click the “Plot” button, a window similar to the <a class="reference internal" href="#parmdb-plotwindow"><span class="std std-numref">Fig. 23</span></a> should pop up. We discuss the controls on the top of the window from left to right. The first is a drop down box that allows you to select the axis (frequency, time) to slice over. By default, this is set to frequency, which means that the x-axis in the plot is time and that you can step along the frequency axis using the spin control (the second control from the left).</p>
<p>The “Legend” checkbox allows you turn the legend on or off (which can be quite large and thus obscure the plot, so it is off by default). The “Polar” checkbox lets you select if the parameter value is plotted as amplitude/phase (the default) or real/imaginary. The “Unwrap phase” checkbox will turn phase unwrapping on or off. The button “Block y-axis” is useful when stepping over multiple frequency solutions: if checked, the y-scale will remain the same for all plots. “Use points” can be checked if you want points (instead of lines) for amplitude plots.</p>
<p>The last checkbox lets you choose the unit for the x-axis. By default, it is the sample number. If you chose, in the main window, to use a time resolution of 2 seconds, then the number 10 on the x-axis means <span class="math">\(10 \times 2 = 20\)</span> seconds. If you enable “Values on x-axis”, it will show the number of minutes since the start of the observation.</p>
<p>The “Phase reference” drop down box allows you to select the parameter used as the phase reference for the phase plots (the phase reference is only applied in amplitude/phase mode).</p>
<p>When the phase reference is set, one can use the “phase sum” drop-down menu (see <a class="reference internal" href="#parmdb-phasesum"><span class="std std-numref">Fig. 24</span></a>). This menu allows the user to select among all the other parameters related to the same antenna and add the phases to those plotted. All the selected phases are referenced to the “phase reference” antenna. This procedure is useful if one solves for Phase and Clock (or TEC) and wants to look at the global phase effect. Note that the phase effects are just added together with not specific order. This is only physically correct if the effects commute.</p>
<p>The slider on the left of the plots allows you to make an exponential zoom to the median value of amplitude plots. This  can be helpful if you have one outlier in the solution which sets the scale to 1000 when you are actually interested in the details around 0.001.</p>
<p>The controls on the bottom of the window are the default matplotlib controls that allow you to pan, zoom, save the plot, and so on.</p>
<p>For a quick overview of solutions, and to compare lots of solutions at a glance, you can also use the <strong>solplot.py</strong> <a class="footnote-reference" href="#f16" id="id20">[15]</a> script by George Heald:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="n">solplot</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">q</span> <span class="o">*.</span><span class="n">MS</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span>
</pre></div>
</div>
<p>Running the script with <strong>-h</strong> will produce an overview of possible options.</p>
</div>
<div class="section" id="the-global-bandpass">
<h2>The global bandpass<a class="headerlink" href="#the-global-bandpass" title="Permalink to this headline">¶</a></h2>
<p>This section describes estimates of the global bandpass for the <strong>LBA</strong> band and <strong>HBA</strong> bands. The bandpass curves were estimated from the BBS amplitude solutions for several observations of a calibrator source (Cygnus A or 3C196).</p>
<div class="section" id="lba">
<h3>LBA<a class="headerlink" href="#lba" title="Permalink to this headline">¶</a></h3>
<p>The global bandpass has been determined for the LBA band between 10-85 MHz by inspecting the BBS solutions after calibration of a 10-minute observation of Cygnus A. Calibration was performed using a 5-second time interval on data flagged for RFI (with RFIconsole), demixed, and compressed to one channel per sub band. The LBA beam model was enabled during the calibration. The bandpass was then derived by calculating the median of the amplitude solutions for each sub band over the 10-minute observation, after iterative flagging of outliers.</p>
<div class="figure align-center" id="id40">
<span id="lbabandpass"></span><img alt="_images/globalbandpasslba.png" src="_images/globalbandpasslba.png" />
<p class="caption"><span class="caption-number">Fig. 26 </span><span class="caption-text">The global bandpass in LBA between 10–85 MHz.</span></p>
</div>
<p><a class="reference internal" href="#lbabandpass"><span class="std std-numref">Fig. 26</span></a> shows the amplitudes found by BBS for each sub band, normalized to 1.0 near the peak at <span class="math">\(\approx 58\)</span> MHz. The time and elevation evolution of the bandpass has also been investigated. In general, the bandpass is approximately constant on average over the elevation range probed by these observations, implying that the effects of the beam have been properly accounted for.</p>
</div>
<div class="section" id="hba">
<h3>HBA<a class="headerlink" href="#hba" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="id42">
<span id="hbabandpass"></span><img alt="_images/mergeGlobalBandpass.png" src="_images/mergeGlobalBandpass.png" />
<p class="caption"><span class="caption-number">Fig. 28 </span><span class="caption-text">The global bandpass for the HBA.</span></p>
</div>
<p>The global bandpass for the HBA bands was determined in the same basic way as the LBA global bandpass. Three one-hour observations of 3C196 from April 2012 were used (one each for HBA-low, HBA-mid, and HBA-high). No demixing was done. A two-point-source model was used for calibration. The resulting bandpass is shown in <a class="reference internal" href="#hbabandpass"><span class="std std-numref">Fig. 28</span></a>. Note that several frequency intervals in the HBA-high observation were affected by severe RFI.</p>
</div>
<p id="gain-transfer">.. _gain transfer:</p>
</div>
<div class="section" id="gain-transfer-from-a-calibrator-to-the-target-source">
<h2>Gain transfer from a calibrator to the target source <a class="footnote-reference" href="#f17" id="id21">[16]</a><a class="headerlink" href="#gain-transfer-from-a-calibrator-to-the-target-source" title="Permalink to this headline">¶</a></h2>
<p>In order to calibrate a target field without an <em>a priori</em> model, one way forward is to observe a well-known calibrator source, use it to solve for station gains, and apply those to the target field in order to make a first image and begin self-calibrating. There are two tested methods for utilizing calibrator gains in LOFAR observations. Additional methods may become possible later.</p>
<ul class="simple">
<li>Observe a calibrator source before a target observation, using the same frequency settings, with a short time gap between calibrator and target. This is the same approach as is used in traditional radio telescopes and allows using the full bandwidth in the target observation. However, it is not suggested for long target observations, because the calibrator gains may only remain valid for a relatively short time.</li>
<li>Observe a calibrator in parallel with a target observation, using the same frequency settings for both beams. This has the disadvantage that half of the bandwidth is lost in the target observation, but the time variation of the station gains will be available.</li>
</ul>
<p>The recommended approach for dealing with both of these cases is outlined below.</p>
<div class="section" id="the-traditional-approach">
<h3>The “traditional” approach<a class="headerlink" href="#the-traditional-approach" title="Permalink to this headline">¶</a></h3>
<p>When doing calibration transfer in the normal way, i.e. the calibrator and target are observed at different times, some work needs to be done before the gain solutions of the calibrator can be transferred to the target. This is because the calibrator solutions tell the gain error of the instrument at the time the calibrator was observed, and in principle not of when the target was observed. The implicit assumption of the traditional approach is that the gain solutions are constant in time. The frequencies of the calibrator observation should in principle match those of the target.</p>
<p>The above means that the calibration of the calibrator should lead to only one solution in time. This can be achieved by setting <strong>CellSize.Time</strong> to <strong>0</strong>. After this is done, the validity of this solution should be extended to infinity by using the <strong>export</strong> function of <strong>parmdbm</strong>. Full documentation for that program is available on the <a class="reference external" href="http://www.lofar.org/operations/doku.php?id=public:user_software:documentation:parmdbm">LOFAR wiki</a>.</p>
<p>In order to achieve time independence you should use these settings in the BBS parset <a class="footnote-reference" href="#f18" id="id22">[17]</a></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Strategy</span><span class="o">.</span><span class="n">ChunkSize</span> <span class="o">=</span> <span class="mi">0</span>               <span class="c1"># Load the entire MS in memory</span>
<span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CellSize</span><span class="o">.</span><span class="n">Time</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Solution should be constant in time</span>
<span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Solve</span><span class="o">.</span><span class="n">CellChunkSize</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Export the calibrator solutions so that they can be applied to target field (see the LOFAR wiki for details). For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">parmdbm</span>
<span class="n">Command</span><span class="p">:</span> <span class="nb">open</span> <span class="n">tablename</span><span class="o">=</span><span class="s1">&#39;3c196_1.MS/instrument&#39;</span>
<span class="n">Command</span><span class="p">:</span> <span class="n">export</span> <span class="n">Gain</span><span class="o">*</span> <span class="n">tablename</span><span class="o">=</span><span class="s1">&#39;output.table&#39;</span>
<span class="n">Exported</span> <span class="n">record</span> <span class="k">for</span> <span class="n">parameter</span> <span class="n">Gain</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">Imag</span><span class="p">:</span><span class="n">CS001HBA0</span>
<span class="n">Exported</span> <span class="n">record</span> <span class="k">for</span> <span class="n">parameter</span> <span class="n">Gain</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">Imag</span><span class="p">:</span><span class="n">CS002HBA0</span>
<span class="o">...</span> <span class="n">more</span> <span class="n">of</span> <span class="n">the</span> <span class="n">same</span> <span class="o">...</span>
<span class="n">Exported</span> <span class="n">record</span> <span class="k">for</span> <span class="n">parameter</span> <span class="n">Gain</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">Real</span><span class="p">:</span><span class="n">RS307HBA</span>
<span class="n">Exported</span> <span class="n">record</span> <span class="k">for</span> <span class="n">parameter</span> <span class="n">Gain</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">Real</span><span class="p">:</span><span class="n">RS503HBA</span>
<span class="n">Exported</span> <span class="mi">104</span> <span class="n">parms</span> <span class="n">to</span> <span class="n">output</span><span class="o">.</span><span class="n">table</span>
<span class="n">Command</span><span class="p">:</span> <span class="n">exit</span>
</pre></div>
</div>
<p>An alternative scheme to make the solutions of the calibrator observation time independent is to have a smaller <strong>CellSize.Time</strong>, and afterwards take the median <a class="footnote-reference" href="#f19" id="id23">[18]</a>. This way, time cells where calibration failed do not affect the solutions. To follow this scheme, calibrate the calibrator as you would do normally, for example with <strong>CellSize.Time=5</strong>. To make the solutions time independent, use the tool <strong>parmexportcal.py</strong> (see <strong>parmexportcal –help</strong> or its <a class="reference external" href="http://www.lofar.org/operations/doku.php?id=public:user_software:documentation:parm-export">documentation</a>. For example, if you have calibrated the calibrator and stored the solution in <strong>cal.parmdb</strong>, you can take the median amplitudes as follows</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">parmexportcal</span> <span class="ow">in</span><span class="o">=</span><span class="n">cal</span><span class="o">.</span><span class="n">parmdb</span> <span class="n">out</span><span class="o">=</span><span class="n">cal_timeindependent</span><span class="o">.</span><span class="n">parmdb</span>
</pre></div>
</div>
<p>By default, <strong>parmexportcal</strong> takes the median amplitude, and the last phase. This is because the phase always varies very fast, and taking the median does not make sense. One can also chose not to transfer the phase solution of the calibrator at all, by setting <strong>zerophase</strong> to false in <strong>parmexportcal</strong>.</p>
<p>More advanced schemes for processing calibrator solutions before transferring them to the target can be applied using <a class="reference external" href="./losoto.html">LoSoTo</a>. An example could be flagging the calibrator solution, and then averaging it (instead of taking the median).</p>
<p>To apply the gain solutions to target field, one can use BBS. For the <strong>calibrate-stand-alone</strong> script, use the <strong>–parmdb</strong> option. Use a BBS parset which <em>only</em> includes a <strong>CORRECT</strong> step. Now you should have a calibrated <strong>CORRECTED_DATA</strong> column which can be imaged.</p>
</div>
<div class="section" id="the-lofar-multi-beam-approach">
<h3>The LOFAR multi-beam approach<a class="headerlink" href="#the-lofar-multi-beam-approach" title="Permalink to this headline">¶</a></h3>
<p>Unlike other radio telescopes, LOFAR has the ability to observe in multiple directions at once. We are currently experimenting with transferring station gains from one field (a calibrator) to a target field. So far it seems to work quite well, with limitations described below. The requirements for this technique are:</p>
<ul class="simple">
<li>The calibrator and target beams should be observed simultaneously, with the same subband frequency. Future work may change this requirement (we may be able to interpolate between calibrator subbands), but for now the same frequencies must be observed in both fields.</li>
<li>Any time and/or frequency averaging performed (before these calibration steps) on one field must be done in exactly the same way for the other field.</li>
<li>The calibrator beam should not be too far from the target beam in angular distance. Little guidance is currently available for the definition of “too far”, but it appears that a distance of 10 degrees is fine at <span class="math">\(\nu\,=\,150\)</span> MHz, while 40 degrees (at the same frequency) might well be too far. Future experiments should clarify this limitation.</li>
<li>In HBA, the distance limit is also driven by the flux density of the calibrator, and the attenuation by the tile beam. For a good solution on the calibrator, ensure that the sensitivity is sufficient to provide at least a signal-to-noise ratio of <span class="math">\(2-3\)</span> per visibility. The tile FWHM sizes and station SEFDs are available online.</li>
</ul>
<p>In order to do the calibration, and transfer the resulting gains to the target field, follow these steps:</p>
<ul>
<li><p class="first">Calibrate the calibrator using BBS. The time and frequency resolution of the solutions can be whatever is needed for the best results. Ensure that the beam is enabled.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Model</span><span class="o">.</span><span class="n">Beam</span><span class="o">.</span><span class="n">Enable</span> <span class="o">=</span> <span class="n">T</span>
</pre></div>
</div>
</li>
<li><p class="first">(Optional) Perform some corrections to the calibrator solutions, for example flagging, smoothing or interpolation. This is best done in <a class="reference external" href="./losoto.html">LoSoTo</a>.</p>
</li>
<li><p class="first">Apply the gain solutions to the target field. For the <strong>calibrate</strong> script, use the <strong>–instrument-db</strong> option. For the <strong>calibrate-stand-alone</strong> script, use the <strong>–parmdb</strong> option. Use a BBS parset which <em>only</em> includes a <strong>CORRECT</strong> step. Again, ensure that the beam is enabled. The source list for the <strong>CORRECT</strong> step should be left empty:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Step</span><span class="o">.&lt;</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">Model</span><span class="o">.</span><span class="n">Sources</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</li>
<li><p class="first">Before proceeding with imaging and self-calibration, it may be advisable to flag and copy the newly created <strong>CORRECTED_DATA</strong> column to a new dataset using DPPP.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="post-processing">
<h2>Post-processing<a class="headerlink" href="#post-processing" title="Permalink to this headline">¶</a></h2>
<p>The calibrated data produced by BBS can contain outliers that have to be flagged to produce a decent image. It is recommended to visually inspect the corrected visibilities after calibration. Outliers can be flagged in various ways, for instance using <a class="reference external" href="./aoflagger.html">AOFlagger</a> or <a class="reference external" href="./dppp.html">DPPP</a>.</p>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Bugs should be reported using the <a class="reference external" href="http://support.astron.nl/lofar_issuetracker">LOFAR issue tracker</a>.</li>
<li>If BBS crashes for any reason, be sure to kill all BBS processes (<strong>bbs-controller</strong>, <strong>bbs-reducer</strong>, and <strong>bbs-shared-estimator</strong>) on all of the nodes you were working on before running again.</li>
<li>After calibrating many frequency channels (e.g. for spectral line imaging purposes), the spectral profile could show an artificial sin-like curve. This is due to the fact that BBS applied a single solution to all the input channels. To avoid this, it is important to set the parameter  <strong>Step.&lt;name&gt;.Solve.CellSize.Freq</strong> to a value higher than 0, indicating the number of channels that BBS will try to find a solution for (0 means one solution for all the channels). You can inspect the solutions with <strong>parmdbplot</strong> to judge if this is required.</li>
<li>The <strong>:math:`&lt;`key name:math:`&gt;`*.log</strong> files produced by BBS may provide useful information about what went wrong. Inspect these first when BBS has crashed. The log files from <strong>bbs-reducer</strong> are usually located on the compute nodes.</li>
<li>BBS expects information about the antenna field layout to be present in the MS. The data writer should take care of including this, but in some cases it can fail due to problems during the observation. The program <strong>makebeamtables</strong> can be used to manually add the required information to an existing MS. Documentation is available on the <a class="reference external" href="href{http://www.lofar.org/operations/doku.php?id=public:user_software:documentation:makebeamtables">LOFAR wiki</a>.</li>
</ul>
<div class="section" id="common-problems">
<h3>Common problems<a class="headerlink" href="#common-problems" title="Permalink to this headline">¶</a></h3>
<p>In the following some error messages are reported together with the solution we have found to fix them.</p>
<ol class="arabic">
<li><p class="first">Station is not a LOFAR station:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Station</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">LOFAR</span> <span class="n">station</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">additional</span> <span class="n">information</span> <span class="n">needed</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">the</span> <span class="n">station</span> <span class="n">beam</span> <span class="ow">is</span> <span class="n">missing</span><span class="o">.</span>
</pre></div>
</div>
</li>
</ol>
<p>Solution: Run <strong>makebeamtables</strong> on all subbands to add the information required to compute the station beam model.</p>
<ol class="arabic" start="2">
<li><p class="first">setupsourcedb failed:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">FAIL</span><span class="p">]</span> <span class="n">error</span><span class="p">:</span> <span class="n">setupsourcedb</span> <span class="ow">or</span> <span class="n">remote</span> <span class="n">setupsourcedb</span><span class="o">-</span><span class="n">part</span> <span class="n">process</span><span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="n">failed</span>
</pre></div>
</div>
</li>
</ol>
<p>Solution: Check your source catalog file. You can run <strong>makesourcedb</strong> locally on your catalog file to get a more detailed error message:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">makesourcedb</span> <span class="ow">in</span><span class="o">=&lt;</span><span class="n">catalog</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">=</span><span class="s2">&quot;test.sky&quot;</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;&lt;&quot;</span>
</pre></div>
</div>
<ol class="arabic" start="3">
<li><p class="first">Database failure:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">FAIL</span><span class="p">]</span> <span class="n">error</span><span class="p">:</span> <span class="n">clean</span> <span class="n">database</span> <span class="k">for</span> <span class="n">key</span> <span class="n">default</span> <span class="n">failed</span>
</pre></div>
</div>
</li>
</ol>
<p>Solution: Check if you can reach the database server on <strong>ldb002</strong> and make sure that you created your personal database correctly.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>This section is maintained by <a class="reference external" href="mailto:dijkema&#37;&#52;&#48;astron&#46;nl">Tammo Jan Dijkema</a>). It was originally written by Joris van Zwieten and Reinout van Weeren.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>For calibration with DPPP this is not necessary.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td>Examples of these files can be found at <cite>https://github.com/lofar-astron/LOFAR-Cookbook &lt;https://github.com/lofar-astron/LOFAR-Cookbook&gt;</cite>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[4]</a></td><td>Use DPPP’s <strong>predict</strong> step for this, it is much more efficient.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[5]</a></td><td>This example can be found at <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Cookbook">https://github.com/lofar-astron/LOFAR-Cookbook</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[6]</a></td><td>This example can be found at <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Cookbook">https://github.com/lofar-astron/LOFAR-Cookbook</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[7]</a></td><td>This is important when doing a self calibration. In that case only the CORRECTED_DATA column should be used for imaging, while a next calibration step should go back to take the DATA column as input to refine the calibration.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id12">[8]</a></td><td>This example can be found at <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Cookbook">https://github.com/lofar-astron/LOFAR-Cookbook</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id13">[9]</a></td><td>This source catalog is available at <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Cookbook">https://github.com/lofar-astron/LOFAR-Cookbook</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id14">[10]</a></td><td>Currently, it is not possible to combine multithreading with a global solve or with the <strong>calibrate</strong> script.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id15">[11]</a></td><td>You can copy this file from <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Cookbook">https://github.com/lofar-astron/LOFAR-Cookbook</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id16">[12]</a></td><td>Examples can be found in <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Cookbook">https://github.com/lofar-astron/LOFAR-Cookbook</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id18">[13]</a></td><td>Actually, both scripts use different terminology, <strong>sky-db</strong> in the one is called <strong>sourcedb</strong> in the other. This will be fixed.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id19">[14]</a></td><td>On CEP3, catalog files with up to ca. 10,000 clean components can be processed until the nodes run out of memory.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id20">[15]</a></td><td>Available at the LOFAR-Contributions GitHub repository: <a class="reference external" href="https://github.com/lofar-astron/LOFAR-Contributions">https://github.com/lofar-astron/LOFAR-Contributions</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id21">[16]</a></td><td><a class="reference external" href="mailto:heald&#37;&#52;&#48;csiro&#46;au">George Heald</a> contributed to the writing of this section.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f18" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id22">[17]</a></td><td>Note that these settings would be dangerous for a long observation!</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id23">[18]</a></td><td>This is the calibration scheme that the LOFAR pipelines follow.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f20" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[19]</a></td><td>The effect <strong>Rotation</strong> is stored in the instrument table as <strong>RotationAngle</strong>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f21" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[20]</a></td><td>The effect <strong>FaradayRotation</strong> is stored in the instrument table as <strong>RotationMeasure</strong>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f22" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[21]</a></td><td>The effect <strong>CommonRotation</strong> is stored in the instrument table as <strong>CommonRotationAngle</strong>.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="shapelets.html" class="btn btn-neutral float-right" title="Sky Model Construction Using Shapelets" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="acknowledgements.html" class="btn btn-neutral" title="Acknowledgements" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      Last updated on Jan 08, 2018.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'22.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>
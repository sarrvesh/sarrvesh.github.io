

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>SAGECAL &mdash; LOFAR Imaging Cookbook 22.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="LOFAR Imaging Cookbook 22.0.0 documentation" href="index.html"/>
        <link rel="next" title="The AW Imager" href="awimager.html"/>
        <link rel="prev" title="Sky Model Construction Using Shapelets" href="shapelets.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> LOFAR Imaging Cookbook
          

          
          </a>

          
            
            
              <div class="version">
                22.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Introduction to computing facilities at ASTRON </a></li>
<li class="toctree-l1"><a class="reference internal" href="datainspection.html">Data inspection </a></li>
<li class="toctree-l1"><a class="reference internal" href="aoflagger.html">AOFlagger </a></li>
<li class="toctree-l1"><a class="reference internal" href="dppp.html">The Default Pre-Processing Pipeline (DPPP) </a></li>
<li class="toctree-l1"><a class="reference internal" href="dpppcalibrate.html">Gain calibration with DPPP </a></li>
<li class="toctree-l1"><a class="reference internal" href="losoto.html">LoSoTo: LOFAR Solution Tool </a></li>
<li class="toctree-l1"><a class="reference internal" href="wsclean.html">The WSClean Imager </a></li>
<li class="toctree-l1"><a class="reference internal" href="sourcedetection.html">Source detection and sky model manipulation: PyBDSF and LSMTool </a></li>
<li class="toctree-l1"><a class="reference internal" href="factor.html">Factor: Facet Calibration for LOFAR </a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Useful resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="bbs.html">Calibration with BBS </a></li>
<li class="toctree-l1"><a class="reference internal" href="shapelets.html">Sky Model Construction Using Shapelets </a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">SAGECAL </a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-sagecal">Using SAGECAL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-preparation">Data preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model">Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">SAGECAL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#robustness">Robustness</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simulations">Simulations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#distributed-calibration">Distributed calibration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mpi">MPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initial-setup">Initial setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sagecal-options">SAGECAL options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running">Running</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="awimager.html">The AW Imager </a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Practical examples </a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LOFAR Imaging Cookbook</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>SAGECAL </li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/sagecal.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sagecal">
<h1>SAGECAL <a class="footnote-reference" href="#f1" id="id1">[1]</a><a class="headerlink" href="#sagecal" title="Permalink to this headline">¶</a></h1>
<p>This chapter is a step by step description of the SAGECAL method for self-calibration of LOFAR data. The mathematical framework of the algorithm can be found in Yatawatta et al. 2009 and Kazemi et al. 2011. The contents are applicable to the latest version (0.3.8) of SAGECAL and older versions are obsolete. The latest source code can be obtained from <a class="reference external" href="http://sagecal.sf.net">http://sagecal.sf.net</a>.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The acronym SAGECAL stands for Space Alternating Generalized Expectation Maximization Calibration. The Expectation Maximization is used as a solution to maximum likelihood estimation to reduce the computational cost and speed of convergence. The commonly used Least Squared calibration method involves the inversion of a matrix corresponding to the full set of unknown parameters; where the convergence to a local minimum impels a slow speed of convergence and significant computational cost. The SAGE algorithm, on the other hand, allows to compute a direct estimation of subsets unknown parameters, providing faster convergence and/or reduced computational costs. If K is the number of sources and N are the stations, the computational cost scales as <span class="math">\({\mathcal O} ((KN)^2)\)</span> for the Least Squared, while is <span class="math">\({\mathcal O} (K N^2)\)</span> for the Expectation Maximization.</p>
<p>BBS uses the Least Squared algorithm to solve the Measurement Equation. The maximum number of directions for which solve using directional gains with BBS is currently limited to 5 or 6 directions; this is a consequence of the limited computing power available in CEP2 and CEP3. The typical LOFAR Field customarily requires to solve for a number of directions generally higher than 5 or 6, this is due to the wide field of view (FOV), variable beam pattern and ionospheric errors. SAGECAL has been tested to solve to a maximum of 300 directions (in the GPU EoR cluster not in CEP2 or CEP3) and 512 stations.  The version installed in the CEP clusters is not optimized so that other users can also use the same node while SAGECAL is running; e.g. a total of about 50 directions have been successfully tested in CEP1 cluster.</p>
</div>
<div class="section" id="using-sagecal">
<h2>Using SAGECAL<a class="headerlink" href="#using-sagecal" title="Permalink to this headline">¶</a></h2>
<div class="section" id="data-preparation">
<h3>Data preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline">¶</a></h3>
<p>Before running SAGECAL, you need to take a few precautions. First of all, the data format is the Measurement Set (MS), so no extra conversions are necessary. Averaging in time is not essential, but it is definitely recommended in order to work with smaller datasets (you can average down to e.g. 10 seconds). If data have been already demixed,  this step is not needed. The MS can have more than one channel. Also it is possible to calibrate more than one MS together in SAGECAL. This might be useful to handle situations where the data is very noisy. An interesting note about SAGECAL: If the conventional demixing could not be performed on your data (e.g. if the A-team was too close to the target source) you will be able to successfully remove  the A-team sources using this new algorithm by working on averaged data(!). Another procedure you will need apply to your data before SAGECAL is to  calibrate them in the standard way with BBS, solving for the four G Jones elements as well as for the element beam. After BBS, you will need to flag the outliers using DPPP. You are now ready to start the algorithm.</p>
<p>All the programs related to the SAGECAL can be found in <strong>/opt/cep/sagecal/bin/</strong>  or see <strong>/home/sarod/bin</strong> for the latest build.</p>
</div>
<div class="section" id="model">
<h3>Model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h3>
<p>Make an image of your MS (using casapy or awimager). You can use Duchamp to create a mask for the image. To create a sky model, you can adopt buildsky  for point sources and shapelet_gui in case of extended emission (see <a class="reference external" href="./shapelets.html">Sky model construction using Shapelets</a>). Note that you are free to use any other source finder (like <a class="reference external" href="./sourcedetection.html">PyBDSF</a>) if you feel more confident with it. A new functionality has been implemented to transform the the BBS model into the model format used by SAGECAL. The important is that in the sky model any source name starting with ‘S’ indicates shapelet, ‘D’ a disk, ‘R’ a ring, ‘G’ a Gaussian, while others keys are point sources. In the following, we report a few useful sky models examples:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">## name h m s d m s I Q U V spectral_index RM extent_X(rad) extent_Y(rad)</span>
<span class="c1">## pos_angle(rad) freq0</span>
<span class="n">P1C1</span> <span class="mi">0</span> <span class="mi">12</span> <span class="mf">42.996</span> <span class="mi">85</span> <span class="mi">43</span> <span class="mf">21.514</span> <span class="mf">0.030498</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">-</span><span class="mf">5.713060</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">115039062.0</span>
<span class="n">P5C1</span> <span class="mi">1</span> <span class="mi">18</span> <span class="mf">5.864</span> <span class="mi">85</span> <span class="mi">58</span> <span class="mf">39.755</span> <span class="mf">0.041839</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">-</span><span class="mf">6.672879</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">115039062.0</span>

<span class="c1"># A Gaussian mjor,minor 0.1375,0.0917 deg diameter, pa 43.4772 deg</span>
<span class="n">G0</span>  <span class="mi">5</span> <span class="mi">34</span> <span class="mf">31.75</span> <span class="mi">22</span> <span class="mi">00</span> <span class="mf">52.86</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">0.00</span> <span class="mi">0</span> <span class="mf">0.0012</span>  <span class="mf">0.0008</span> <span class="o">-</span><span class="mf">2.329615801</span> <span class="mf">130.0e6</span>

<span class="c1"># A Disk radius=0.041 deg</span>
<span class="n">D01</span> <span class="mi">23</span> <span class="mi">23</span> <span class="mf">25.67</span> <span class="mi">58</span> <span class="mi">48</span> <span class="mi">58</span> <span class="mi">80</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">0.000715</span> <span class="mf">0.000715</span> <span class="mi">0</span> <span class="mf">130e6</span>

<span class="c1"># A Ring radius=0.031 deg</span>
<span class="n">R01</span> <span class="mi">23</span> <span class="mi">23</span> <span class="mf">25.416</span> <span class="mi">58</span> <span class="mi">48</span> <span class="mi">57</span> <span class="mi">70</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">0.00052</span> <span class="mf">0.00052</span> <span class="mi">0</span> <span class="mf">130e6</span>

<span class="c1"># A shapelet (&#39;S3C61MD.fits.modes&#39; file must be in the current directory)</span>
<span class="n">S3C61MD</span> <span class="mi">2</span> <span class="mi">22</span> <span class="mf">49.796414</span> <span class="mi">86</span> <span class="mi">18</span> <span class="mf">55.913266</span> <span class="mf">0.135</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">-</span><span class="mf">6.6</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mf">0.0</span> <span class="mf">115000000.0</span>
</pre></div>
</div>
<p>Note that it is also possible to have sources with 3rd order spectra (with -F 1 option). Here is such an example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">##  name h m s d m s I Q U V spectral_index0 spectral_index1 spectral_index2</span>
<span class="c1">## RM extent_X(rad) extent_Y(rad) pos_angle(rad) freq0</span>
<span class="n">PJ1C1</span> <span class="mi">18</span> <span class="mi">53</span> <span class="mf">33.616</span> <span class="mi">86</span> <span class="mi">10</span> <span class="mf">19.559</span> <span class="mf">0.008594</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">-</span><span class="mf">5.649676</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">-</span><span class="mf">60.0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">152391463.2</span>
</pre></div>
</div>
<p>But all the sources should have either 1st order or 3rd order spectra, mixing is not allowed.</p>
<p>The number of directions you want to solve for are described in the cluster file. In here, one or more sources corresponding to the patch of the skymodel you need to correct for are combined together as the following example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">## cluster_id chunk_size source1 source2 ...</span>
<span class="mi">0</span> <span class="mi">1</span> <span class="n">P0C1</span> <span class="n">P0C2</span>
<span class="mi">1</span> <span class="mi">3</span> <span class="n">P11C2</span> <span class="n">P11C1</span> <span class="n">P13C1</span>
<span class="mi">2</span> <span class="mi">1</span> <span class="n">P2C1</span> <span class="n">P2C2</span> <span class="n">P2C3</span>
</pre></div>
</div>
<p>Note: comments starting with a ‘#’ are allowed for both sky model and cluster files.</p>
</div>
<div class="section" id="id2">
<h3>SAGECAL<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>SAGECAL will solve for all directions described in the cluster file and will subtract the sources listed in the sky model. Note that if you are not interested in the residual data, putting negative values for <strong>cluster_id</strong> will not subtract the corresponding sources from data. Run SAGECAL as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sagecal</span> <span class="o">-</span><span class="n">d</span> <span class="n">my</span><span class="o">.</span><span class="n">MS</span> <span class="o">-</span><span class="n">s</span> <span class="n">my_skymodel</span> <span class="o">-</span><span class="n">c</span> <span class="n">my_clustering</span> <span class="o">-</span><span class="n">t</span> <span class="mi">120</span> <span class="o">-</span><span class="n">p</span> <span class="n">my_solutions</span>
</pre></div>
</div>
<p>This will read the data from the DATA column of the MS and write the calibrated data to the CORRECTED_DATA column. If these columns are not present, you have to create them first.</p>
<p>If you need to calibrate more than one MS together, first create a text file with all the MS names, line by line. Then run</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sagecal</span> <span class="o">-</span><span class="n">f</span> <span class="n">MS_names</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">s</span> <span class="n">my_skymodel</span> <span class="o">-</span><span class="n">c</span> <span class="n">my_clustering</span> <span class="o">-</span><span class="n">t</span> <span class="mi">120</span> <span class="o">-</span><span class="n">p</span> <span class="n">my_solutions</span>
</pre></div>
</div>
<p>Running sagecal -h will provide the additional options, some of them are:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">F</span> <span class="n">sky</span> <span class="n">model</span> <span class="nb">format</span><span class="p">:</span> <span class="mi">0</span><span class="p">:</span> <span class="n">LSM</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">LSM</span> <span class="k">with</span> <span class="mi">3</span> <span class="n">order</span> <span class="n">spectra</span> <span class="p">:</span> <span class="n">default</span> <span class="mi">0</span>
<span class="o">-</span><span class="n">I</span> <span class="nb">input</span> <span class="n">column</span> <span class="p">(</span><span class="n">DATA</span><span class="o">/</span><span class="n">CORRECTED_DATA</span><span class="p">)</span> <span class="p">:</span> <span class="n">default</span> <span class="n">DATA</span>
<span class="o">-</span><span class="n">O</span> <span class="n">ouput</span> <span class="n">column</span> <span class="p">(</span><span class="n">DATA</span><span class="o">/</span><span class="n">CORRECTED_DATA</span><span class="p">)</span> <span class="p">:</span> <span class="n">default</span> <span class="n">CORRECTED_DATA</span>
<span class="o">-</span><span class="n">e</span> <span class="nb">max</span> <span class="n">EM</span> <span class="n">iterations</span> <span class="p">:</span> <span class="n">default</span> <span class="mi">3</span>
<span class="o">-</span><span class="n">g</span> <span class="nb">max</span> <span class="n">iterations</span>  <span class="p">(</span><span class="n">within</span> <span class="n">single</span> <span class="n">EM</span><span class="p">)</span> <span class="p">:</span> <span class="n">default</span> <span class="mi">2</span>
<span class="o">-</span><span class="n">l</span> <span class="nb">max</span> <span class="n">LBFGS</span> <span class="n">iterations</span> <span class="p">:</span> <span class="n">default</span> <span class="mi">10</span>
<span class="o">-</span><span class="n">m</span> <span class="n">LBFGS</span> <span class="n">memory</span> <span class="n">size</span> <span class="p">:</span> <span class="n">default</span> <span class="mi">7</span>
<span class="o">-</span><span class="n">n</span> <span class="n">no</span> <span class="n">of</span> <span class="n">worker</span> <span class="n">threads</span> <span class="p">:</span> <span class="n">default</span> <span class="mi">6</span>
<span class="o">-</span><span class="n">t</span> <span class="n">tile</span> <span class="n">size</span> <span class="p">:</span> <span class="n">default</span> <span class="mi">120</span>
<span class="o">-</span><span class="n">x</span> <span class="n">exclude</span> <span class="n">baselines</span> <span class="n">length</span> <span class="p">(</span><span class="k">lambda</span><span class="p">)</span> <span class="n">lower</span> <span class="n">than</span> <span class="n">this</span> <span class="ow">in</span> <span class="n">calibration</span> <span class="p">:</span> <span class="n">default</span> <span class="mi">0</span>

<span class="n">Advanced</span> <span class="n">options</span><span class="p">:</span>
<span class="o">-</span><span class="n">k</span> <span class="n">cluster_id</span> <span class="p">:</span> <span class="n">correct</span> <span class="n">residuals</span> <span class="k">with</span> <span class="n">solution</span> <span class="n">of</span> <span class="n">this</span> <span class="n">cluster</span> <span class="p">:</span> <span class="n">default</span> <span class="o">-</span><span class="mi">99999</span>
<span class="o">-</span><span class="n">j</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">2.</span><span class="o">..</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">OSaccel</span><span class="p">,</span> <span class="mi">1</span> <span class="n">no</span> <span class="n">OSaccel</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">OSRLM</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="n">RLM</span><span class="p">:</span>  <span class="mi">4</span><span class="p">:</span> <span class="n">RTR</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="n">RRTR</span><span class="p">:</span> <span class="n">default</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Use a solution interval (e.g. -t 120) that is big enough to get a decent solution and not too big to make the parameters vary too much (about 20 minutes per solution is a reasonable value).</p>
<p>In case of both bright and faint sources in the model, you might need to use different solution intervals for different clusters. In order to do that you need to define the values of the second column of the cluster file in such a way that the cluster with the longest solution interval is 1. While the cluster with shorter solution interval will be equal to n, where n is the number of times the longer solution interval is divided. This means that if -t 120 is used to select 120 timeslots, cluster 0 will find a solution using the full 120 timeslots, while cluster 1 will solve for every 120/3=40 timeslots. The option -k will allow to correct the residuals using the solutions calculated for a specific direction which is defined by the <strong>cluster_id</strong>.  The -k option is analogue to the correct step in BBS. See the simulations section later in this chapter for more detailed use of this.</p>
<p>You are now ready to image  the residual data. Successively, run “restore” (see <a class="reference external" href="./shapelets.html">Sky model construction using Shapelets</a>) on the residual image before updating the sky model and starting another loop of SAGECAL. SAGECAL cycles can be done till you are satisfied by the end product.</p>
</div>
<div class="section" id="robustness">
<h3>Robustness<a class="headerlink" href="#robustness" title="Permalink to this headline">¶</a></h3>
<p>Many have experienced flux loss of weaker background sources after running any form of directional calibration. There is a new algorithm in SAGECAL that minimizes this. To enable this, use -j 2 option while running SAGECAL. The theory can be found in Kazemi and Yatawatta, 2013. Also for best speed and robustness, it is recommended to use -j 5. Also for number of stations greater than 64, -j 5 option is faster and less memory consuming.</p>
</div>
<div class="section" id="simulations">
<h3>Simulations<a class="headerlink" href="#simulations" title="Permalink to this headline">¶</a></h3>
<p>After running SAGECAL, you get solutions for all the directions used in the calibration. Using these solutions, it is possible to correct the data for each direction and make images of that part of the sky. This will in theory enable to image the full field of view with correct solutions applied to each direction. This is a brief description on how to do it. We will use an example to illustrate this. Assume you have run SAGECAL as below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sagecal</span> <span class="o">-</span><span class="n">d</span> <span class="n">my</span><span class="o">.</span><span class="n">MS</span> <span class="o">-</span><span class="n">s</span> <span class="n">my_skymodel</span> <span class="o">-</span><span class="n">c</span> <span class="n">my_clustering</span> <span class="o">-</span><span class="n">t</span> <span class="mi">120</span> <span class="o">-</span><span class="n">p</span> <span class="n">my_solutions</span>
</pre></div>
</div>
<p>Now you have the my_solutions file that contains solutions for all the directions given in my_clustering file. The -a 1 option or -a 2 option enables simulation mode in SAGECAL. If -a 1 is given, the sky model given by my_skymodel and my_clustering is simulated (with gains taken from solutions if -p my_solutions is given) and written to the output data. If -a 2 is given, the model given by my_skymodel and my_clustering is simulated (with the gains if -p my_solutions is given), and then added to the input data (-I option) and written to the output data (-O option).</p>
<p>There is one additional thing you can do while doing a simulation: correction for any particular direction. By using -k cluster_id , you can select any cluster number from the my_clustering file to use as the solutions that are used to correct the data. If the cluster_id specified is not present in the my_clustering file, no corrections will be applied.</p>
<p>Simulating the full sky model back to the data might be too much in some cases. It is also possible to simulate only a subset of clusters back to the data. This is done by specifying a list of clusters to ignore during the simulation, using -z ignore_list option. Here, ignore_list is a text file with the cluster numbers (one per line) to ignore. Note also that even while clusters are ignored, their solutions can still be used to correct the data (so these options are independent from each other).</p>
<p>Thus, by cleverly using the -a, -k and -z options, you can get an image that is fully corrected (using SAGECAL solutions) for all directional errors and moreover, simulations take only a fraction of the time taken for calibration.</p>
</div>
</div>
<div class="section" id="distributed-calibration">
<h2>Distributed calibration<a class="headerlink" href="#distributed-calibration" title="Permalink to this headline">¶</a></h2>
<p>It is possible to use SAGECAL to calibrate a large number of subbands, distributed across many computers. This is done by using OpenMPI and SAGECAL together; see sagecal-mpi -h for further information. Here is a simple example:</p>
<div class="section" id="mpi">
<h3>MPI<a class="headerlink" href="#mpi" title="Permalink to this headline">¶</a></h3>
<p>Using MPI, you can run a program across a network of computers. The basic way to run any program with MPI is</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="n">N</span> <span class="o">-</span><span class="n">hostfile</span> <span class="n">machines</span><span class="o">.</span><span class="n">txt</span> <span class="p">(</span><span class="n">your</span> <span class="n">program</span><span class="p">)</span> <span class="p">(</span><span class="n">program</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>where <strong>-np</strong> gives the number of processes (can be different from the number of computers) and <strong>-hostfile</strong> gives the computer names to use (<strong>machines.txt</strong> includes the computer names to use). Always recommended to use the full path for the program to run. If you are only using one computer, you can skip the hostfile option.</p>
</div>
<div class="section" id="initial-setup">
<h3>Initial setup<a class="headerlink" href="#initial-setup" title="Permalink to this headline">¶</a></h3>
<p>Let’s say there are 10 subbands, <strong>SB1.MS</strong>, <strong>SB2.MS</strong>, to <strong>SB10.MS</strong> in one computer. First you need to create a text file (say <strong>mslist.txt</strong>)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SB1</span><span class="o">.</span><span class="n">MS</span>
<span class="n">SB2</span><span class="o">.</span><span class="n">MS</span>
<span class="o">...</span>
<span class="n">SM10</span><span class="o">.</span><span class="n">MS</span>
</pre></div>
</div>
<p>that includes all the MS names, one per each line. Since we are running on one computer, no need to create a hostfile.</p>
</div>
<div class="section" id="sagecal-options">
<h3>SAGECAL options<a class="headerlink" href="#sagecal-options" title="Permalink to this headline">¶</a></h3>
<p>Apart from the usual command line options used in running stand alone SAGECal, there are a few special options for running it in a disributed way.</p>
<ul class="simple">
<li>The number of ADMM iterations is given by <strong>-A</strong> option.</li>
<li>The type of polynomial in freqyency to use as a regularizer is given by <strong>-Q</strong> option.</li>
<li>The number of freqyency terms in the polynomial is given by <strong>-P</strong> option.</li>
<li>The regularization (penalty) factor is given by the <strong>-r</strong> option.</li>
</ul>
</div>
<div class="section" id="running">
<h3>Running<a class="headerlink" href="#running" title="Permalink to this headline">¶</a></h3>
<p>Since there are 10 subbands, we need to invoke 10+1 SAGECal processes, this is done by selecting <strong>-np 11</strong>. The simplest way to run is</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">11</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sarod</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sagecal</span><span class="o">-</span><span class="n">mpi</span> <span class="o">-</span><span class="n">A</span> <span class="mi">10</span> <span class="o">-</span><span class="n">P</span> <span class="mi">2</span> <span class="o">-</span><span class="n">r</span> <span class="mi">10</span>  <span class="o">-</span><span class="n">s</span> <span class="n">my_skymodel</span> <span class="o">-</span><span class="n">c</span> <span class="n">my_clustering</span> <span class="o">-</span><span class="n">t</span> <span class="mi">120</span> <span class="o">-</span><span class="n">p</span> <span class="n">my_solutions</span>
</pre></div>
</div>
<p>this will calibrate each subband the usual way, but the solutions will be much better because information across the frequency range covered by the subbands is used. Note that almost all options used for standalone SAGECal can still be used here.</p>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><ol class="first upperalpha" start="19">
<li>Yatawatta et al., “Radio interferometric calibration using the SAGE algorithm}”, <strong>IEEE DSP</strong>, Marco Island, FL, Jan. 2009.</li>
</ol>
</li>
<li><ol class="first upperalpha" start="19">
<li>Kazemi and S. Yatawatta et al., “Radio interferometric calibration using the SAGE algorithm”, <strong>MNRAS, 414-2</strong>, 2011.</li>
</ol>
</li>
<li><ol class="first upperalpha" start="19">
<li>Kazemi and S. Yatawatta, “Robust radio interferometric calibration using the T-distribution”, <strong>MNRAS</strong>, 2013.</li>
</ol>
</li>
</ul>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>The authors of this chapter are <a class="reference external" href="mailto:orru&#37;&#52;&#48;astron&#46;nl">Emanuela Orru</a> and <a class="reference external" href="mailto:yatawatta&#37;&#52;&#48;astron&#46;nl">Sarod Yatawatta</a>.</td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="awimager.html" class="btn btn-neutral float-right" title="The AW Imager" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="shapelets.html" class="btn btn-neutral" title="Sky Model Construction Using Shapelets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      Last updated on Jan 08, 2018.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'22.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>